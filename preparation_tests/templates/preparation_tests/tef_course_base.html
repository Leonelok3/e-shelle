{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>E-SHELLE ‚Ä¢ Entra√Ænement TEF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    /* ============================================
       üé® PALETTE OFFICIELLE E-SHELLE
       ============================================ */
    :root {
      --green: #0ea848;
      --green-soft: rgba(14,168,72,.18);
      --orange: #ff7b1a;
      --orange-soft: rgba(255,123,26,.16);

      --bg: #020617;
      --surface: #050816;
      --surface-soft: #070b1b;
      --surface-alt: #0b1120;
      --border: rgba(148,163,184,.28);
      --border-soft: rgba(148,163,184,.18);
      --text: #f9fafb;
      --text-muted: #9ca3af;

      --radius-lg: 22px;
      --radius-md: 14px;
      --shadow-card: 0 20px 55px rgba(0,0,0,.75);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at -10% 0%, rgba(14,168,72,.18), transparent 60%),
        radial-gradient(900px 500px at 110% 0%, rgba(255,123,26,.20), transparent 60%),
        radial-gradient(900px 600px at 50% 120%, rgba(56,189,248,.20), transparent 65%),
        linear-gradient(135deg, #020617, #020617 45%, #030712);
      color: var(--text);
      min-height: 100vh;
    }

    a { color: inherit; text-decoration: none; }
    .muted { color: var(--text-muted); }

    /* ============================================
       üîù HEADER GLOBAL
       ============================================ */
    .shell-header {
      position: sticky;
      top: 0;
      z-index: 40;
      background: linear-gradient(
        180deg,
        rgba(2,6,23,.96),
        rgba(2,6,23,.92),
        rgba(2,6,23,.80)
      );
      backdrop-filter: blur(18px);
      border-bottom: 1px solid rgba(15,23,42,.95);
    }

    .shell-header-inner {
      max-width: 1120px;
      margin: 0 auto;
      padding: 10px 18px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .logo-block {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .esh-logo {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      object-fit: cover;
      box-shadow:
        0 0 0 1px rgba(148,163,184,.45),
        0 14px 35px rgba(0,0,0,.85);
    }

    .esh-subtitle {
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .14em;
      color: var(--text-muted);
    }

    .esh-title {
      font-size: 1rem;
      font-weight: 800;
    }

    /* NAV PILLS (comme les autres pages) */
    .nav-tabs {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .nav-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 7px 14px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.9);
      background: rgba(15,23,42,.9);
      color: var(--text-muted);
      font-size: .9rem;
      font-weight: 600;
      box-shadow: 0 0 0 1px rgba(15,23,42,.8);
      cursor: pointer;
      transition:
        background .18s ease,
        border-color .18s ease,
        box-shadow .18s ease,
        transform .16s ease,
        color .16s ease;
    }
    .nav-pill span.icon { font-size: 1.05rem; }
    .nav-pill:hover:not(.active) {
      border-color: rgba(148,163,184,.6);
      background: rgba(15,23,42,.96);
      transform: translateY(-1px);
      box-shadow: 0 10px 26px rgba(0,0,0,.9);
      color: var(--text);
    }
    .nav-pill.active {
      background: radial-gradient(circle at 0 0, rgba(248,250,252,.18), transparent 55%),
                  linear-gradient(135deg, var(--green), var(--orange));
      border-color: transparent;
      color: #020617;
      box-shadow: 0 12px 30px rgba(0,0,0,.9);
      transform: translateY(-1px);
    }

    @media (max-width: 720px) {
      .shell-header-inner {
        flex-direction: column;
        align-items: flex-start;
      }
      .nav-tabs { width: 100%; }
    }

    /* ============================================
       üß± CONTAINER GLOBAL
       ============================================ */
    .engine-container {
      max-width: 1120px;
      margin: 0 auto;
      padding: 22px 18px 40px;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(260px, 1.1fr);
      gap: 18px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      .engine-container {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .engine-card {
      background:
        radial-gradient(900px 450px at -10% 0%, rgba(14,168,72,.16), transparent 65%),
        radial-gradient(900px 450px at 110% 0%, rgba(255,123,26,.15), transparent 65%),
        var(--surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 18px 18px 20px;
      box-shadow: var(--shadow-card);
      position: relative;
      overflow: hidden;
    }

    .engine-path {
      font-size: .8rem;
      letter-spacing: .12em;
      text-transform: uppercase;
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    .engine-main-title {
      font-size: 1.6rem;
      margin: 0;
      font-weight: 800;
    }

    .highlight {
      background: linear-gradient(135deg, var(--green), var(--orange));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .engine-stats-header {
      margin-top: 14px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      font-size: .9rem;
      color: var(--text-muted);
    }

    .engine-stats-header span strong {
      color: var(--text);
    }

    /* ============================================
       üß© CARD EXERCICE
       ============================================ */
    .engine-q-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      font-size: .9rem;
      margin-bottom: 8px;
      color: var(--text-muted);
    }

    .sep {
      border: none;
      border-top: 1px solid var(--border-soft);
      margin: 12px 0 16px;
    }

    .instruction {
      font-size: .9rem;
      color: var(--text-muted);
      margin-bottom: 10px;
    }

    .engine-text {
      padding: 10px 12px;
      border-radius: var(--radius-md);
      background: var(--surface-soft);
      border: 1px solid var(--border-soft);
      font-size: .9rem;
      line-height: 1.6;
      margin-bottom: 12px;
      white-space: pre-line;
    }

    .engine-question {
      font-size: 1rem;
      margin: 6px 0 12px;
      font-weight: 600;
    }

    .engine-options {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .opt {
      padding: 10px 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: var(--surface-soft);
      cursor: pointer;
      font-size: .9rem;
      transition:
        border-color .15s ease-out,
        background .15s ease-out,
        box-shadow .15s ease-out,
        transform .12s ease-out;
    }

    .opt:hover {
      border-color: var(--green);
      background: var(--green-soft);
      box-shadow: 0 10px 26px rgba(0,0,0,.75);
      transform: translateY(-1px);
    }

    .opt.correct {
      border-color: var(--green);
      background: rgba(34,197,94,.22);
    }

    .opt.wrong {
      border-color: var(--orange);
      background: rgba(127,29,29,.75);
    }

    .opt.disabled {
      pointer-events: none;
      opacity: .88;
    }

    .writing-zone {
      width: 100%;
      min-height: 130px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: var(--surface-soft);
      color: var(--text);
      font-size: .9rem;
      resize: vertical;
      margin-top: 8px;
    }

    .eo-controls {
      margin-top: 12px;
      font-size: .9rem;
    }

    .btn-mic {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      background: rgba(15,23,42,.9);
      color: var(--text-muted);
      cursor: pointer;
      font-size: .85rem;
    }

    .explanation {
      margin-top: 16px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(34,197,94,.45);
      background: rgba(22,163,74,.13);
      font-size: .88rem;
      color: #ecfdf3;
    }

    .hidden { display: none !important; }

    .engine-nav {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-primary,
    .btn-secondary {
      border-radius: 999px;
      padding: 9px 18px;
      font-size: .9rem;
      font-weight: 600;
      border: none;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition:
        transform .12s ease-out,
        box-shadow .15s ease-out,
        background .15s ease-out,
        filter .12s ease-out;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--green), var(--orange));
      color: #020617;
      box-shadow: 0 16px 36px rgba(0,0,0,.9);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      filter: brightness(1.03);
    }

    .btn-secondary {
      background: var(--surface-soft);
      border: 1px solid var(--border-soft);
      color: var(--text-muted);
    }

    .btn-secondary:hover {
      background: var(--surface-alt);
      color: var(--text);
    }

    /* ============================================
       üìö PANNEAU LAT√âRAL
       ============================================ */
    .engine-side {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .side-card {
      background: var(--surface-alt);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      padding: 14px 14px 16px;
      box-shadow: var(--shadow-card);
      font-size: .9rem;
    }

    .side-card h3 {
      margin: 0 0 8px;
      font-size: 1rem;
    }

    .side-card ul {
      margin: 8px 0 0 18px;
      padding: 0;
      color: var(--text-muted);
    }

    .side-card li { margin: 4px 0; }

    /* ============================================
       üéö MODE EXAMEN
       ============================================ */
    .mode-toggle {
      margin-top: 8px;
      font-size: .85rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-muted);
    }

    .mode-toggle input {
      accent-color: var(--green);
    }

    /* ============================================
       üöÄ COCKPIT FLOTTANT
       ============================================ */
    .quick-nav {
      position: fixed;
      right: 20px;
      bottom: 18px;
      z-index: 45;
      background: rgba(15,23,42,.96);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.45);
      box-shadow: 0 18px 40px rgba(0,0,0,.9);
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-width: 260px;
      font-size: .8rem;
    }
    .quick-nav-title {
      font-size:.8rem;
      color:var(--text-muted);
      margin-bottom:2px;
    }
    .quick-nav-row {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .quick-nav-btn {
      flex:1 1 auto;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:4px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--border-soft);
      background:var(--surface-soft);
      font-size:.78rem;
      cursor:pointer;
      text-decoration:none;
      transition:
        background .15s ease,
        transform .1s ease,
        border-color .15s ease;
      color: var(--text-muted);
    }
    .quick-nav-btn span.icon { font-size:.9rem; }
    .quick-nav-btn:hover {
      background:var(--surface-alt);
      border-color:rgba(148,163,184,.7);
      transform:translateY(-1px);
      color: var(--text);
    }

    @media (max-width: 720px) {
      .quick-nav {
        left: 50%;
        transform: translateX(-50%);
        right: auto;
        bottom: 12px;
        max-width: 100%;
      }
    }
  </style>
</head>

<body>

<!-- HEADER GLOBAL -->
<header class="shell-header">
  <div class="shell-header-inner">
    <div class="logo-block">
      <img src="{% static 'logoeshelle.jpg' %}" class="esh-logo" alt="E-SHELLE">
      <div>
        <div class="esh-subtitle">E-SHELLE ‚Ä¢ PR√âPARATION TEF &amp; TCF</div>
        <div class="esh-title">Moteur d‚Äôentra√Ænement intelligent</div>
      </div>
    </div>

    <nav class="nav-tabs" aria-label="Navigation principale">
      <a class="nav-pill" href="{% url 'preparation_tests:french_exams' %}">
        <span class="icon">üè†</span><span>Hub examens</span>
      </a>
      <a class="nav-pill active" href="{% url 'preparation_tests:tef_hub' %}">
        <span class="icon">üá´üá∑</span><span>Hub TEF</span>
      </a>
      <a class="nav-pill" href="{% url 'preparation_tests:tcf_hub' %}">
        <span class="icon">üá´üá∑</span><span>Hub TCF</span>
      </a>
      <a class="nav-pill" href="{% url 'preparation_tests:session_review' %}">
        <span class="icon">üìä</span><span>Mes r√©sultats</span>
      </a>
    </nav>
  </div>
</header>

<!-- CONTENU PRINCIPAL -->
<main class="engine-container">

  <!-- COLONNE GAUCHE : INFOS + EXERCICES -->
  <div>

    <!-- CARD D‚ÄôINFOS G√âN√âRALES -->
    <section class="engine-card">
      <div class="engine-path">
        TEF ‚Ä¢ Session d‚Äôentra√Ænement ‚Äî {{ lesson_type }}
      </div>

      <h1 class="engine-main-title">
        Session ‚Äî <span class="highlight">{{ lesson_type }}</span>
      </h1>

      <p class="muted" style="margin-top: 8px; font-size: .95rem;">
        Tu es dans une session d‚Äôentra√Ænement interactive.
        Lis la consigne, analyse soigneusement, puis choisis ta r√©ponse.
        Objectif : <strong>compr√©hension claire, rapidit√© et pr√©cision</strong>.
      </p>

      <div class="engine-stats-header">
        <span>Exercices : <strong>{{ total_exercises }}</strong></span>
        <span>Score : <strong id="top-score">0</strong></span>
        <span>Temps : <strong id="top-timer">00:00</strong></span>
      </div>

      <label class="mode-toggle">
        <input type="checkbox" id="exam-mode">
        <span>Activer le mode examen (limite de temps + pas de retour en arri√®re sur les QCM)</span>
      </label>
    </section>

    <!-- CARD MOTEUR D‚ÄôEXERCICES -->
    <section class="engine-card" id="exercise-card">

      <div class="engine-q-header">
        <span>Question <span id="q-index">1</span> / {{ total_exercises }}</span>
        <span>Score : <span id="score">0</span></span>
        <span>Temps : <span id="timer">00:00</span></span>
      </div>

      <hr class="sep">

      <div id="instruction" class="instruction">Chargement de la consigne‚Ä¶</div>

      <div id="text-block" class="engine-text hidden"></div>

      <audio id="audio-player" class="hidden" controls style="width:100%; margin-bottom: 10px;"></audio>

      <h3 id="question" class="engine-question">‚Ä¶</h3>

      <div id="options" class="engine-options"></div>

      <textarea id="writing-zone" class="writing-zone hidden"
        placeholder="√âcris ta r√©ponse ici (Expression √©crite)‚Ä¶"></textarea>

      <div id="eo-controls" class="eo-controls hidden">
        <button class="btn-mic" id="eo-record">üéôÔ∏è Commencer l‚Äôenregistrement (simulation)</button>
        <div id="eo-status" class="muted" style="margin-top: 4px;"></div>
      </div>

      <div id="explanation-block" class="explanation hidden"></div>

      <div class="engine-nav">
        <button id="next-btn" class="btn-primary">Question suivante</button>
        <button id="restart-btn" class="btn-secondary">‚Üª Recommencer</button>
      </div>

      <hr class="sep">

      <div class="muted">
        Score total : <span id="score-bottom">0</span> / {{ total_exercises }}
      </div>
    </section>

  </div>

  <!-- COLONNE DROITE : ASTUCES -->
  <aside class="engine-side">
    <section class="side-card">
      <h3>Strat√©gies de r√©ussite</h3>
      <ul>
        <li>Lis d‚Äôabord la consigne et la question.</li>
        <li>Rep√®re les mots-cl√©s (dates, montants, conditions, lieux).</li>
        <li>Ne r√©ponds jamais sur ton intuition : appuie-toi sur le texte / l‚Äôaudio.</li>
        <li>Relis la phrase exacte avant de valider.</li>
      </ul>
    </section>

    <section class="side-card">
      <h3>Erreurs fr√©quentes</h3>
      <ul>
        <li>Confondre ¬´ √† partir de ¬ª et ¬´ jusqu‚Äô√† ¬ª.</li>
        <li>Ignorer les mots comme <em>sauf</em>, <em>uniquement</em>, <em>au moins‚Ä¶</em></li>
        <li>R√©pondre trop vite sans v√©rifier le contexte.</li>
      </ul>
    </section>
  </aside>

</main>

<!-- COCKPIT FLOTTANT -->
<div class="quick-nav">
  <div class="quick-nav-title">Navigation rapide</div>
  <div class="quick-nav-row">
    <a href="{% url 'preparation_tests:tef_hub' %}" class="quick-nav-btn">
      <span class="icon">üèÅ</span><span>FR Hub TEF</span>
    </a>
    <a href="{% url 'preparation_tests:session_review' %}" class="quick-nav-btn">
      <span class="icon">üìä</span><span>Mes r√©sultats</span>
    </a>
  </div>
</div>

<!-- ===============================
     DONN√âES D‚ÄôEXERCICES (JSON)
     =============================== -->
<script>
  const EXERCISES = JSON.parse('{{ exercises_json|escapejs }}');
</script>

<!-- ===============================
     LOGIQUE JS MOTEUR
     =============================== -->
<script>
(function() {
  let index = 0;
  let score = 0;
  let timer = 0;
  let timerInterval = null;
  let answered = false;
  let examMode = false;

  const total = EXERCISES.length || 0;

  const qIndexEl = document.getElementById("q-index");
  const scoreEl = document.getElementById("score");
  const scoreBottomEl = document.getElementById("score-bottom");
  const topScoreEl = document.getElementById("top-score");
  const timerEl = document.getElementById("timer");
  const topTimerEl = document.getElementById("top-timer");
  const instructionEl = document.getElementById("instruction");
  const textBlockEl = document.getElementById("text-block");
  const audioEl = document.getElementById("audio-player");
  const questionEl = document.getElementById("question");
  const optionsEl = document.getElementById("options");
  const explanationEl = document.getElementById("explanation-block");
  const writingZoneEl = document.getElementById("writing-zone");
  const eoControlsEl = document.getElementById("eo-controls");
  const eoStatusEl = document.getElementById("eo-status");
  const nextBtn = document.getElementById("next-btn");
  const restartBtn = document.getElementById("restart-btn");
  const examModeCheckbox = document.getElementById("exam-mode");

  function formatTime(sec) {
    const m = String(Math.floor(sec / 60)).padStart(2, "0");
    const s = String(sec % 60).padStart(2, "0");
    return m + ":" + s;
  }

  function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      timer++;
      const t = formatTime(timer);
      timerEl.textContent = t;
      topTimerEl.textContent = t;
    }, 1000);
  }

  function renderQuestion() {
    if (!EXERCISES || EXERCISES.length === 0) {
      instructionEl.textContent = "Aucun exercice configur√© pour cette le√ßon pour le moment.";
      questionEl.textContent = "";
      textBlockEl.classList.add("hidden");
      optionsEl.innerHTML = "";
      explanationEl.classList.add("hidden");
      return;
    }

    const ex = EXERCISES[index];
    answered = false;

    qIndexEl.textContent = index + 1;
    scoreEl.textContent = score;
    scoreBottomEl.textContent = score;
    topScoreEl.textContent = score;

    instructionEl.textContent = ex.instruction || "Lis attentivement puis choisis la bonne r√©ponse.";

    const text = ex.text || ex.passage || "";
    if (text) {
      textBlockEl.textContent = text;
      textBlockEl.classList.remove("hidden");
    } else {
      textBlockEl.textContent = "";
      textBlockEl.classList.add("hidden");
    }

    if (ex.audio_url) {
      audioEl.src = ex.audio_url;
      audioEl.classList.remove("hidden");
    } else {
      audioEl.classList.add("hidden");
      audioEl.removeAttribute("src");
    }

    questionEl.textContent = ex.question || "";

    optionsEl.innerHTML = "";
    explanationEl.classList.add("hidden");
    explanationEl.textContent = "";

    writingZoneEl.classList.add("hidden");
    eoControlsEl.classList.add("hidden");
    eoStatusEl.textContent = "";

    if (ex.options && Object.keys(ex.options || {}).length > 0) {
      // QCM
      Object.entries(ex.options).forEach(([key, val]) => {
        const div = document.createElement("div");
        div.className = "opt";
        div.dataset.key = key;
        div.textContent = key + ". " + val;
        div.addEventListener("click", function() {
          if (answered) return;
          handleChoice(div, key, ex.correct, ex.explanation || "");
        });
        optionsEl.appendChild(div);
      });
    } else if (ex.type === "ee") {
      // Expression √©crite ouverte
      writingZoneEl.classList.remove("hidden");
      explanationEl.classList.remove("hidden");
      explanationEl.textContent = "R√©dige ta r√©ponse dans la zone ci-dessus, puis passe √† la question suivante.";
    } else if (ex.type === "eo") {
      // Expression orale : simple simulation
      eoControlsEl.classList.remove("hidden");
      eoStatusEl.textContent = "Simulation d‚Äôexpression orale : prends 1‚Äì2 minutes pour r√©pondre √† l‚Äôoral.";
    }
  }

  function handleChoice(element, key, correct, explanation) {
    answered = true;

    const allOptions = optionsEl.querySelectorAll(".opt");
    allOptions.forEach(o => o.classList.add("disabled"));

    if (key === correct) {
      element.classList.add("correct");
      score++;
      scoreEl.textContent = score;
      scoreBottomEl.textContent = score;
      topScoreEl.textContent = score;
    } else {
      element.classList.add("wrong");
      allOptions.forEach(o => {
        const k = o.dataset.key;
        if (k === correct) {
          o.classList.add("correct");
        }
      });
    }

    explanationEl.classList.remove("hidden");
    if (explanation) {
      explanationEl.textContent = explanation;
    } else {
      explanationEl.textContent = key === correct
        ? "Bonne r√©ponse ! Continue sur cette lanc√©e."
        : "Relis bien le texte et rep√®re les mots-cl√©s qui justifient la bonne r√©ponse.";
    }
  }

  nextBtn.addEventListener("click", () => {
    if (!EXERCISES || EXERCISES.length === 0) return;

    const ex = EXERCISES[index];
    const hasOptions = ex.options && Object.keys(ex.options || {}).length > 0;

    if (examMode && hasOptions && !answered) {
      alert("Tu dois choisir une r√©ponse avant de passer √† la question suivante.");
      return;
    }

    if (index < EXERCISES.length - 1) {
      index++;
      renderQuestion();
    } else {
      explanationEl.classList.remove("hidden");
      explanationEl.textContent =
        "Session termin√©e ‚úÖ. Tu peux recommencer la session pour consolider ton niveau.";
    }
  });

  restartBtn.addEventListener("click", () => {
    window.location.reload();
  });

  examModeCheckbox.addEventListener("change", () => {
    examMode = examModeCheckbox.checked;
  });

  const eoRecordBtn = document.getElementById("eo-record");
  if (eoRecordBtn) {
    eoRecordBtn.addEventListener("click", () => {
      eoStatusEl.textContent =
        "üéôÔ∏è Simulation en cours‚Ä¶ imagine que tu parles √† un examinateur pendant 2 minutes.";
    });
  }

  startTimer();
  renderQuestion();
})();
</script>

</body>
</html>
