{% extends "base.html" %}
{% load static %}

{% block title %}
TEF Canada – Compréhension orale
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/pages/tef_co_session.css' %}">
{% endblock %}

{% block content %}
<main class="container-narrow">

  <h1 class="page-title">TEF Canada – Compréhension orale</h1>

  {% for lesson in lessons %}
  <section class="lesson-card" data-lesson>

    <!-- ===== TITRE LEÇON ===== -->
    <h2 class="lesson-title">
      Leçon {{ forloop.counter }} : {{ lesson.title }}
    </h2>

    <!-- ===== PROGRESSION ===== -->
    <div class="lesson-progress">
      <div class="progress-text">
        <span>Score : <strong class="score-current">0</strong> /
        <span class="score-total">{{ lesson.exercises.all|length }}</span></span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill"></div>
      </div>
    </div>

    <!-- ===== BADGE ===== -->
    <div class="lesson-badge badge-running">
      En cours
    </div>

    <!-- ===== CONTENU COURS ===== -->
    <div class="lesson-content">
      {{ lesson.content_html|safe }}
    </div>

    <!-- ===== EXERCICES ===== -->
    <h3 class="exercise-title">Exercices</h3>

    {% for ex in lesson.exercises.all %}
    {% if ex.is_active %}
    <div class="exercise-card" data-exercise data-correct="{{ ex.correct_option }}">

      <h4>{{ ex.title }}</h4>

      {% if ex.instruction %}
      <p class="exercise-instruction">{{ ex.instruction }}</p>
      {% endif %}

      {% if ex.audio %}
      <audio controls class="exercise-audio">
        <source src="{{ ex.audio.url }}" type="audio/mpeg">
        Votre navigateur ne supporte pas l’audio.
      </audio>
      {% endif %}

      <p class="exercise-question">{{ ex.question_text }}</p>

      <!-- ===== OPTIONS ===== -->
      <form class="exercise-form">
        {% if ex.option_a %}
        <label>
          <input type="radio" name="q{{ ex.id }}" value="A">
          A : {{ ex.option_a }}
        </label><br>
        {% endif %}

        {% if ex.option_b %}
        <label>
          <input type="radio" name="q{{ ex.id }}" value="B">
          B : {{ ex.option_b }}
        </label><br>
        {% endif %}

        {% if ex.option_c %}
        <label>
          <input type="radio" name="q{{ ex.id }}" value="C">
          C : {{ ex.option_c }}
        </label><br>
        {% endif %}

        {% if ex.option_d %}
        <label>
          <input type="radio" name="q{{ ex.id }}" value="D">
          D : {{ ex.option_d }}
        </label>
        {% endif %}
      </form>

      <button type="button" class="btn-check">
        Vérifier ma réponse
      </button>

      <div class="exercise-feedback"></div>

      {% if ex.summary %}
      <details class="exercise-summary">
        <summary>Voir la correction</summary>
        <p>{{ ex.summary }}</p>
      </details>
      {% endif %}

    </div>
    {% endif %}
    {% endfor %}

  </section>
  {% empty %}
  <p>Aucune leçon disponible pour le moment.</p>
  {% endfor %}

</main>

<!-- ===== JS SCORE & PROGRESSION ===== -->
<script>
document.querySelectorAll('[data-lesson]').forEach(lesson => {
  const exercises = lesson.querySelectorAll('[data-exercise]');
  const scoreCurrent = lesson.querySelector('.score-current');
  const scoreTotal = parseInt(lesson.querySelector('.score-total').textContent);
  const progressFill = lesson.querySelector('.progress-fill');
  const badge = lesson.querySelector('.lesson-badge');

  let score = 0;
  let answered = 0;

  exercises.forEach(ex => {
    const btn = ex.querySelector('.btn-check');
    const feedback = ex.querySelector('.exercise-feedback');
    const correct = ex.dataset.correct;

    btn.addEventListener('click', () => {
      const selected = ex.querySelector('input[type="radio"]:checked');
      if (!selected || btn.disabled) return;

      answered++;

      if (selected.value === correct) {
        feedback.textContent = "✅ Bonne réponse";
        feedback.style.color = "#22c55e";
        score++;
      } else {
        feedback.textContent = "❌ Mauvaise réponse";
        feedback.style.color = "#ef4444";
      }

      btn.disabled = true;
      scoreCurrent.textContent = score;

      const percent = Math.round((answered / scoreTotal) * 100);
      progressFill.style.width = percent + "%";

      if (percent === 100) {
        badge.textContent = "Leçon terminée ✔";
        badge.classList.remove('badge-running');
        badge.classList.add('badge-done');
      }
    });
  });
});
</script>

{% endblock %}
