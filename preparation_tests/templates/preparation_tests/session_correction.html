{% extends "base.html" %}
{% load static %}

{% block title %}
Corrig√© d√©taill√© | Immigration97
{% endblock %}

{% block meta_description %}
Corrig√© d√©taill√© question par question avec r√©ponses, explications
et recommandations personnalis√©es pour progresser plus vite.
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/pages/preparation_tests.css' %}">
{% endblock %}

{% block content %}

<section class="page page-session-correction">

  <!-- ===== PAGE HEADER ===== -->
  <header class="page-title">
    <h1>
      Corrig√© ‚Äì {{ session.exam.code|upper }}
      {% if session.mode == "mock" %}
        (examen blanc)
      {% elif session.mode == "retry_errors" %}
        (correction cibl√©e)
      {% else %}
        (entra√Ænement)
      {% endif %}
    </h1>

    <p>
      D√©tail question par question avec tes r√©ponses,
      les bonnes r√©ponses et les explications.
    </p>

    {% if session.mode == "retry_errors" %}
      <div class="mode-tag">
        üîÅ Mode correction cibl√©e ‚Äî tu revois uniquement tes erreurs.
      </div>
    {% endif %}
  </header>

  <!-- ===== GRID ===== -->
  <section class="grid-main">

    <!-- ========== COLONNE GAUCHE ========== -->
    <article class="card">

      <!-- SCORE GLOBAL -->
      <div class="score-header">
        <div class="score-global-block">
          <div class="score-circle">
            <div class="score-circle-inner">
              {{ global_pct }}%
            </div>
          </div>

          <div class="score-global-text">
            <strong>{{ global_correct }}</strong> bonnes r√©ponses sur
            <strong>{{ global_total }}</strong>

            <div class="score-summary-tags">
              <span class="pill">Examen : {{ session.exam.name }}</span>
              <span class="pill">
                Mode :
                {% if session.mode == "mock" %}Examen blanc
                {% elif session.mode == "retry_errors" %}Correction cibl√©e
                {% else %}Entra√Ænement{% endif %}
              </span>
            </div>
          </div>
        </div>

        <div class="back-links">
          <a href="{% url 'preparation_tests:session_result' session.id %}">
            ‚¨Ö R√©sum√© de la session
          </a>
          <a href="{% url 'preparation_tests:retry_session_errors' session.id %}">
            üîÅ Refaire mes erreurs
          </a>
        </div>
      </div>

      <!-- FILTRES -->
      <div class="filter-bar">
        <div class="filter-group">
          <span class="filter-label">R√©sultat :</span>
          <button class="filter-chip active" data-filter-type="result" data-filter-value="all">Toutes</button>
          <button class="filter-chip" data-filter-type="result" data-filter-value="errors">Erreurs</button>
          <button class="filter-chip" data-filter-type="result" data-filter-value="correct">R√©ussies</button>
        </div>

        <div class="filter-group">
          <span class="filter-label">Section :</span>
          <button class="filter-chip active" data-filter-type="section" data-filter-value="all">Toutes</button>
          {% for sec in sections %}
            <button class="filter-chip" data-filter-type="section" data-filter-value="{{ sec|upper }}">
              {{ sec|upper }}
            </button>
          {% endfor %}
        </div>
      </div>

      <!-- LISTE DES QUESTIONS -->
      <div class="corrections-list" id="corrections-list">
        {% for c in corrections %}
          <div
            class="q-card {% if c.is_correct %}q-correct{% else %}q-wrong{% endif %}"
            data-correct="{% if c.is_correct %}1{% else %}0{% endif %}"
            data-section="{{ c.section|upper }}"
          >
            <div class="q-header">
              <div class="q-title">
                <span class="q-index-pill">
                  {% if c.is_correct %}‚úÖ{% else %}‚ùå{% endif %}
                  Q{{ forloop.counter }}
                </span>
                <span>{{ c.question.section.code|upper }}</span>
              </div>
            </div>

            <div class="q-body">
              <p class="q-stem">{{ c.question.stem }}</p>

              <div class="answer-line user {% if c.is_correct %}ok{% else %}ko{% endif %}">
                <span class="label">Ta r√©ponse :</span>
                <span>{{ c.user_answer }}</span>
              </div>

              {% if c.correct_answer %}
                <div class="answer-line correct">
                  <span class="label">Bonne r√©ponse :</span>
                  <span>{{ c.correct_answer }}</span>
                </div>
              {% endif %}

              {% if c.explanation %}
                <div class="exp-block">
                  <strong>üí° Explication</strong><br>
                  {{ c.explanation }}
                </div>
              {% endif %}

              {% if c.audio_url %}
                <div class="audio-block">
                  <audio controls src="{{ c.audio_url }}"></audio>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- ACTIONS -->
      <div class="btn-row">
        <a class="btn btn-primary"
           href="{% url 'preparation_tests:retry_session_errors' session.id %}">
          üîÅ Correction cibl√©e
        </a>
        <a class="btn btn-ghost"
           href="{% url 'preparation_tests:session_result' session.id %}">
          üìä R√©sum√©
        </a>
      </div>

    </article>

    <!-- ========== COLONNE DROITE ========== -->
    <aside>

      <article class="card side-card">
        <h3>Analyse par section</h3>

        {% for sec_code, data in stats_per_section.items %}
          <div class="section-stat-row">
            <strong>{{ sec_code|upper }}</strong>
            <span>{{ data.correct }} / {{ data.total }} ({{ data.pct }} %)</span>
          </div>
        {% endfor %}
      </article>

      <article class="card side-card">
        <h3>Recommandations</h3>

        {% for rec in recommendations %}
          <div class="recommend-block">
            <strong>{{ rec.section }}</strong><br>
            {{ rec.suggestion }}
            {% if rec.link %}
              <br><a href="{{ rec.link }}">üëâ Voir le cours</a>
            {% endif %}
          </div>
        {% endfor %}
      </article>

    </aside>

  </section>

</section>

{% endblock %}

{% block scripts %}
<script src="{% static 'js/preparation_tests/correction_filters.js' %}"></script>
{% endblock %}
