{% extends "base.html" %}
{% load static %}

{% block title %}
{{ lesson.title }} ‚Äì {{ lesson.exam.code|upper }} {{ section|upper }}
{% endblock %}

{% block content %}
<main class="lesson-session">

  <!-- ========================= -->
  <!-- üéì HERO LE√áON -->
  <!-- ========================= -->
  <section class="lesson-hero">
    <h1 class="lesson-title">{{ lesson.title }}</h1>
    {% include "preparation_tests/partials/_cefr_bar.html" %}

    <p class="lesson-meta">
      Examen : {{ lesson.exam.code|upper }} ‚Ä¢
      Section : {{ section|upper }} ‚Ä¢
      Niveau : {{ lesson.level }}
    </p>
  </section>

  <!-- ========================= -->
  <!-- üß≠ NAVIGATION PARCOURS -->
  <!-- ========================= -->
  {% include "preparation_tests/partials/_prep_nav.html" %}

  <!-- ========================= -->
  <!-- üìò CONTENU DE LA LE√áON -->
  <!-- ========================= -->
  <section class="lesson-body">
    {{ lesson.content_html|safe }}
  </section>

  <div class="lesson-divider"></div>

  <!-- ========================= -->
  <!-- üéß EXERCICES -->
  <!-- ========================= -->
  <section class="lesson-exercises">
    <h2 class="exercises-title">üéß Exercices d'application</h2>

    {% for exercise in exercises %}
      <article class="exercise-card">

        <header class="exercise-header">
          <h3>Exercice {{ forloop.counter }}</h3>

          {% if exercise.instruction %}
            <p class="exercise-instruction">
              {{ exercise.instruction }}
            </p>
          {% endif %}
        </header>

        <!-- üîä AUDIO -->
        {% if exercise.audio and exercise.audio.file %}
          <div class="audio-box">
            <p class="audio-label">üéß √âcoutez attentivement l'audio</p>

            <audio controls preload="metadata">
              <source src="{{ exercise.audio.file.url }}" type="audio/mpeg">
              <source src="{{ exercise.audio.file.url }}" type="audio/mp3">
              Votre navigateur ne supporte pas l'audio.
            </audio>
          </div>
        {% else %}
          <div class="audio-box audio-box--missing">
            ‚ö†Ô∏è Aucun audio disponible pour cet exercice
          </div>
        {% endif %}

        <!-- ‚ùì QUESTION -->
        <p class="exercise-question">
          {{ exercise.question_text }}
        </p>

        <!-- ‚úÖ FORMULAIRE -->
        <form class="exercise-form" data-correct="{{ exercise.correct_option }}" data-exercise-id="{{ exercise.id }}">

          {% if exercise.option_a %}
          <label class="option" data-value="A">
            <input type="radio" name="q{{ exercise.id }}" value="A">
            <span>A.</span> {{ exercise.option_a }}
          </label>
          {% endif %}

          {% if exercise.option_b %}
          <label class="option" data-value="B">
            <input type="radio" name="q{{ exercise.id }}" value="B">
            <span>B.</span> {{ exercise.option_b }}
          </label>
          {% endif %}

          {% if exercise.option_c %}
          <label class="option" data-value="C">
            <input type="radio" name="q{{ exercise.id }}" value="C">
            <span>C.</span> {{ exercise.option_c }}
          </label>
          {% endif %}

          {% if exercise.option_d %}
          <label class="option" data-value="D">
            <input type="radio" name="q{{ exercise.id }}" value="D">
            <span>D.</span> {{ exercise.option_d }}
          </label>
          {% endif %}

          <button type="button" class="btn-check">
            V√©rifier la r√©ponse
          </button>

          <p class="feedback"></p>
        </form>

      </article>
    {% empty %}
      <p>Aucun exercice disponible pour cette le√ßon.</p>
    {% endfor %}
  </section>

</main>

<!-- ========================= -->
<!-- üß† SCRIPT DE CORRECTION AM√âLIOR√â -->
<!-- ========================= -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Attendre que tout soit charg√©
  console.log('üî• Script de v√©rification charg√©');

  document.querySelectorAll(".btn-check").forEach(btn => {
    btn.addEventListener("click", function(e) {
      e.preventDefault(); // Emp√™cher tout comportement par d√©faut
      
      console.log('‚úÖ Bouton cliqu√©');
      
      const form = this.closest("form");
      const correct = form.dataset.correct.trim().toUpperCase();
      const checked = form.querySelector("input:checked");
      const feedback = form.querySelector(".feedback");
      const allLabels = form.querySelectorAll(".option");

      // R√©initialiser les styles
      allLabels.forEach(label => {
        label.style.backgroundColor = '';
        label.style.border = '';
      });

      // V√©rifier si une r√©ponse est s√©lectionn√©e
      if (!checked) {
        feedback.textContent = "‚ùó Choisis une r√©ponse";
        feedback.style.color = "orange";
        feedback.style.fontWeight = "bold";
        feedback.style.marginTop = "10px";
        return;
      }

      const userAnswer = checked.value.trim().toUpperCase();
      console.log('R√©ponse utilisateur:', userAnswer, 'Correcte:', correct);

      // D√©sactiver tous les inputs apr√®s v√©rification
      form.querySelectorAll("input[type='radio']").forEach(input => {
        input.disabled = true;
      });

      // V√©rifier la r√©ponse
      if (userAnswer === correct) {
        // ‚úÖ BONNE R√âPONSE
        feedback.innerHTML = "‚úÖ Bonne r√©ponse !";
        feedback.style.color = "#22c55e";
        feedback.style.fontWeight = "bold";
        feedback.style.marginTop = "10px";
        
        // Mettre en vert la bonne r√©ponse
        checked.closest('.option').style.backgroundColor = "rgba(34, 197, 94, 0.2)";
        checked.closest('.option').style.border = "2px solid #22c55e";
      } else {
        // ‚ùå MAUVAISE R√âPONSE
        feedback.innerHTML = `‚ùå Mauvaise r√©ponse. R√©ponse correcte : <strong>${correct}</strong>`;
        feedback.style.color = "#ef4444";
        feedback.style.fontWeight = "bold";
        feedback.style.marginTop = "10px";
        
        // Mettre en rouge la mauvaise r√©ponse
        checked.closest('.option').style.backgroundColor = "rgba(239, 68, 68, 0.2)";
        checked.closest('.option').style.border = "2px solid #ef4444";
        
        // Mettre en vert la bonne r√©ponse
        allLabels.forEach(label => {
          if (label.dataset.value === correct) {
            label.style.backgroundColor = "rgba(34, 197, 94, 0.2)";
            label.style.border = "2px solid #22c55e";
          }
        });
      }

      // Cacher le bouton apr√®s v√©rification
      this.style.display = 'none';
    });
  });
});
</script>
{% endblock %}