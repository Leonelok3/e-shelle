{% extends "base.html" %}
{% load static %}

{% block body_class %}preparation-tests{% endblock %}
{% block app_scope %}preparation-tests{% endblock %}

{% block title %}
{{ lesson.title }} ‚Äì {{ display_exam_code|upper }} {{ section|upper }} | Immigration97
{% endblock %}

{% block meta_description %}
Le√ßon {{ section|upper }} ‚Äì {{ display_exam_code|upper }} niveau {{ lesson.level }} :
audio, questions corrig√©es et entra√Ænement progressif CECR avec Immigration97.
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/preparation_tests.css' %}?v=20260226">
{% endblock %}

{% block content %}

<section class="pt-hero pt-hero--lesson">
  <div class="container pt-fade-up">

    <span class="pt-badge">
      {{ display_exam_code|upper }} ¬∑ {{ section|upper }} ¬∑ Niveau {{ lesson.level }}
    </span>

    <h1 class="pt-title">{{ lesson.title }}</h1>

    {# ‚úÖ PROGRESSION LIVE #}
    <div class="pt-progress-wrap" aria-label="Progression de la le√ßon">
      <div class="pt-progress-top">
        <strong class="pt-progress-label">Progression</strong>
        <span class="pt-progress-stats">
          <span id="ptProgressDone">{{ progress_completed }}</span>/<span id="ptProgressTotal">{{ progress_total }}</span>
          ‚Äì <span id="ptProgressPct">{{ progress_percent }}</span>%
        </span>
      </div>

      <div class="pt-progress-bar" role="progressbar"
           aria-valuenow="{{ progress_percent }}"
           aria-valuemin="0"
           aria-valuemax="100">
        <div id="ptProgressFill" class="pt-progress-fill" style="width: {{ progress_percent }}%;"></div>
      </div>

      <p class="pt-progress-hint">
        Valide un exercice correctement pour avancer.
      </p>
    </div>

    {# üíé CTA Premium (conversion) #}
    {% if not is_premium %}
      <div class="pt-card pt-card--premium-cta" style="margin-top:14px;">
        <strong>üîí Mode Premium</strong>
        <p style="margin:6px 0 10px;">
          D√©bloque <b>tous les audios</b>, la progression compl√®te, et l‚Äôacc√®s illimit√© A1 ‚Üí C2 (FR / EN / DE / IT).
        </p>
        <a class="pt-btn-primary" href="{% url 'billing:pricing' %}">
          Passer Premium
        </a>
      </div>
    {% endif %}

    {% include "preparation_tests/partials/_cefr_bar.html" %}

    <p class="pt-lead">
      {% if section == "eo" %}
        Entra√Ænement √† la <strong>prise de parole</strong> guid√© avec
        <strong>retour IA personnalis√©</strong> et correction imm√©diate.
      {% elif section == "ee" %}
        Entra√Ænement √† la <strong>production √©crite</strong> avec
        <strong>correction IA</strong>, analyse des erreurs et version am√©lior√©e.
      {% else %}
        Entra√Ænement guid√© avec <strong>audio</strong>,
        <strong>questions interactives</strong> et
        <strong>correction imm√©diate</strong>.
      {% endif %}
    </p>

  </div>
</section>

<section class="pt-section pt-section--nav">
  <div class="container">
    {% include "preparation_tests/partials/_prep_nav.html" %}
  </div>
</section>

<section class="pt-section">
  <div class="container">
    <div class="pt-grid-layout">

      <div class="pt-main">
        <article class="pt-card pt-card--lesson-content">
          {{ lesson.content_html|safe }}
        </article>
      </div>

      <aside class="pt-side">
        <div class="pt-card pt-card--side">
          <h3>üéØ Objectif p√©dagogique</h3>
          <ul class="pt-side-list">
            <li>Comprendre les consignes</li>
            <li>Identifier les informations cl√©s</li>
            <li>R√©pondre efficacement sous contrainte de temps</li>
          </ul>
        </div>
      </aside>

    </div>
  </div>
</section>

<section class="pt-section pt-section--exercises">
  <div class="container">

    <h2 class="pt-section-title text-center">
      {% if section == "eo" %}üé§ Sujets d‚Äôexpression orale
      {% elif section == "ee" %}‚úçÔ∏è Sujets d‚Äôexpression √©crite
      {% else %}üéß Exercices d‚Äôapplication
      {% endif %}
    </h2>

    <input type="hidden" id="csrf-token" value="{{ csrf_token }}">

    <div class="pt-exercises-grid">

      {% for row in exercises %}
      {% with exercise=row.obj %}

      {# ============================================================ #}
      {# üé§ EO ‚Äî Expression Orale : sujet + enregistreur audio        #}
      {# ============================================================ #}
      {% if section == "eo" %}

      <article class="pt-card pt-card--exercise pt-eo-card"
               data-exercise-id="{{ exercise.id }}">

        <header class="pt-exercise-header">
          <h3>Sujet {{ forloop.counter }}</h3>
        </header>

        <div class="pt-exercise-question">{{ exercise.question_text }}</div>

        {% if exercise.instruction %}
          <div class="pt-exercise-instruction pt-eo-instructions">
            <strong>üìã Consignes :</strong>
            <p>{{ exercise.instruction }}</p>
          </div>
        {% endif %}

        {% if exercise.summary %}
          <div class="pt-eo-expected">
            <strong>üéØ Points √† aborder :</strong>
            <p class="pt-eo-points-hint">{{ exercise.summary }}</p>
          </div>
        {% endif %}

        <div class="pt-recorder" data-exercise-id="{{ exercise.id }}">
          <div class="pt-recorder-controls">
            <button class="pt-record-btn" type="button">
              üé§ Commencer l‚Äôenregistrement
            </button>
            <span class="pt-record-timer"></span>
          </div>
          <audio class="pt-playback" controls style="display:none; width:100%; margin-top:12px;"></audio>
        </div>

        <div class="pt-cta-group" style="margin-top:14px;">
          <button class="pt-submit-eo pt-btn-primary" type="button" disabled>
            üì§ Soumettre pour √©valuation IA
          </button>
        </div>

        <div class="pt-eo-result" style="display:none;"></div>

      </article>

      {# ============================================================ #}
      {# ‚úçÔ∏è EE ‚Äî Expression √âcrite : sujet + zone de r√©daction        #}
      {# ============================================================ #}
      {% elif section == "ee" %}

      <article class="pt-card pt-card--exercise pt-ee-card"
               data-exercise-id="{{ exercise.id }}">

        <header class="pt-exercise-header">
          <h3>Sujet {{ forloop.counter }}</h3>
        </header>

        <div class="pt-exercise-question">{{ exercise.question_text }}</div>

        {% if exercise.instruction %}
          <div class="pt-exercise-instruction pt-ee-instructions">
            <strong>üìã Consignes :</strong>
            <p>{{ exercise.instruction }}</p>
          </div>
        {% endif %}

        <div class="pt-ee-editor">
          <textarea
            class="pt-ee-textarea"
            rows="8"
            placeholder="R√©digez votre r√©ponse ici..."
          ></textarea>
          <div class="pt-word-counter">
            <span class="pt-word-count">0</span> mot(s)
          </div>
        </div>

        <div class="pt-cta-group" style="margin-top:14px;">
          <button class="pt-submit-ee pt-btn-primary" type="button">
            ‚úÖ Soumettre pour correction IA
          </button>
        </div>

        <div class="pt-ee-result" style="display:none;"></div>

      </article>

      {# ============================================================ #}
      {# üéß CO / CE ‚Äî QCM : audio + questions √† choix multiple        #}
      {# ============================================================ #}
      {% else %}

      <article class="pt-card pt-card--exercise">

        <header class="pt-exercise-header">
          <h3>Exercice {{ forloop.counter }}</h3>
          {% if exercise.instruction %}
            <p class="pt-exercise-instruction">{{ exercise.instruction }}</p>
          {% endif %}
        </header>

        {# üîí AUDIO PREMIUM READY #}
        {% if exercise.audio_url %}
          {% if row.can_audio %}
            <div class="pt-audio-box">
              <audio controls preload="metadata" playsinline controlslist="nodownload noplaybackrate">
                <source src="{{ exercise.audio_url }}" type="audio/mpeg">
                Votre navigateur ne supporte pas l‚Äôaudio.
              </audio>
            </div>
          {% else %}
            <div class="pt-audio-box pt-audio-box--missing">
              üîí Audio Premium : <a href="{% url ‚Äòbilling:pricing‚Äô %}">d√©bloquer</a>
              <span style="display:block; opacity:.85; margin-top:4px;">
                Astuce : valide l‚Äôexercice pr√©c√©dent ou passe Premium.
              </span>
            </div>
          {% endif %}
        {% else %}
          <div class="pt-audio-box pt-audio-box--missing">‚ö†Ô∏è Aucun audio disponible pour cet exercice</div>
        {% endif %}

        <p class="pt-exercise-question">{{ exercise.question_text }}</p>

        <form
          class="pt-exercise-form"
          data-correct="{{ exercise.correct_option|upper }}"
          data-exercise-id="{{ exercise.id }}"
          novalidate
        >

          {% if exercise.option_a %}
          <label class="pt-option">
            <input type="radio" name="q{{ exercise.id }}" value="A">
            <span>A.</span> {{ exercise.option_a }}
          </label>
          {% endif %}

          {% if exercise.option_b %}
          <label class="pt-option">
            <input type="radio" name="q{{ exercise.id }}" value="B">
            <span>B.</span> {{ exercise.option_b }}
          </label>
          {% endif %}

          {% if exercise.option_c %}
          <label class="pt-option">
            <input type="radio" name="q{{ exercise.id }}" value="C">
            <span>C.</span> {{ exercise.option_c }}
          </label>
          {% endif %}

          {% if exercise.option_d %}
          <label class="pt-option">
            <input type="radio" name="q{{ exercise.id }}" value="D">
            <span>D.</span> {{ exercise.option_d }}
          </label>
          {% endif %}

          <div class="pt-cta-group">
            <button type="button" class="pt-btn-primary pt-check-answer">
              V√©rifier la r√©ponse
            </button>
          </div>

          <p class="pt-feedback" hidden></p>
        </form>

      </article>

      {% endif %}{# end section branch #}

      {% endwith %}
      {% empty %}
        <p class="pt-empty text-center">Aucun exercice disponible pour cette le√ßon.</p>
      {% endfor %}

    </div>
  </div>
</section>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/preparation_tests.js' %}?v=20260218-premium" defer></script>
{% endblock %}
