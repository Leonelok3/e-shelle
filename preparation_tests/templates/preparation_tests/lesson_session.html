{% extends "base.html" %}
{% load static %}

{% block body_class %}preparation-tests{% endblock %}
{% block app_scope %}preparation-tests{% endblock %}

{% block title %}
{{ lesson.title }} ‚Äì {{ display_exam_code|upper }} {{ section|upper }} | Immigration97
{% endblock %}

{% block meta_description %}
Le√ßon {{ section|upper }} ‚Äì {{ display_exam_code|upper }} niveau {{ lesson.level }} :
audio, questions corrig√©es et entra√Ænement progressif CECR avec Immigration97.
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/preparation_tests.css' %}?v=20260104">
{% endblock %}

{% block content %}

<section class="pt-hero pt-hero--lesson">
  <div class="container pt-fade-up">

    <span class="pt-badge">
      {{ display_exam_code|upper }} ¬∑ {{ section|upper }} ¬∑ Niveau {{ lesson.level }}
    </span>

    <h1 class="pt-title">{{ lesson.title }}</h1>

    {# ‚úÖ PROGRESSION LIVE #}
    <div class="pt-progress-wrap" aria-label="Progression de la le√ßon">
      <div class="pt-progress-top">
        <strong class="pt-progress-label">Progression</strong>
        <span class="pt-progress-stats">
          <span id="ptProgressDone">{{ progress_completed }}</span>/<span id="ptProgressTotal">{{ progress_total }}</span>
          ‚Äì <span id="ptProgressPct">{{ progress_percent }}</span>%
        </span>
      </div>

      <div class="pt-progress-bar" role="progressbar"
           aria-valuenow="{{ progress_percent }}"
           aria-valuemin="0"
           aria-valuemax="100">
        <div id="ptProgressFill" class="pt-progress-fill" style="width: {{ progress_percent }}%;"></div>
      </div>

      <p class="pt-progress-hint">
        Valide un exercice correctement pour avancer.
      </p>
    </div>

    {# üíé CTA Premium (conversion) #}
    {% if not is_premium %}
      <div class="pt-card pt-card--premium-cta" style="margin-top:14px;">
        <strong>üîí Mode Premium</strong>
        <p style="margin:6px 0 10px;">
          D√©bloque <b>tous les audios</b>, la progression compl√®te, et l‚Äôacc√®s illimit√© A1 ‚Üí C2 (FR / EN / DE / IT).
        </p>
        <a class="pt-btn-primary" href="{% url 'billing:pricing' %}">
          Passer Premium
        </a>
      </div>
    {% endif %}

    {% include "preparation_tests/partials/_cefr_bar.html" %}

    <p class="pt-lead">
      Entra√Ænement guid√© avec <strong>audio</strong>,
      <strong>questions interactives</strong> et
      <strong>correction imm√©diate</strong>.
    </p>

  </div>
</section>

<section class="pt-section pt-section--nav">
  <div class="container">
    {% include "preparation_tests/partials/_prep_nav.html" %}
  </div>
</section>

<section class="pt-section">
  <div class="container">
    <div class="pt-grid-layout">

      <div class="pt-main">
        <article class="pt-card pt-card--lesson-content">
          {{ lesson.content_html|safe }}
        </article>
      </div>

      <aside class="pt-side">
        <div class="pt-card pt-card--side">
          <h3>üéØ Objectif p√©dagogique</h3>
          <ul class="pt-side-list">
            <li>Comprendre les consignes</li>
            <li>Identifier les informations cl√©s</li>
            <li>R√©pondre efficacement sous contrainte de temps</li>
          </ul>
        </div>
      </aside>

    </div>
  </div>
</section>

<section class="pt-section pt-section--exercises">
  <div class="container">

    <h2 class="pt-section-title text-center">üéß Exercices d‚Äôapplication</h2>

    <input type="hidden" id="csrf-token" value="{{ csrf_token }}">

    <div class="pt-exercises-grid">

      {% for row in exercises %}
      {% with exercise=row.obj %}
      <article class="pt-card pt-card--exercise">

        <header class="pt-exercise-header">
          <h3>Exercice {{ forloop.counter }}</h3>
          {% if exercise.instruction %}
            <p class="pt-exercise-instruction">{{ exercise.instruction }}</p>
          {% endif %}
        </header>

        {# üîí AUDIO PREMIUM READY #}
        {% if exercise.audio_url %}
          {% if row.can_audio %}
            <div class="pt-audio-box">
              <audio controls preload="metadata" playsinline controlslist="nodownload noplaybackrate">
                <source src="{{ exercise.audio_url }}" type="audio/mpeg">
                Votre navigateur ne supporte pas l‚Äôaudio.
              </audio>
            </div>
          {% else %}
            <div class="pt-audio-box pt-audio-box--missing">
              üîí Audio Premium : <a href="{% url 'billing:pricing' %}">d√©bloquer</a>
              <span style="display:block; opacity:.85; margin-top:4px;">
                Astuce : valide l‚Äôexercice pr√©c√©dent ou passe Premium.
              </span>
            </div>
          {% endif %}
        {% else %}
          <div class="pt-audio-box pt-audio-box--missing">‚ö†Ô∏è Aucun audio disponible pour cet exercice</div>
        {% endif %}

        <p class="pt-exercise-question">{{ exercise.question_text }}</p>

        <form
          class="pt-exercise-form"
          data-correct="{{ exercise.correct_option|upper }}"
          data-exercise-id="{{ exercise.id }}"
          novalidate
        >

          {% if exercise.option_a %}
          <label class="pt-option">
            <input type="radio" name="q{{ exercise.id }}" value="A">
            <span>A.</span> {{ exercise.option_a }}
          </label>
          {% endif %}

          {% if exercise.option_b %}
          <label class="pt-option">
            <input type="radio" name="q{{ exercise.id }}" value="B">
            <span>B.</span> {{ exercise.option_b }}
          </label>
          {% endif %}

          {% if exercise.option_c %}
          <label class="pt-option">
            <input type="radio" name="q{{ exercise.id }}" value="C">
            <span>C.</span> {{ exercise.option_c }}
          </label>
          {% endif %}

          {% if exercise.option_d %}
          <label class="pt-option">
            <input type="radio" name="q{{ exercise.id }}" value="D">
            <span>D.</span> {{ exercise.option_d }}
          </label>
          {% endif %}

          <div class="pt-cta-group">
            <button type="button" class="pt-btn-primary pt-check-answer">
              V√©rifier la r√©ponse
            </button>
          </div>

          <p class="pt-feedback" hidden></p>
        </form>

      </article>
      {% endwith %}
      {% empty %}
        <p class="pt-empty text-center">Aucun exercice disponible pour cette le√ßon.</p>
      {% endfor %}

    </div>
  </div>
</section>

{% endblock %}

{% block body_end %}
<script src="{% static 'js/preparation_tests.js' %}?v=20260218-premium" defer></script>
{% endblock %}
