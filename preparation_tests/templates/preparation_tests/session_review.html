{% extends "base.html" %}
{% load static %}

{% block title %}
Mes r√©sultats | Immigration97
{% endblock %}

{% block meta_description %}
Tableau de bord des performances TEF et TCF :
scores, progression, statistiques et historique des sessions.
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/pages/preparation_tests.css' %}">
{% endblock %}

{% block content %}

<section class="page page-session-review">

  <!-- ===== TITRE ===== -->
  <header class="page-title">
    <h1>Tableau de bord ‚Äì Tes performances</h1>
    <p>
      Vue globale de tes sessions TEF / TCF : moyenne g√©n√©rale, progression
      et badges. Utilise cette page comme ton centre de contr√¥le.
    </p>
  </header>

  <!-- ===== DASHBOARD ===== -->
  <section class="dashboard-grid">

    <!-- ===== PROFIL GLOBAL ===== -->
    <article class="card">
      <h2>Profil global</h2>
      <p>R√©sum√© de ton niveau g√©n√©ral sur les derniers entra√Ænements.</p>

      <div class="profile-top">
        <div style="display:flex;align-items:center;gap:14px;">
          <div class="score-circle">
            <div class="score-circle-inner">
              {% if global_stats.global_avg %}
                {{ global_stats.global_avg }}%
              {% else %}
                ‚Äì
              {% endif %}
            </div>
          </div>

          <div class="profile-text">
            {% if global_stats.total_sessions %}
              <div>
                <strong>{{ global_stats.total_sessions }}</strong>
                session{% if global_stats.total_sessions > 1 %}s{% endif %}.
              </div>

              {% if global_stats.last_pct %}
                <div>Derni√®re session :
                  <strong>{{ global_stats.last_pct }} %</strong>
                </div>
              {% endif %}

              {% if global_stats.best_pct %}
                <div>Meilleur score :
                  <strong>{{ global_stats.best_pct }} %</strong>
                </div>
              {% endif %}
            {% else %}
              <div>
                Pas encore de session enregistr√©e.
                Lance un entra√Ænement pour voir ton profil.
              </div>
            {% endif %}

            <div class="profile-meta">
              {% if global_stats.global_avg %}
                <span class="pill">Moyenne globale {{ global_stats.global_avg }}%</span>
              {% endif %}
              {% if global_stats.tef_avg %}
                <span class="pill">Moyenne TEF {{ global_stats.tef_avg }}%</span>
              {% endif %}
              {% if global_stats.tcf_avg %}
                <span class="pill">Moyenne TCF {{ global_stats.tcf_avg }}%</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- ===== BARRES TEF / TCF ===== -->
      <div class="exam-bars">
        {% if global_stats.tef_avg %}
          <div class="exam-row">
            <span class="exam-label">TEF</span>
            <div class="exam-bar-track">
              <div class="exam-bar" style="width: {{ global_stats.tef_avg }}%;"></div>
            </div>
            <span class="exam-pct">{{ global_stats.tef_avg }}%</span>
          </div>
        {% endif %}

        {% if global_stats.tcf_avg %}
          <div class="exam-row">
            <span class="exam-label">TCF</span>
            <div class="exam-bar-track">
              <div class="exam-bar" style="width: {{ global_stats.tcf_avg }}%;"></div>
            </div>
            <span class="exam-pct">{{ global_stats.tcf_avg }}%</span>
          </div>
        {% endif %}
      </div>

      <!-- ===== STATS PAR SECTION ===== -->
      {% if section_stats %}
        <div class="section-stats">
          {% for sec in section_stats %}
            <div class="section-row">
              <div class="section-label">
                {% if sec.code|lower == "co" %}üéß CO
                {% elif sec.code|lower == "ce" %}üìñ CE
                {% elif sec.code|lower == "ee" %}‚úçÔ∏è EE
                {% elif sec.code|lower == "eo" %}üó£ EO
                {% else %}üéØ {{ sec.code }}{% endif %}
              </div>
              <div class="section-bar-track">
                <div class="section-bar" style="width: {{ sec.avg_pct }}%;"></div>
              </div>
              <div class="section-pct">{{ sec.avg_pct }}%</div>
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- ===== TIMELINE ===== -->
      {% if timeline %}
        <div class="timeline">
          <div class="timeline-label">Progression des derni√®res sessions</div>
          <div class="timeline-row">
            {% for t in timeline %}
              <div class="timeline-col">
                <div class="timeline-bar-track">
                  {% if t.pct %}
                    <div class="timeline-bar" style="height: {{ t.pct }}%;"></div>
                  {% endif %}
                </div>
                <div class="timeline-date">
                  {{ t.date }}<br>{{ t.exam }}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </article>

    <!-- ===== BADGES ===== -->
    <aside class="card">
      <h2>Badges &amp; objectifs</h2>
      <p>R√©compenses bas√©es sur ta r√©gularit√© et tes scores.</p>

      {% if badges %}
        <div class="badges-grid">
          {% for b in badges %}
            <div class="badge-card">
              <div class="badge-title">
                {% if b.kind == "gold" %}
                  üèÖ {{ b.title }}
                  <span class="badge-chip badge-gold">Elite</span>
                {% elif b.kind == "section" %}
                  üéØ {{ b.title }}
                  <span class="badge-chip badge-section">Section</span>
                {% else %}
                  ‚≠ê {{ b.title }}
                {% endif %}
              </div>
              <div class="badge-desc">{{ b.text }}</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="empty">
          Pas encore de badge d√©bloqu√©.
          Encha√Æne les sessions r√©guli√®res pour progresser.
        </p>
      {% endif %}
    </aside>

  </section>

  <!-- ===== HISTORIQUE ===== -->
  <section class="card">
    <h2>Historique de tes sessions</h2>
    <p>
      Clique sur R√©sultat ou Corrig√© pour revoir une session pass√©e.
    </p>

    <div class="table-wrapper">
      {% if sessions %}
        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Examen</th>
              <th>Mode</th>
              <th>Score</th>
              <th>Questions</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for s in sessions %}
              <tr>
                <td>{{ s.started_at|date:"d/m/Y H:i" }}</td>
                <td><strong>{{ s.exam.code|upper }}</strong></td>
                <td>
                  {% if s.mode == "mock" %}
                    <span class="badge-mock">Examen blanc</span>
                  {% else %}
                    <span class="badge-mode">Entra√Ænement</span>
                  {% endif %}
                </td>
                <td>
                  {% if s.score_pct != None %}
                    <span class="score-pill">
                      {{ s.score_pct }} %
                    </span>
                  {% else %}‚Äì{% endif %}
                </td>
                <td>
                  {% if s.total_items %}
                    {{ s.total_correct }} / {{ s.total_items }}
                  {% else %}‚Äì{% endif %}
                </td>
                <td>
                  <a class="btn-small" href="{% url 'preparation_tests:session_result' s.id %}">
                    üßæ R√©sultat
                  </a>
                  <a class="btn-small" href="{% url 'preparation_tests:session_correction' s.id %}">
                    ‚úÖ Corrig√©
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="empty">
          Aucune session enregistr√©e pour le moment.
        </div>
      {% endif %}
    </div>
  </section>

</section>

{% endblock %}
