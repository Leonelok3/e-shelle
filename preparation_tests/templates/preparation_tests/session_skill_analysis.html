{% extends "base.html" %}
{% load static %}

{% block title %}
Analyse de comp√©tences | Immigration97
{% endblock %}

{% block meta_description %}
Analyse de comp√©tences TEF / TCF : statistiques par section,
par difficult√© et plan de progression personnalis√©.
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/pages/preparation_tests.css' %}">
{% endblock %}

{% block content %}

<section class="page page-skill-analysis">

  <!-- ===== HERO ===== -->
  <header class="hero">
    <div class="hero-kicker">Profil de comp√©tences</div>

    <h1 class="hero-title">
      Ton profil <span>CO ‚Ä¢ CE ‚Ä¢ EE ‚Ä¢ EO</span> en un coup d‚Äô≈ìil
    </h1>

    <p class="hero-sub">
      Vue consolid√©e de ta session :
      forces, faiblesses, types de questions sensibles
      et plan d‚Äôaction concret pour progresser plus vite.
    </p>

    <div class="hero-tags">
      <span class="pill">‚úÖ {{ global_correct }} / {{ global_total }} bonnes r√©ponses</span>
      <span class="pill">üéØ Score global : {{ global_pct }} %</span>
      <span class="pill">üß™ Session #{{ session.id }}</span>
    </div>
  </header>

  <!-- ===== GRILLE PRINCIPALE ===== -->
  <section class="grid-main">

    <!-- ===== COLONNE GAUCHE ===== -->
    <div>

      <!-- === PAR SECTION === -->
      <article class="card">
        <h2>Par section (CO / CE / EE / EO)</h2>
        <p class="lead">
          Visualise ton niveau par comp√©tence.
          Commence toujours par la section la plus faible.
        </p>

        <div class="stats-grid">
          {% for code, data in per_section.items %}
            <div class="stat-block" data-pct="{{ data.pct|default_if_none:'0' }}">
              <div class="stat-header">
                <div class="stat-label">
                  {% if code == "CO" %}CO ‚Ä¢ Compr√©hension orale
                  {% elif code == "CE" %}CE ‚Ä¢ Compr√©hension √©crite
                  {% elif code == "EE" %}EE ‚Ä¢ Expression √©crite
                  {% elif code == "EO" %}EO ‚Ä¢ Expression orale
                  {% else %}Section {{ code }}{% endif %}
                </div>
                <div class="stat-score">{{ data.pct }} %</div>
              </div>

              <div class="stat-sub">
                {{ data.correct }}/{{ data.total }} bonnes r√©ponses ‚Ä¢ {{ data.level }}
              </div>

              <div class="stat-bar">
                <div class="stat-bar-fill"></div>
              </div>
            </div>
          {% empty %}
            <p class="muted">Aucune statistique par section disponible.</p>
          {% endfor %}
        </div>
      </article>

      <!-- === PAR DIFFICULT√â === -->
      <article class="card mt-16">
        <h2>Par difficult√© des questions</h2>
        <p class="lead">
          Analyse ton comportement sur les questions
          <strong>faciles, moyennes et difficiles</strong>.
        </p>

        <div class="stats-grid">
          {% for diff, data in per_diff.items %}
            <div class="stat-block" data-pct="{{ data.pct|default_if_none:'0' }}">
              <div class="stat-header">
                <div class="stat-label">Niveau {{ diff }}</div>
                <div class="stat-score">{{ data.pct }} %</div>
              </div>

              <div class="stat-sub">
                {{ data.correct }}/{{ data.total }} bonnes r√©ponses
              </div>

              <div class="stat-bar">
                <div class="stat-bar-fill"></div>
              </div>
            </div>
          {% empty %}
            <p class="muted">Aucune donn√©e par difficult√© disponible.</p>
          {% endfor %}
        </div>
      </article>

    </div>

    <!-- ===== COLONNE DROITE ===== -->
    <aside>

      <!-- PRIORIT√âS -->
      <article class="card">
        <h2>Priorit√©s de travail</h2>
        <p class="lead">
          Zones √† renforcer en priorit√© pour am√©liorer ton score global.
        </p>

        <ul class="list">
          {% if weak_sections %}
            {% for s in weak_sections %}
              <li>
                Section <strong>{{ s.label }}</strong> ‚Äî {{ s.pct }} %
                {% if forloop.first %}
                  <span class="badge-weak">PRIORIT√â N¬∞1</span>
                {% elif s.pct < 60 %}
                  <span class="badge-weak">√Ä renforcer</span>
                {% endif %}
              </li>
            {% endfor %}
          {% else %}
            <li>Aucune section prioritaire d√©tect√©e.</li>
          {% endif %}
        </ul>
      </article>

      <!-- TYPES SENSIBLES -->
      <article class="card mt-14">
        <h2>Types de questions sensibles</h2>
        <p class="lead">
          Ces formats font souvent chuter la note.
        </p>

        <ul class="list">
          {% if weak_difficulties %}
            {% for d in weak_difficulties %}
              <li>
                Niveau <strong>{{ d.difficulty }}</strong>
                ‚Äî {{ d.pct }} % ({{ d.correct }}/{{ d.total }})
              </li>
            {% endfor %}
          {% else %}
            <li>Aucun type de question critique identifi√©.</li>
          {% endif %}
        </ul>
      </article>

      <!-- PLAN D‚ÄôACTION -->
      <article class="card mt-14">
        <h2>Plan d‚Äôaction concret</h2>
        <p class="lead">
          Applique ce mini-plan pour transformer l‚Äôanalyse en progr√®s r√©el.
        </p>

        <ul class="list">
          <li>1Ô∏è‚É£ Travaille d‚Äôabord la section la plus faible.</li>
          <li>2Ô∏è‚É£ Revois le cours correspondant (TEF / TCF).</li>
          <li>3Ô∏è‚É£ Lance une session cibl√©e courte (10‚Äì15 questions).</li>
          <li>4Ô∏è‚É£ Reviens ici pour mesurer l‚Äôam√©lioration.</li>
        </ul>

        <div class="btn-row">
          {% if session.exam %}
            <a class="btn btn-primary"
               href="{% url 'preparation_tests:start_session' session.exam.code %}">
              üîÅ Nouvelle session
            </a>
          {% endif %}

          <a class="btn btn-ghost"
             href="{% url 'preparation_tests:session_correction' session.id %}">
            üìä Retour au corrig√©
          </a>
        </div>
      </article>

    </aside>

  </section>

</section>

{% endblock %}

{% block scripts_extra %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".stat-block").forEach(function (block) {
      const pct = Math.max(0, Math.min(100, parseFloat(block.dataset.pct || 0)));
      const bar = block.querySelector(".stat-bar-fill");
      if (bar) bar.style.width = pct + "%";
    });
  });
</script>
{% endblock %}
