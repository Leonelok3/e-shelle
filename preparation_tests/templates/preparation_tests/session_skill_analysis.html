{% extends "base.html" %}
{% load static %}

{# ==================================================
   SCOPE STRICT APP
================================================== #}
{% block body_class %}preparation-tests{% endblock %}
{% block app_scope %}preparation-tests{% endblock %}

{# ==================================================
   SEO
================================================== #}
{% block title %}
Analyse de comp√©tences CECR ‚Äì TEF & TCF | Immigration97
{% endblock %}

{% block meta_description %}
Analyse d√©taill√©e des comp√©tences linguistiques (CO, CE, EE, EO) :
scores par section, niveaux CECR, priorit√©s d√©tect√©es
et plan de progression personnalis√© Immigration97.
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/preparation_tests.css' %}?v=20260226">
{% endblock %}

{% block content %}

<!-- ==================================================
HERO ‚Äî ANALYSE IA
================================================== -->
<section class="pt-hero pt-hero--analysis">
  <div class="container pt-fade-up">

    <span class="pt-badge">
      üß† Analyse de comp√©tences
    </span>

    <h1 class="pt-title">
      Ton profil
      <span class="pt-gradient-secondary">CO ¬∑ CE ¬∑ EE ¬∑ EO</span>
    </h1>

    <p class="pt-lead">
      Analyse consolid√©e de ta session :
      forces, faiblesses et leviers concrets
      pour am√©liorer ton score plus rapidement.
    </p>

    <div class="pt-pill-row">
      <span class="pt-pill">
        ‚úÖ {{ global_correct }} / {{ global_total }} bonnes r√©ponses
      </span>
      <span class="pt-pill">
        üéØ Score global {{ global_pct }} %
      </span>
      <span class="pt-pill">
        üß™ Session #{{ session.id }}
      </span>
    </div>

  </div>
</section>

<!-- ==================================================
ANALYSE PAR COMP√âTENCE
================================================== -->
<section class="pt-section">
  <div class="container">

    <article class="pt-card">
      <h2>üìä Analyse par comp√©tence</h2>
      <p class="pt-muted">
        Identifie imm√©diatement les sections √† renforcer en priorit√©.
      </p>

      <div class="pt-stats-grid">

        {% for code, data in per_section.items %}
        <div
          class="pt-stat-block"
          data-pct="{{ data.pct|default_if_none:'0' }}"
        >
          <div class="pt-stat-header">
            <span class="pt-stat-label">
              {% if code == "CO" %}üéß Compr√©hension orale
              {% elif code == "CE" %}üìñ Compr√©hension √©crite
              {% elif code == "EE" %}‚úçÔ∏è Expression √©crite
              {% elif code == "EO" %}üó£ Expression orale
              {% else %}{{ code }}{% endif %}
            </span>
            <strong>{{ data.pct }}%</strong>
          </div>

          <div class="pt-stat-meta">
            {{ data.correct }}/{{ data.total }} bonnes r√©ponses
            ‚Äî Niveau <strong>{{ data.level }}</strong>
          </div>

          <div class="pt-progress-bar">
            <div class="pt-progress-fill"></div>
          </div>
        </div>
        {% empty %}
          <p class="pt-muted">
            Aucune statistique par section disponible.
          </p>
        {% endfor %}

      </div>
    </article>

  </div>
</section>

<!-- ==================================================
ANALYSE PAR DIFFICULT√â
================================================== -->
<section class="pt-section">
  <div class="container">

    <article class="pt-card">
      <h2>‚öñÔ∏è Analyse par difficult√©</h2>
      <p class="pt-muted">
        Comprends ton comportement face aux questions faciles,
        moyennes et difficiles.
      </p>

      <div class="pt-stats-grid">

        {% for diff, data in per_diff.items %}
        <div
          class="pt-stat-block"
          data-pct="{{ data.pct|default_if_none:'0' }}"
        >
          <div class="pt-stat-header">
            <span>Niveau {{ diff }}</span>
            <strong>{{ data.pct }}%</strong>
          </div>

          <div class="pt-stat-meta">
            {{ data.correct }}/{{ data.total }} bonnes r√©ponses
          </div>

          <div class="pt-progress-bar">
            <div class="pt-progress-fill"></div>
          </div>
        </div>
        {% empty %}
          <p class="pt-muted">
            Aucune donn√©e par difficult√© disponible.
          </p>
        {% endfor %}

      </div>
    </article>

  </div>
</section>

<!-- ==================================================
PRIORIT√âS & PLAN D‚ÄôACTION
================================================== -->
<section class="pt-section">
  <div class="container">

    <div class="pt-grid-2">

      <!-- PRIORIT√âS -->
      <article class="pt-card pt-card--priority">
        <h2>üö® Priorit√©s de travail</h2>

        <ul class="pt-list">
          {% if weak_sections %}
            {% for s in weak_sections %}
              <li>
                <strong>{{ s.label }}</strong>
                ‚Äî {{ s.pct }}%
                {% if forloop.first %}
                  <span class="pt-tag pt-tag--danger">
                    Priorit√© n¬∞1
                  </span>
                {% endif %}
              </li>
            {% endfor %}
          {% else %}
            <li>Aucune section critique d√©tect√©e.</li>
          {% endif %}
        </ul>
      </article>

      <!-- PLAN -->
      <article class="pt-card pt-card--action">
        <h2>üéØ Plan d‚Äôaction recommand√©</h2>

        <ul class="pt-list">
          <li>1Ô∏è‚É£ Commence par la section la plus faible</li>
          <li>2Ô∏è‚É£ Revois le cours correspondant</li>
          <li>3Ô∏è‚É£ Lance une session cibl√©e (10‚Äì15 questions)</li>
          <li>4Ô∏è‚É£ Reviens analyser les progr√®s</li>
        </ul>

        <div class="pt-cta-group">
          {% if session.exam %}
          <a
            href="{% url "preparation_tests:start_session" session.exam.code %}"
            class="pt-btn-primary"
          >
            üîÅ Nouvelle session
          </a>
          {% endif %}

          <a
            href="{% url "preparation_tests:session_correction" session.id %}"
            class="pt-btn-ghost"
          >
            Retour au corrig√©
          </a>
        </div>
      </article>

    </div>

  </div>
</section>

{% endblock %}

{% block body_end %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".pt-stat-block").forEach(function (block) {
      const pct = Math.max(0, Math.min(100, parseFloat(block.dataset.pct || 0)));
      const bar = block.querySelector(".pt-progress-fill");
      if (bar) bar.style.width = pct + "%";
    });
  });
</script>
{% endblock %}
