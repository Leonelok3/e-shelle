{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>TEF ‚Äî Expression Orale (EO)</title>
  <meta name="description" content="Entra√Ænement TEF Expression Orale avec simulation d'entretien, enregistrement, transcription et analyse automatique." />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SEO / Social -->
  <meta property="og:title" content="TEF ‚Äî Expression Orale (EO)" />
  <meta property="og:description" content="Simulation d‚Äôentretien TEF, enregistrement audio, transcription et analyse d√©taill√©e de ta performance." />
  <meta property="og:image" content="{% static 'img/tef-eo-cover.jpg' %}" />
  <meta property="og:url" content="https://www.immigration97.com/fr/tef/eo" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="TEF ‚Äî Expression Orale (EO)" />
  <meta name="twitter:description" content="Entra√Ænement complet TEF EO : sujets, relances, enregistrement et feedback chiffr√©." />
  <meta name="twitter:image" content="{% static 'img/tef-eo-cover.jpg' %}" />

  <style>
    :root {
      --grad1: #0f2027;
      --grad2: #203a43;
      --grad3: #2c5364;
      --panel: rgba(255, 255, 255, .06);
      --panel2: rgba(255, 255, 255, .08);
      --stroke: rgba(255, 255, 255, .14);
      --muted: #b9c6d3;
      --accent: #7aa2ff;
      --hot: #a78bfa;
      --ok: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --br: 16px;
      --shadow: 0 10px 30px rgba(0, 0, 0, .4);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, var(--grad1), var(--grad2) 50%, var(--grad3));
      color: #fff;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ====== NAV TOP ====== */
    .nav-top {
      margin-bottom: 20px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .nav-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--panel);
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      transition: all .2s;
      cursor: pointer;
      font-size: 0.95rem;
    }
    .nav-btn:hover {
      background: var(--panel2);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,.3);
    }

    /* ====== HEADER / HERO ====== */
    .header {
      text-align: center;
      padding: 30px 0 20px;
      margin-bottom: 10px;
    }
    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #fff, var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header p {
      color: var(--muted);
      font-size: 1rem;
    }

    /* ====== BLOCS GENERIQUES ====== */
    .section {
      background: linear-gradient(145deg, rgba(255, 255, 255, .08), rgba(255, 255, 255, .04));
      border: 1px solid var(--stroke);
      border-radius: var(--br);
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: var(--shadow);
    }

    .section-title {
      font-size: 1.5rem;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-subtitle {
      color: var(--muted);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    /* ====== COURS COMPLETS (LECONS DB) ====== */
    .lessons-header {
      margin-bottom: 10px;
    }

    .lessons-header-title {
      font-size: 1.4rem;
      font-weight: 700;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .lessons-header-title span.icon {
      font-size: 1.5rem;
    }
    .lessons-header-sub {
      color: var(--muted);
      font-size: 0.9rem;
      margin-top: 4px;
    }

    .lesson-card {
      margin-top: 14px;
      border-radius: var(--br);
      border: 1px solid var(--stroke);
      background: rgba(15,23,42,.92);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .lesson-header {
      padding: 14px 18px 10px;
      border-bottom: 1px solid rgba(148,163,184,.4);
      background: radial-gradient(circle at 0 0, rgba(122,162,255,.25), transparent 55%),
                  linear-gradient(135deg,#020617,#020617);
    }
    .lesson-title-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:4px;
    }
    .lesson-title {
      font-size:1rem;
      font-weight:700;
    }
    .badge-new {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      font-size:.75rem;
      font-weight:700;
      background:linear-gradient(135deg,#22c55e,#4ade80);
      color:#022c22;
    }
    .lesson-meta {
      font-size:.8rem;
      color:var(--muted);
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }

    .lesson-body {
      padding:14px 18px 16px;
      font-size:.93rem;
      line-height:1.7;
    }
    .lesson-body p { margin:6px 0; }
    .lesson-body ul, .lesson-body ol { margin:6px 0 6px 18px; }
    .lesson-body table { width:100%; border-collapse:collapse; margin-top:8px; }
    .lesson-body th, .lesson-body td {
      border:1px solid rgba(148,163,184,.4);
      padding:6px 8px;
      font-size:.9rem;
    }
    .lesson-body th { background:rgba(15,23,42,.95); }

    /* ====== GUIDE COMPLET / CARDS ====== */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 16px;
      margin-top: 10px;
    }

    .card {
      background: rgba(255, 255, 255, .04);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 20px;
      transition: all .2s;
    }
    .card:hover {
      background: rgba(255, 255, 255, .06);
      transform: translateY(-2px);
    }
    .card h3 {
      font-size: 1.1rem;
      margin-bottom: 10px;
      color: var(--accent);
    }
    .card ul {
      list-style: none;
      padding-left: 0;
      font-size:.9rem;
    }
    .card li {
      padding: 5px 0;
      padding-left: 18px;
      position: relative;
    }
    .card li:before {
      content: "‚Üí";
      position: absolute;
      left: 0;
      color: var(--accent);
    }

    .pills {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    .pill {
      display: inline-block;
      background: rgba(122, 162, 255, .15);
      border: 1px solid rgba(122, 162, 255, .3);
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.85rem;
      color: var(--accent);
      font-weight: 500;
    }

    /* ====== SIMULATEUR ====== */
    .simulator {
      background: var(--panel2);
    }

    .topic-box {
      background: rgba(122, 162, 255, .1);
      border: 1px solid rgba(122, 162, 255, .3);
      border-radius: 12px;
      padding: 16px;
      margin: 16px 0 8px;
      font-size: 1.0rem;
    }
    .topic-box.recording {
      border-color: var(--ok);
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%,100% { opacity: 1; }
      50% { opacity: .7; }
    }
    .relance-box {
      color: var(--muted);
      font-style: italic;
      margin-bottom: 8px;
    }
    .timer {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin: 10px 0 16px;
      color: var(--accent);
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 16px 0;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--panel);
      color: #fff;
      font-weight: 600;
      transition: all .2s;
      cursor: pointer;
      font-size: 0.95rem;
      text-decoration:none;
    }
    .btn:hover:not(:disabled) {
      background: var(--panel2);
      transform: translateY(-1px);
    }
    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }
    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--hot));
      border: none;
    }
    .btn-primary:hover:not(:disabled) {
      box-shadow: 0 5px 20px rgba(122, 162, 255, .4);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255, 255, 255, .06);
      font-weight: 600;
      font-size: 0.9rem;
    }

    .audio-player { margin: 16px 0; }
    .audio-player audio { width: 100%; border-radius: 12px; }

    /* ====== ANALYSE ====== */
    .instruction-box {
      background: rgba(245, 158, 11, .1);
      border: 1px solid rgba(245, 158, 11, .3);
      border-radius: 12px;
      padding: 16px;
      margin: 12px 0;
      font-size: 0.9rem;
    }
    .instruction-box strong { color: var(--warn); }

    .textarea {
      width: 100%;
      min-height: 160px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: rgba(255, 255, 255, .06);
      color: #fff;
      padding: 14px;
      font-size: 0.95rem;
      font-family: inherit;
      resize: vertical;
      margin: 12px 0;
    }
    .textarea::placeholder { color: var(--muted); }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin: 20px 0;
    }
    .metric-card {
      background: rgba(255, 255, 255, .06);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }
    .metric-label {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .metric-value {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--accent);
    }
    .metric-unit {
      font-size: 0.85rem;
      color: var(--muted);
      margin-left: 4px;
    }

    .tips-box {
      background: rgba(167, 139, 250, .1);
      border: 1px solid rgba(167, 139, 250, .3);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }
    .tips-box h3 { color: var(--hot); margin-bottom: 12px; }
    .tips-box ul { list-style: none; padding-left: 0; }
    .tips-box li {
      padding: 8px 0;
      padding-left: 24px;
      position: relative;
    }
    .tips-box li:before {
      content: "üí°";
      position: absolute;
      left: 0;
    }

    /* ====== FOOTER ====== */
    .footer-nav {
      text-align: center;
      margin: 30px 0 10px;
    }

    /* ====== LAYOUT EO : 2 COLONNES ====== */
    .eo-main { margin-top: 20px; }

    .eo-layout {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    @media (min-width: 1024px) {
      .eo-layout {
        display: grid;
        grid-template-columns: minmax(0, 1.5fr) minmax(0, 1.1fr);
        align-items: flex-start;
        gap: 20px;
      }
    }

    .eo-lessons { width: 100%; }
    .eo-side   { width: 100%; display:flex; flex-direction:column; gap:20px; }

    /* PRINT */
    @media print {
      body { background:#fff; color:#000; }
      .no-print { display:none !important; }
      .section { box-shadow:none; }
    }

    @media (max-width: 768px) {
      .header h1 { font-size: 1.6rem; }
      .btn-group { flex-direction: column; }
      .btn { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <div class="container">

    <!-- NAV TOP -->
    <div class="nav-top no-print">
      <a class="nav-btn" href="{% url 'preparation_tests:tef_hub' %}">‚¨Ö Retour hub TEF</a>
      <a class="nav-btn" href="{% url 'preparation_tests:exam_list' %}">üìã Tous les examens</a>
    </div>

    <!-- HEADER -->
    <header class="header">
      <h1>üé§ Expression Orale (EO)</h1>
      <p>Entra√Ænement complet avec simulation d'entretien, enregistrement et analyse automatique</p>
    </header>

    <!-- COURS COMPLETS + GUIDE / SIMULATEUR / ANALYSE -->
    <section class="eo-main">

      <!-- Bandeau "Cours complets" -->
      <section class="section lessons-header">
        <div class="lessons-header-title">
          <span class="icon">üìö</span>
          <span>Cours complets ‚Äî Expression Orale</span>
        </div>
        <p class="lessons-header-sub">
          Utilise ces le√ßons comme mini-modules pour travailler la structure O.R.E.C., l‚Äôinteraction et les relances typiques de l‚Äô√©preuve EO du TEF.
        </p>
      </section>

      <div class="eo-layout">
        <!-- COLONNE GAUCHE : LE√áONS (DB) -->
        <div class="eo-lessons">
          {% if lessons %}
            {% for l in lessons %}
              <article class="lesson-card">
                <header class="lesson-header">
                  <div class="lesson-title-row">
                    <h2 class="lesson-title">{{ l.title }}</h2>
                    {% if forloop.first %}
                      <span class="badge-new">Nouveau</span>
                    {% endif %}
                  </div>
                  <div class="lesson-meta">
                    <span>üìÖ Mise √† jour : {{ l.updated_at|date:"d/m/Y √† H:i" }}</span>
                    <span>‚Ä¢</span>
                    <span>Section : Expression orale (TEF)</span>
                  </div>
                </header>
                <div class="lesson-body">
                  {{ l.content_html|safe }}
                </div>
              </article>
            {% endfor %}
          {% else %}
            <article class="lesson-card">
              <header class="lesson-header">
                <div class="lesson-title-row">
                  <h2 class="lesson-title">Le√ßons EO √† venir</h2>
                </div>
                <div class="lesson-meta">
                  <span>üìÖ Les cours d√©taill√©s EO sont en cours de r√©daction.</span>
                </div>
              </header>
              <div class="lesson-body">
                <p>Bient√¥t, tu retrouveras ici&nbsp;:</p>
                <ul>
                  <li>Des mod√®les de r√©ponses EO (pr√©sentation, opinion, interaction).</li>
                  <li>Des scripts d‚Äôexaminateur avec relances typiques.</li>
                  <li>Des transcriptions annot√©es (connecteurs, vocabulaire, corrections).</li>
                </ul>
              </div>
            </article>
          {% endif %}
        </div>

        <!-- COLONNE DROITE : GUIDE + SIMULATEUR + ANALYSE -->
        <div class="eo-side">

          <!-- Petit panneau : comment utiliser les le√ßons -->
          <section class="section">
            <h2 class="section-title">üéØ Comment utiliser ces le√ßons EO ?</h2>
            <p class="section-subtitle">
              Utilise les contenus de gauche comme mod√®les, puis travaille ta production avec le simulateur et l‚Äôanalyse ci-dessous.
            </p>
            <div class="tips-box">
              <ul>
                <li>Lis une le√ßon, puis reformule-la √† l‚Äôoral avec ton propre exemple.</li>
                <li>Enregistre-toi avec le simulateur EO et garde l‚Äôaudio pour comparer.</li>
                <li>Colle la transcription dans la zone d‚Äôanalyse pour voir ta vitesse, ta richesse lexicale et tes connecteurs.</li>
              </ul>
            </div>
          </section>

          <!-- GUIDE COMPLET -->
          <section class="section no-print">
            <h2 class="section-title">üìö Guide complet</h2>
            <p class="section-subtitle">Ma√Ætrise les techniques essentielles pour r√©ussir l'√©preuve d'expression orale</p>

            <div class="grid">
              <div class="card">
                <h3>üéØ D√©roulement de l'√©preuve</h3>
                <ul>
                  <li>Pr√©sentation rapide (nom, activit√©, motivation)</li>
                  <li>Donner ton opinion sur un th√®me quotidien</li>
                  <li>R√©pondre aux relances de l'examinateur</li>
                  <li>Interagir naturellement et demander des clarifications</li>
                </ul>
              </div>

              <div class="card">
                <h3>üß† M√©thode O.R.E.C.</h3>
                <ul>
                  <li><strong>Opinion</strong> : donne ton avis clairement</li>
                  <li><strong>Raison</strong> : explique pourquoi</li>
                  <li><strong>Exemple</strong> : illustre avec un cas concret</li>
                  <li><strong>Conclusion</strong> : r√©sume ta position</li>
                </ul>
                <div class="pills">
                  <span class="pill">√† mon avis</span>
                  <span class="pill">je pense que</span>
                  <span class="pill">par exemple</span>
                  <span class="pill">en conclusion</span>
                </div>
              </div>

              <div class="card">
                <h3>üîó Connecteurs essentiels</h3>
                <ul>
                  <li><strong>Introduction :</strong> d'abord, tout d'abord</li>
                  <li><strong>Ajout :</strong> ensuite, de plus, en outre</li>
                  <li><strong>Opposition :</strong> cependant, en revanche</li>
                  <li><strong>Conclusion :</strong> donc, par cons√©quent</li>
                </ul>
              </div>

              <div class="card">
                <h3>üìù Th√®mes fr√©quents</h3>
                <ul>
                  <li>R√©seaux sociaux et communication</li>
                  <li>T√©l√©travail vs bureau</li>
                  <li>Vie en ville vs campagne</li>
                  <li>Environnement et √©cologie</li>
                  <li>Apprentissage des langues</li>
                </ul>
              </div>
            </div>
          </section>

          <!-- SIMULATEUR -->
          <section class="section simulator">
            <h2 class="section-title">üé¨ Simulation d'entretien</h2>
            <p class="section-subtitle">Entra√Æne-toi dans des conditions r√©elles avec sujets et relances automatiques</p>

            <div class="instruction-box">
              <strong>Comment utiliser :</strong> Clique sur ¬´ Nouveau sujet ¬ª, lis le sujet propos√©, puis clique sur ¬´ Commencer l'enregistrement ¬ª. R√©ponds pendant 2‚Äì3 minutes comme √† l'examen.
            </div>

            <div id="topic" class="topic-box">
              Clique sur ¬´ Nouveau sujet ¬ª pour commencer ton entra√Ænement.
            </div>
            <div id="relance" class="relance-box"></div>

            <div class="timer" id="timer">‚è±Ô∏è 00:00</div>

            <div class="btn-group">
              <button type="button" class="btn btn-primary" id="newTopic">üéØ Nouveau sujet</button>
              <button type="button" class="btn" id="startRec">üéôÔ∏è Commencer l'enregistrement</button>
              <button type="button" class="btn" id="stopRec">‚èπÔ∏è Arr√™ter</button>
              <button type="button" class="btn" id="downloadRec" disabled>üíæ T√©l√©charger l'audio</button>
            </div>

            <div class="audio-player" id="audioBox"></div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px;">
              <span class="badge" id="durBadge">‚è±Ô∏è Dur√©e : 00:00</span>
              <span class="badge" id="pauseBadge">‚è∏Ô∏è Pauses : 0</span>
            </div>
          </section>

          <!-- ANALYSE -->
          <section class="section">
            <h2 class="section-title">üî¨ Analyse et feedback</h2>
            <p class="section-subtitle">Obtiens une analyse d√©taill√©e de ta performance avec des conseils personnalis√©s</p>

            <div class="instruction-box">
              <strong>Deux options :</strong> 1) Utilise la transcription automatique (si ton navigateur la supporte) 2) Colle ton texte manuellement, puis clique sur ¬´ Analyser ma performance ¬ª.
            </div>

            <div class="btn-group">
              <button type="button" class="btn" id="startSTT">üó£Ô∏è D√©marrer la transcription</button>
              <button type="button" class="btn" id="stopSTT">‚èπÔ∏è Arr√™ter transcription</button>
              <span class="badge" id="sttBadge">üìù Transcription : inactive</span>
            </div>

            <textarea id="transcript" class="textarea" placeholder="Ta transcription appara√Ætra ici (ou colle ton texte manuellement)..."></textarea>

            <div class="btn-group">
              <button type="button" class="btn btn-primary" id="analyzeBtn">üîç Analyser ma performance</button>
              <button type="button" class="btn" id="exportPdf">üìÑ Exporter en PDF</button>
            </div>

            <div class="metrics-grid">
              <div class="metric-card">
                <div class="metric-label">Vitesse</div>
                <div class="metric-value" id="wpm">‚Äî</div>
                <div class="metric-unit">mots/min</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Phrases</div>
                <div class="metric-value" id="avgLen">‚Äî</div>
                <div class="metric-unit">mots/phrase</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Richesse</div>
                <div class="metric-value" id="ttr">‚Äî</div>
                <div class="metric-unit">vocabulaire</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Connecteurs</div>
                <div class="metric-value" id="conn">‚Äî</div>
                <div class="metric-unit">utilis√©s</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">H√©sitations</div>
                <div class="metric-value" id="fillers">‚Äî</div>
                <div class="metric-unit">euh/ben‚Ä¶</div>
              </div>
              <div class="metric-card">
                <div class="metric-label">Score estim√©</div>
                <div class="metric-value" id="score">‚Äî</div>
                <div class="metric-unit">/100</div>
              </div>
            </div>

            <div id="tips"></div>
          </section>

        </div><!-- eo-side -->
      </div><!-- eo-layout -->
    </section>

    <!-- FOOTER NAV -->
    <div class="footer-nav no-print">
      <a class="nav-btn" href="{% url 'preparation_tests:tef_hub' %}">‚¨Ö Retour hub TEF</a>
    </div>
  </div>

  <!-- ================== JS ================== -->
  <script>
    // ===== CONFIG =====
    const topics = [
      "Penses-tu qu'il est important d'apprendre plusieurs langues ?",
      "Les r√©seaux sociaux ont-ils plus d'avantages ou d'inconv√©nients ?",
      "Pr√©f√©rerais-tu vivre en ville ou √† la campagne ? Pourquoi ?",
      "Que penses-tu du t√©l√©travail ? Est-ce une bonne chose ?",
      "Comment peut-on prot√©ger l'environnement au quotidien ?",
      "La technologie am√©liore-t-elle nos relations sociales ?",
      "Quel est l'importance du sport dans la vie quotidienne ?",
      "Les voyages enrichissent-ils vraiment notre culture ?"
    ];

    const relances = [
      "Peux-tu donner un exemple concret de ce que tu viens de dire ?",
      "Et dans ton pays, comment √ßa se passe ?",
      "Pourquoi penses-tu cela exactement ?",
      "Tu pourrais d√©velopper cette id√©e un peu plus ?",
      "Et toi personnellement, que fais-tu dans cette situation ?",
      "Y a-t-il des inconv√©nients √† ce que tu proposes ?",
      "Comment vois-tu l'√©volution de ce sujet dans le futur ?"
    ];

    const connectorsList = [
      "d'abord", "tout d'abord", "ensuite", "puis", "cependant", "n√©anmoins",
      "en revanche", "toutefois", "par cons√©quent", "donc", "ainsi",
      "par exemple", "notamment", "en conclusion", "finalement", "de plus",
      "en outre", "d'une part", "d'autre part"
    ];

    const fillersList = ["euh", "bah", "ben", "heu", "genre", "tu vois", "voil√†", "en fait", "bon"];

    // ===== VARIABLES =====
    let timer = null;
    let seconds = 0;
    let pauseCount = 0;
    let longestPause = 0;
    let mediaRecorder, audioChunks = [], analyser, audioCtx, srcNode, micStream;
    let recognition = null;

    const elements = {
      topic: document.getElementById('topic'),
      relance: document.getElementById('relance'),
      timer: document.getElementById('timer'),
      durBadge: document.getElementById('durBadge'),
      pauseBadge: document.getElementById('pauseBadge'),
      audioBox: document.getElementById('audioBox'),
      transcript: document.getElementById('transcript'),
      sttBadge: document.getElementById('sttBadge'),
      wpm: document.getElementById('wpm'),
      avgLen: document.getElementById('avgLen'),
      ttr: document.getElementById('ttr'),
      conn: document.getElementById('conn'),
      fillers: document.getElementById('fillers'),
      score: document.getElementById('score'),
      tips: document.getElementById('tips')
    };

    // ===== TIMER =====
    function startTimer() {
      clearInterval(timer);
      timer = setInterval(() => {
        seconds++;
        updateTimerDisplay();
      }, 1000);
    }
    function stopTimer() { clearInterval(timer); }
    function resetTimer() {
      stopTimer();
      seconds = 0;
      pauseCount = 0;
      longestPause = 0;
      updateTimerDisplay();
      updatePauseBadge();
    }
    function updateTimerDisplay() {
      const m = String(Math.floor(seconds / 60)).padStart(2, '0');
      const s = String(seconds % 60).padStart(2, '0');
      elements.timer.textContent = `‚è±Ô∏è ${m}:${s}`;
      elements.durBadge.textContent = `‚è±Ô∏è Dur√©e : ${m}:${s}`;
    }
    function updatePauseBadge() {
      elements.pauseBadge.textContent = `‚è∏Ô∏è Pauses : ${pauseCount} (max ${(longestPause / 1000).toFixed(1)}s)`;
    }

    // ===== NOUVEAU SUJET =====
    document.getElementById('newTopic').onclick = () => {
      const t = topics[Math.floor(Math.random() * topics.length)];
      const r = relances[Math.floor(Math.random() * relances.length)];
      elements.topic.textContent = 'üí¨ ' + t;
      elements.relance.textContent = 'üîÑ Relance : ' + r;
      resetTimer();
      elements.audioBox.innerHTML = '';
      elements.transcript.value = '';
      clearMetrics();
    };

    // ===== ENREGISTREMENT =====
    document.getElementById('startRec').onclick = async () => {
      try {
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(micStream);
        audioChunks = [];

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = () => {
          const blob = new Blob(audioChunks, { type: 'audio/webm' });
          const url = URL.createObjectURL(blob);
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = url;
          elements.audioBox.innerHTML = '';
          elements.audioBox.appendChild(audio);

          const downloadBtn = document.getElementById('downloadRec');
          downloadBtn.disabled = false;
          downloadBtn.onclick = () => {
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tef_eo_' + Date.now() + '.webm';
            a.click();
          };
          stopTimer();
        };

        mediaRecorder.start();
        startTimer();
        elements.topic.classList.add('recording');
        setupPauseDetection();
      } catch (e) {
        alert("‚ùå Impossible d'acc√©der au microphone : " + e.message);
      }
    };

    document.getElementById('stopRec').onclick = () => {
      if (mediaRecorder && mediaRecorder.state !== 'inactive') {
        mediaRecorder.stop();
        elements.topic.classList.remove('recording');
      }
      if (audioCtx) {
        audioCtx.close();
        analyser = null;
        srcNode = null;
      }
      if (micStream) {
        micStream.getTracks().forEach(t => t.stop());
      }
    };

    function setupPauseDetection() {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      srcNode = audioCtx.createMediaStreamSource(micStream);
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      srcNode.connect(analyser);

      const data = new Uint8Array(analyser.fftSize);
      let silenceMs = 0;
      let lastTs = performance.now();

      (function loop() {
        if (!analyser) return;
        analyser.getByteTimeDomainData(data);

        let sum = 0;
        for (let i = 0; i < data.length; i++) {
          const v = (data[i] - 128) / 128;
          sum += v * v;
        }
        const rms = Math.sqrt(sum / data.length);

        const now = performance.now();
        const dt = now - lastTs;
        lastTs = now;

        const SILENCE_THRESHOLD = 0.02;
        if (rms < SILENCE_THRESHOLD) {
          silenceMs += dt;
        } else {
          if (silenceMs > 600) {
            pauseCount++;
            if (silenceMs > longestPause) longestPause = silenceMs;
            updatePauseBadge();
          }
          silenceMs = 0;
        }
        requestAnimationFrame(loop);
      })();
    }

    // ===== TRANSCRIPTION =====
    document.getElementById('startSTT').onclick = () => {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) {
        alert("‚ùå La transcription automatique n'est pas support√©e par ton navigateur.\n\nUtilise Chrome ou Edge et colle ton texte manuellement.");
        return;
      }

      recognition = new SR();
      recognition.lang = 'fr-FR';
      recognition.interimResults = true;
      recognition.continuous = true;

      recognition.onresult = (e) => {
        let text = '';
        for (let i = e.resultIndex; i < e.results.length; i++) {
          text += e.results[i][0].transcript + ' ';
        }
        elements.transcript.value = (elements.transcript.value + ' ' + text).trim();
      };

      recognition.onstart = () => {
        elements.sttBadge.textContent = '‚úÖ Transcription : active';
        elements.sttBadge.classList.add('active');
      };

      recognition.onend = () => {
        elements.sttBadge.textContent = 'üìù Transcription : inactive';
        elements.sttBadge.classList.remove('active');
      };

      recognition.onerror = (e) => {
        alert('‚ùå Erreur de transcription : ' + e.error);
      };

      recognition.start();
    };

    document.getElementById('stopSTT').onclick = () => {
      if (recognition) {
        try { recognition.stop(); } catch(e){}
      }
    };

    // ===== ANALYSE =====
    document.getElementById('analyzeBtn').onclick = analyzePerformance;

    function analyzePerformance() {
      const txt = (elements.transcript.value || '').replace(/\s+/g, ' ').trim();
      if (!txt) {
        alert("‚ö†Ô∏è Ajoute d'abord une transcription !");
        return null;
      }

      const durSec = seconds || Math.max(1, Math.round((txt.split(' ').length / 130) * 60));
      const words = txt.split(' ').filter(Boolean).length;
      const wpm = Math.round(words / (durSec / 60));

      const sentences = txt.split(/[.!?‚Ä¶]+/).map(s => s.trim()).filter(Boolean);
      const lengths = sentences.map(s => s.split(/\s+/).filter(Boolean).length);
      const avgLen = lengths.length ? (lengths.reduce((a,b) => a + b, 0) / lengths.length) : 0;

      const tokens = txt.toLowerCase().split(/\s+/).filter(Boolean);
      const types = new Set(tokens);
      const ttr = tokens.length ? (types.size / tokens.length) : 0;

      const lower = txt.toLowerCase();
      const connCount = connectorsList.reduce((n,c) => n + (lower.includes(c) ? 1 : 0), 0);
      const fillerCount = fillersList.reduce((n,f) => n + (lower.includes(f) ? 1 : 0), 0);

      let score = 60;

      // Vitesse
      if (wpm >= 110 && wpm <= 160) score += 10;
      else if ((wpm >= 90 && wpm < 110) || (wpm > 160 && wpm <= 180)) score += 5;
      else score -= 5;

      // Longueur phrases
      if (avgLen >= 10 && avgLen <= 22) score += 10;
      else if ((avgLen >= 8 && avgLen < 10) || (avgLen > 22 && avgLen <= 26)) score += 5;
      else score -= 5;

      // Richesse
      if (ttr >= 0.38) score += 8;
      else if (ttr >= 0.3) score += 4;
      else score -= 4;

      // Connecteurs
      if (connCount >= 3) score += 6;
      else if (connCount >= 1) score += 3;
      else score -= 3;

      // Fillers
      if (fillerCount === 0) score += 6;
      else if (fillerCount <= 2) score += 3;
      else score -= 4;

      // Pauses
      if (pauseCount <= 6) score += 4;
      else if (pauseCount <= 12) score += 1;
      else score -= 4;

      score = Math.max(0, Math.min(100, Math.round(score)));

      elements.wpm.textContent = wpm;
      elements.avgLen.textContent = isFinite(avgLen) ? avgLen.toFixed(1) : '‚Äî';
      elements.ttr.textContent = ttr ? ttr.toFixed(2) : '‚Äî';
      elements.conn.textContent = connCount;
      elements.fillers.textContent = fillerCount;
      elements.score.textContent = score;

      generateTips(wpm, avgLen, ttr, connCount, fillerCount, pauseCount);

      return {
        text: txt,
        wpm,
        avgLen,
        ttr,
        connCount,
        fillerCount,
        score,
        seconds: durSec,
        pauseCount,
        longestPause,
        topic: elements.topic.textContent,
        relance: elements.relance.textContent
      };
    }

    function generateTips(wpm, avgLen, ttr, connCount, fillerCount, pauseCount) {
      const tips = [];

      if (wpm < 110) {
        tips.push("‚ö° <strong>Acc√©l√®re un peu</strong> : vise 120‚Äì150 mots/min pour √™tre plus fluide sans te pr√©cipiter.");
      }
      if (wpm > 160) {
        tips.push("üêå <strong>Ralentis l√©g√®rement</strong> : reste entre 120‚Äì150 mots/min pour garder une bonne clart√©.");
      }

      if (connCount < 3) {
        tips.push("üîó <strong>Ajoute des connecteurs</strong> : utilise ¬´ cependant ¬ª, ¬´ en outre ¬ª, ¬´ par cons√©quent ¬ª pour structurer ton discours.");
      }

      if (avgLen < 10) {
        tips.push("üìè <strong>D√©veloppe tes phrases</strong> : ajoute un exemple ou une explication pour atteindre 10‚Äì20 mots par phrase.");
      }
      if (avgLen > 22) {
        tips.push("‚úÇÔ∏è <strong>Simplifie tes phrases</strong> : coupe les phrases trop longues en plusieurs phrases plus courtes.");
      }

      if (ttr < 0.3) {
        tips.push("üìö <strong>Varie ton vocabulaire</strong> : utilise des synonymes et des expressions vari√©es plut√¥t que r√©p√©ter les m√™mes mots.");
      }

      if (fillerCount > 2) {
        tips.push("ü§ê <strong>R√©duis les h√©sitations</strong> : remplace ¬´ euh ¬ª, ¬´ ben ¬ª, ¬´ en fait ¬ª par de courtes pauses silencieuses.");
      }

      if (pauseCount > 12) {
        tips.push("üéØ <strong>Fluidifie ton discours</strong> : pr√©pare un plan mental (O.R.E.C.) avant de parler pour √©viter les pauses longues.");
      }

      if (tips.length === 0) {
        tips.push("üåü <strong>Excellent travail !</strong> Continue √† enrichir ton vocabulaire et √† soigner tes transitions.");
      }

      elements.tips.innerHTML = `
        <div class="tips-box">
          <h3>üí° Conseils personnalis√©s</h3>
          <ul>${tips.map(t => `<li>${t}</li>`).join('')}</ul>
        </div>
      `;
    }

    function clearMetrics() {
      elements.wpm.textContent = '‚Äî';
      elements.avgLen.textContent = '‚Äî';
      elements.ttr.textContent = '‚Äî';
      elements.conn.textContent = '‚Äî';
      elements.fillers.textContent = '‚Äî';
      elements.score.textContent = '‚Äî';
      elements.tips.innerHTML = '';
    }

    // ===== EXPORT PDF =====
    document.getElementById('exportPdf').onclick = () => {
      const data = analyzePerformance();
      if (!data) return;

      const printWindow = window.open('', '_blank', 'width=900,height=700');
      const html = `<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Bilan Expression Orale - TEF</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif; padding:30px; line-height:1.6; }
    .header { border-bottom:3px solid #000; padding-bottom:15px; margin-bottom:25px; }
    h1 { font-size:1.8rem; margin-bottom:5px; }
    .date { color:#666; font-size:.9rem; }
    .section { margin:25px 0; page-break-inside:avoid; }
    .section h2 { font-size:1.3rem; margin-bottom:12px; color:#333; }
    .topic-box { background:#f5f5f5; border-left:4px solid #7aa2ff; padding:15px; margin:10px 0; }
    .grid { display:grid; grid-template-columns:repeat(4,1fr); gap:15px; margin:20px 0; }
    .metric { border:2px solid #000; border-radius:8px; padding:15px; text-align:center; }
    .metric-label { font-size:.85rem; color:#666; margin-bottom:8px; }
    .metric-value { font-size:1.6rem; font-weight:700; color:#000; }
    .metric-unit { font-size:.8rem; color:#666; }
    .transcript-box { border:1px solid #ccc; border-radius:8px; padding:15px; background:#fafafa; white-space:pre-wrap; font-size:.95rem; margin-top:10px; }
    .score-big { text-align:center; font-size:3rem; font-weight:700; color:#7aa2ff; margin:20px 0; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìä Bilan Expression Orale (TEF)</h1>
    <div class="date">${new Date().toLocaleString('fr-FR',{dateStyle:'full',timeStyle:'short'})}</div>
  </div>

  <div class="section">
    <h2>üéØ Sujet trait√©</h2>
    <div class="topic-box">
      <strong>${(data.topic || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</strong><br>
      <em style="color:#666;">${(data.relance || '').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</em>
    </div>
  </div>

  <div class="score-big">Score : ${data.score}/100</div>

  <div class="section">
    <h2>üìà M√©triques d√©taill√©es</h2>
    <div class="grid">
      <div class="metric">
        <div class="metric-label">Vitesse</div>
        <div class="metric-value">${data.wpm}</div>
        <div class="metric-unit">mots/min</div>
      </div>
      <div class="metric">
        <div class="metric-label">Phrases</div>
        <div class="metric-value">${isFinite(data.avgLen) ? data.avgLen.toFixed(1) : '‚Äî'}</div>
        <div class="metric-unit">mots/phrase</div>
      </div>
      <div class="metric">
        <div class="metric-label">Richesse</div>
        <div class="metric-value">${data.ttr.toFixed(2)}</div>
        <div class="metric-unit">vocabulaire</div>
      </div>
      <div class="metric">
        <div class="metric-label">Connecteurs</div>
        <div class="metric-value">${data.connCount}</div>
        <div class="metric-unit">utilis√©s</div>
      </div>
      <div class="metric">
        <div class="metric-label">H√©sitations</div>
        <div class="metric-value">${data.fillerCount}</div>
        <div class="metric-unit">mots</div>
      </div>
      <div class="metric">
        <div class="metric-label">Pauses</div>
        <div class="metric-value">${data.pauseCount}</div>
        <div class="metric-unit">d√©tect√©es</div>
      </div>
      <div class="metric">
        <div class="metric-label">Pause max</div>
        <div class="metric-value">${(data.longestPause/1000).toFixed(1)}</div>
        <div class="metric-unit">secondes</div>
      </div>
      <div class="metric">
        <div class="metric-label">Dur√©e totale</div>
        <div class="metric-value">${String(Math.floor(data.seconds/60)).padStart(2,'0')}:${String(Math.round(data.seconds%60)).padStart(2,'0')}</div>
        <div class="metric-unit">min:sec</div>
      </div>
    </div>
  </div>

  <div class="section">
    <h2>üìù Transcription compl√®te</h2>
    <div class="transcript-box">${(data.text || 'Aucune transcription disponible').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
  </div>

  <script>window.onload = () => setTimeout(() => window.print(), 500);</script>
</body>
</html>`;
      printWindow.document.open();
      printWindow.document.write(html);
      printWindow.document.close();
    };
  </script>
</body>
</html>
