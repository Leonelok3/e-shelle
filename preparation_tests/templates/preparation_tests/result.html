{% extends "base.html" %}
{% load static %}

{# ==================================================
   SCOPE STRICT APP
================================================== #}
{% block body_class %}preparation-tests{% endblock %}
{% block app_scope %}preparation-tests{% endblock %}

{# ==================================================
   SEO â€” TITLE & META
================================================== #}
{% block title %}
RÃ©sultat {{ session.exam.code|upper }} | Immigration97
{% endblock %}

{% block meta_description %}
RÃ©sultat dÃ©taillÃ© {{ session.exam.code|upper }} :
score global, analyse CECR, feedback intelligent
et recommandations personnalisÃ©es Immigration97.
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/preparation_tests.css' %}?v=20260226">
{% endblock %}

{% block content %}

<!-- ==================================================
HERO â€” RÃ‰SULTAT
================================================== -->
<section class="pt-hero pt-hero--result">
  <div class="container pt-fade-up">

    <span class="pt-badge pt-badge--result">
      ðŸ“Š RÃ©sultat
      {% if session.mode == "mock" %}â€” Examen blanc
      {% elif session.mode == "retry_errors" %}â€” Correction ciblÃ©e
      {% else %}â€” EntraÃ®nement{% endif %}
    </span>

    <h1 class="pt-title">
      {{ session.exam.code|upper }}
    </h1>

    {% include "preparation_tests/partials/_cefr_bar.html" %}

    <p class="pt-lead">
      Session du {{ session.started_at|date:"d/m/Y" }}
      Ã  {{ session.started_at|time:"H:i" }}
    </p>

  </div>
</section>

<!-- ==================================================
SCORE GLOBAL
================================================== -->
<section class="pt-section">
  <div class="container">

    <article class="pt-card pt-card--score">

      <div class="pt-score-circle">
        <span>{{ global_pct }}%</span>
      </div>

      <div class="pt-score-summary">
        <p class="pt-score-line">
          <strong>{{ total_correct }}</strong> bonnes rÃ©ponses
          sur <strong>{{ total_items }}</strong>
        </p>

        <p class="pt-score-eval">
          {% if global_pct >= 80 %}
            ðŸš€ Excellent niveau â€” prÃªt pour lâ€™examen officiel
          {% elif global_pct >= 60 %}
            ðŸ’ª Bon niveau â€” consolidation recommandÃ©e
          {% else %}
            ðŸ§± Bases Ã  renforcer â€” retour aux fondamentaux conseillÃ©
          {% endif %}
        </p>

        <div class="pt-pill-row">
          <span class="pt-pill">
            Examen : {{ session.exam.name }}
          </span>
          <span class="pt-pill">
            Mode :
            {% if session.mode == "mock" %}Examen blanc
            {% elif session.mode == "retry_errors" %}Correction ciblÃ©e
            {% else %}EntraÃ®nement{% endif %}
          </span>
        </div>

      </div>

    </article>

  </div>
</section>

<!-- ==================================================
PROGRESSION CECR
================================================== -->
<section class="pt-section">
  <div class="container">

    <article class="pt-card">
      <h2>ðŸ“ˆ Progression CECR</h2>

      <div class="pt-cefr-grid">
        {% for c in cefr_map %}
        <div class="pt-cefr-card
          {% if c.is_current %}is-current{% endif %}
          {% if c.is_unlocked %}is-unlocked{% else %}is-locked{% endif %}
        ">
          <div class="pt-cefr-level">{{ c.level }}</div>

          {% if c.is_current %}
            <div class="pt-cefr-current">Niveau actuel</div>
          {% else %}
            <div class="pt-cefr-goal">
              Objectif : {{ c.percent_required }}%
            </div>
          {% endif %}
        </div>
        {% endfor %}
      </div>

    </article>

  </div>
</section>

<!-- ==================================================
DÃ‰TAIL PAR COMPÃ‰TENCE
================================================== -->
<section class="pt-section">
  <div class="container">

    <article class="pt-card">
      <h2>ðŸ“Š DÃ©tail par compÃ©tence</h2>

      <table class="pt-results-table">
        <thead>
          <tr>
            <th>CompÃ©tence</th>
            <th>Score</th>
            <th>Niveau estimÃ©</th>
            <th>Questions</th>
          </tr>
        </thead>
        <tbody>

          {% for attempt in attempts %}
          {% with total=attempt.total_items correct=attempt.raw_score %}
          {% if total > 0 %}
            {% widthratio correct total 100 as pct %}
          {% else %}
            {% with 0 as pct %}{% endwith %}
          {% endif %}

          <tr>
            <td>{{ attempt.section.code|upper }} â€“ {{ attempt.section.name }}</td>
            <td>
              <span class="pt-score-pill
                {% if pct >= 80 %}is-good
                {% elif pct >= 60 %}is-mid
                {% else %}is-low{% endif %}">
                {{ pct }}%
              </span>
            </td>
            <td>
              {% if pct < 40 %}A1â€“A2
              {% elif pct < 60 %}B1
              {% elif pct < 80 %}B2
              {% else %}C1â€“C2{% endif %}
            </td>
            <td>{{ correct }} / {{ total }}</td>
          </tr>
          {% endwith %}
          {% endfor %}

        </tbody>
      </table>

    </article>

  </div>
</section>

<!-- ==================================================
ACTIONS UTILISATEUR
================================================== -->
<section class="pt-section pt-section--cta">
  <div class="container text-center">

    <div class="pt-cta-group">
      <a
        href="{% url "preparation_tests:session_correction" session.id %}"
        class="pt-btn-primary"
      >
        Voir le corrigÃ©
      </a>

      <a
        href="{% url "preparation_tests:retry_session_errors" session.id %}"
        class="pt-btn-secondary"
      >
        Refaire mes erreurs
      </a>

      <a
        href="{% url "preparation_tests:session_review" %}"
        class="pt-btn-ghost"
      >
        Historique
      </a>
    </div>

  </div>
</section>

{% endblock %}
