{% extends "preparation_tests/tef_course_base.html" %}
{% load static %}

{% block title %}R√©sultats de ta session | E-SHELLE{% endblock %}

{% block hero %}
  <div class="hero-kicker">
    {{ session.exam.code|upper }} ‚Ä¢ R√âSULTATS DE LA SESSION
  </div>
  <h1 class="hero-title">
    R√©sultats ‚Äî <span>{{ session.exam.code|upper }}</span>
  </h1>
  <p class="hero-sub">
    D√©couvre ton score, tes points forts, tes erreurs et les conseils du coach IA pour viser le meilleur niveau.
  </p>
  <div class="hero-actions">
    <a href="{% url 'preparation_tests:home' %}" class="btn btn-primary">
      ‚¨ÖÔ∏è Retour au tableau de bord
    </a>
    <a href="{% url 'preparation_tests:exam_detail' session.exam.code %}" class="btn btn-ghost">
      üìò Voir les informations de l‚Äôexamen {{ session.exam.code|upper }}
    </a>
    {% if session.exam.code|lower == "tef" %}
      <a href="{% url 'preparation_tests:start_mock_tef_co' %}" class="btn btn-ghost">
        üéß Refaire un examen CO
      </a>
    {% endif %}
  </div>
{% endblock %}

{% block content %}
<div class="container">

  <!-- ===================== R√©sum√© g√©n√©ral ===================== -->
  <section class="section">
    <h2 class="section-title">
      <span class="emoji">üìä</span>
      R√©sum√© g√©n√©ral
    </h2>

    <article class="card">
      <div class="card-header">
        <h3 class="card-title">Performance globale</h3>
      </div>
            <div class="card-body">
        <p class="metric">
          <strong>{{ total_correct }}</strong> bonnes r√©ponses sur
          <strong>{{ total_items }}</strong>
          {% if total_items %}
            ‚Äî soit
            <strong>{{ global_pct }} %</strong>
          {% endif %}
        </p>

        {% if total_items %}
          <div class="progress-bar global-progress">
            <div class="progress"
                 style="width: {{ global_pct }}%;"></div>
          </div>
        {% endif %}

        <ul class="bullet">
          <li>Examen : <strong>{{ session.exam.name }} ({{ session.exam.code|upper }})</strong></li>
          <li>Mode :
            <strong>
              {% if session.mode == "exam" %}
                Examen blanc
              {% else %}
                Entra√Ænement
              {% endif %}
            </strong>
          </li>
          <li>Date : <strong>{{ session.started_at|date:"d/m/Y √† H:i" }}</strong></li>
        </ul>
      </div>


    </article>
  </section>

  <!-- ===================== D√©tails par section ===================== -->
  <section class="section">
    <h2 class="section-title">
      <span class="emoji">üß©</span>
      D√©tails par section
    </h2>

    {% for a in attempts %}
      <article class="card">
        <div class="card-header card-header-between">
          <div>
            <div class="card-kicker">
              {{ session.exam.code|upper }} ‚Äî {{ a.section.code|upper }}
            </div>
            <h3 class="card-title">
              Section {{ a.section.code|upper }}
            </h3>
          </div>
          <span class="badge badge-pill">
            {{ a.raw_score|floatformat:0 }}/{{ a.total_items }}
          </span>
        </div>
        <div class="card-body">
          <ul class="bullet">
            <li>Score brut : <strong>{{ a.raw_score|floatformat:0 }}</strong></li>
            <li>Total de questions : <strong>{{ a.total_items }}</strong></li>
            <li>Temps estim√© :
              <strong>
                {% if a.elapsed_sec %}
                  {{ a.elapsed_sec }} s
                {% else %}
                  non compt√©
                {% endif %}
              </strong>
            </li>
          </ul>
        </div>
      </article>
    {% endfor %}
  </section>

  <!-- ===================== Coach IA ‚Äì TEF CO ===================== -->
  {% if analysis %}
  <section class="section">
    <h2 class="section-title">
      <span class="emoji">ü§ñ</span>
      Analyse IA ‚Äî Coach Compr√©hension Orale
    </h2>

    <article class="card">
      <div class="card-header">
        <h3 class="card-title">
          R√©sultat TEF CO
        </h3>
      </div>

      <div class="card-body">
        <p class="metric">
          Score CO :
          <strong>{{ analysis.score_pct }} %</strong>
          ‚Äî Score TEF simul√© :
          <strong>{{ analysis.score_tef }}/360</strong>
          ‚Äî Niveau estim√© :
          <strong>{{ analysis.level }}</strong>
        </p>

        <div class="progress-bar global-progress">
          <div class="progress" style="width: {{ analysis.score_pct }}%;"></div>
        </div>

        {% if analysis.errors %}
          <h4 class="card-subtitle">‚ùå Types d‚Äôerreurs d√©tect√©es</h4>
          <ul class="bullet">
            {% for key, val in analysis.errors.items %}
              <li><strong>{{ key }}</strong> : {{ val }} erreur(s)</li>
            {% endfor %}
          </ul>
        {% endif %}

        {% if analysis.recommendations %}
          <h4 class="card-subtitle">üìå Recommandations personnalis√©es</h4>
          <ul class="bullet">
            {% for r in analysis.recommendations %}
              <li>{{ r }}</li>
            {% endfor %}
          </ul>
        {% endif %}
      </div>
    </article>
  </section>
  {% endif %}

  <!-- ===================== Boutons de fin ===================== -->
  <section class="section actions">
    <a href="{% url 'preparation_tests:home' %}" class="btn btn-primary">
      üè† Retour au tableau de bord
    </a>
    <a href="{% url 'preparation_tests:exam_detail' session.exam.code %}" class="btn btn-ghost">
      üìò Voir les informations de l‚Äôexamen {{ session.exam.code|upper }}
    </a>
    {% if session.exam.code|lower == "tef" %}
      <a href="{% url 'preparation_tests:start_mock_tef_co' %}" class="btn btn-ghost">
        üéß Refaire un examen CO
      </a>
    {% endif %}
  </section>

</div>
{% endblock %}
