{% extends "base.html" %}
{% load static %}

{% block title %}
R√©sultat de la session | Immigration97
{% endblock %}

{% block meta_description %}
R√©sultat d√©taill√© de votre session {{ session.exam.code|upper }} :
scores par section, analyse IA et recommandations personnalis√©es.
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/pages/preparation_tests.css' %}">
{% endblock %}

{% block content %}

<section class="page page-language">

  <!-- ===== TITRE ===== -->
  <header class="page-title">
    <h1>
      Session {{ session.exam.code|upper }}
      {% if session.mode == "mock" %}
        (Examen blanc)
      {% elif session.mode == "retry_errors" %}
        (Correction cibl√©e)
      {% else %}
        (Entra√Ænement)
      {% endif %}
    </h1>

    <p>
      Date :
      <strong>{{ session.started_at|date:"d/m/Y" }}</strong>
      √† <strong>{{ session.started_at|time:"H:i" }}</strong>
      ‚Äî r√©sum√© de tes performances.
    </p>
  </header>

  <div class="grid-main">

    <!-- ======================
         COLONNE GAUCHE
    ======================= -->
    <article class="card">

      <h2>Score global</h2>

      <div class="score-big">
        <div class="score-circle">
          <div class="score-circle-inner">
            {{ global_pct }}%
          </div>
        </div>

        <div>
          <div class="score-text-main">
            <strong>{{ total_correct }}</strong> bonnes r√©ponses sur
            <strong>{{ total_items }}</strong>
          </div>

          <div class="score-subline">
            {% if global_pct >= 80 %}
              Excellent üöÄ ‚Äî pr√™t pour les examens blancs complets.
            {% elif global_pct >= 60 %}
              Bon niveau üí™ ‚Äî encore un peu de consolidation.
            {% else %}
              Base √† renforcer üß± ‚Äî retravaille les fondamentaux.
            {% endif %}
          </div>

          <div class="score-tags">
            <span class="pill">Examen : {{ session.exam.name }}</span>
            <span class="pill">
              Mode :
              {% if session.mode == "mock" %}Examen blanc
              {% elif session.mode == "retry_errors" %}Correction cibl√©e
              {% else %}Entra√Ænement{% endif %}
            </span>
          </div>
        </div>
      </div>

      {% if session.mode == "retry_errors" %}
        <div class="session-history-box">
          <strong>üìò Correction cibl√©e :</strong>
          tu retravailles uniquement tes erreurs pour progresser plus vite.
        </div>
      {% endif %}

      <!-- ===== TABLE DES SECTIONS ===== -->
      <div class="section-table">
        <table>
          <thead>
            <tr>
              <th>Section</th>
              <th>Score</th>
              <th>Niveau estim√©</th>
              <th>Questions</th>
            </tr>
          </thead>
          <tbody>
            {% for attempt in attempts %}
              {% with total=attempt.total_items correct=attempt.raw_score %}
                {% if total > 0 %}
                  {% widthratio correct total 100 as pct %}
                {% else %}
                  {% with 0 as pct %}{% endwith %}
                {% endif %}
                <tr>
                  <td>{{ attempt.section.code|upper }} ‚Äì {{ attempt.section.name }}</td>
                  <td>
                    {% if pct >= 80 %}
                      <span class="score-pill score-good">{{ pct }}%</span>
                    {% elif pct >= 60 %}
                      <span class="score-pill score-mid">{{ pct }}%</span>
                    {% else %}
                      <span class="score-pill score-low">{{ pct }}%</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if pct < 40 %}A1‚ÄìA2
                    {% elif pct < 60 %}B1
                    {% elif pct < 80 %}B2
                    {% else %}C1‚ÄìC2{% endif %}
                  </td>
                  <td>{{ correct }} / {{ total }}</td>
                </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- ===== ACTIONS ===== -->
      <div class="btn-row" style="margin-top:16px;">
        <a class="btn btn--primary"
           href="{% url 'preparation_tests:session_correction' session.id %}">
          Voir le corrig√© d√©taill√©
        </a>

        <a class="btn btn--soft"
           href="{% url 'preparation_tests:retry_session_errors' session.id %}">
          Refaire mes erreurs
        </a>

        <a class="btn btn--soft"
           href="{% url 'preparation_tests:session_review' %}">
          Retour aux r√©sultats
        </a>
      </div>

    </article>

    <!-- ======================
         COLONNE DROITE
    ======================= -->
    <aside>

      <article class="card side-card">
        <h3>Conseils personnalis√©s</h3>
        <ul>
          <li>Travaille d‚Äôabord les sections &lt; 60 %</li>
          <li>Vise au moins 70 % par section</li>
          <li>Alterner cours + entra√Ænements chronom√©tr√©s</li>
        </ul>
      </article>

      {% if analysis %}
        <article class="card side-card">
          <h3>Analyse IA</h3>
          <p>{{ analysis }}</p>
        </article>
      {% endif %}

    </aside>

  </div>
</section>

{% endblock %}
