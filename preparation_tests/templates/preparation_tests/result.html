{% extends "base.html" %}
{% load static %}

{% block title %}
RÃ©sultat de la session | Immigration97
{% endblock %}

{% block meta_description %}
RÃ©sultat dÃ©taillÃ© de votre session {{ session.exam.code|upper }} :
scores par section, analyse intelligente et recommandations personnalisÃ©es.
{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'css/pages/preparation_tests.css' %}">
{% endblock %}

{% block content %}
<section class="page page-language">

  <!-- =====================
        EN-TÃŠTE
  ====================== -->
  <header class="page-title">
    <h1>
      RÃ©sultat {{ session.exam.code|upper }}
      <span class="subtitle">
        {% if session.mode == "mock" %}
          Examen blanc
        {% elif session.mode == "retry_errors" %}
          Correction ciblÃ©e
        {% else %}
          EntraÃ®nement
        {% endif %}
      </span>
    </h1>

    {% include "preparation_tests/partials/_cefr_bar.html" %}

    <p class="page-subtitle">
      Session du {{ session.started_at|date:"d/m/Y" }}
      Ã  {{ session.started_at|time:"H:i" }}
    </p>
  </header>

  <div class="grid-main">

    <!-- =====================
         COLONNE PRINCIPALE
    ====================== -->
    <article class="card card-main">

      <!-- ===== SCORE GLOBAL ===== -->
      <section class="score-global">
        <div class="score-circle">
          <span>{{ global_pct }}%</span>
        </div>

        <div class="score-summary">
          <p class="score-line">
            <strong>{{ total_correct }}</strong> bonnes rÃ©ponses sur
            <strong>{{ total_items }}</strong>
          </p>

          <p class="score-eval">
            {% if global_pct >= 80 %}
              ðŸš€ Excellent niveau â€” prÃªt pour lâ€™examen officiel
            {% elif global_pct >= 60 %}
              ðŸ’ª Bon niveau â€” consolidation recommandÃ©e
            {% else %}
              ðŸ§± Bases Ã  renforcer â€” retour aux fondamentaux conseillÃ©
            {% endif %}
          </p>

          <div class="pill-row">
            <span class="pill">Examen : {{ session.exam.name }}</span>
            <span class="pill">
              Mode :
              {% if session.mode == "mock" %}Examen blanc
              {% elif session.mode == "retry_errors" %}Correction ciblÃ©e
              {% else %}EntraÃ®nement{% endif %}
            </span>
          </div>
        </div>
      </section>

      <!-- ===== CECR MAP ===== -->
      <section class="cefr-map">
        <h2>ðŸ“ˆ Ta progression CECRL</h2>

        <div class="cefr-grid">
          {% for c in cefr_map %}
            <div class="cefr-card
              {% if c.is_current %}current{% endif %}
              {% if c.is_unlocked %}unlocked{% else %}locked{% endif %}
            ">
              <div class="cefr-level">{{ c.level }}</div>

              <div class="cefr-status">
                {% if c.is_unlocked %}
                  âœ… DÃ©bloquÃ©
                {% else %}
                  ðŸ”’ BloquÃ©
                {% endif %}
              </div>

              {% if c.is_current %}
                <div class="cefr-current">Niveau actuel</div>
              {% else %}
                <div class="cefr-goal">
                  Objectif : {{ c.percent_required }}%
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </section>

      <!-- ===== TABLEAU DES SECTIONS ===== -->
      <section class="section-results">
        <h2>ðŸ“Š DÃ©tail par compÃ©tence</h2>

        <table class="results-table">
          <thead>
            <tr>
              <th>CompÃ©tence</th>
              <th>Score</th>
              <th>Niveau estimÃ©</th>
              <th>Questions</th>
            </tr>
          </thead>
          <tbody>
            {% for attempt in attempts %}
              {% with total=attempt.total_items correct=attempt.raw_score %}
                {% if total > 0 %}
                  {% widthratio correct total 100 as pct %}
                {% else %}
                  {% with 0 as pct %}{% endwith %}
                {% endif %}
                <tr>
                  <td>{{ attempt.section.code|upper }} â€“ {{ attempt.section.name }}</td>
                  <td>
                    <span class="score-pill
                      {% if pct >= 80 %}good
                      {% elif pct >= 60 %}mid
                      {% else %}low{% endif %}">
                      {{ pct }}%
                    </span>
                  </td>
                  <td>
                    {% if pct < 40 %}A1â€“A2
                    {% elif pct < 60 %}B1
                    {% elif pct < 80 %}B2
                    {% else %}C1â€“C2{% endif %}
                  </td>
                  <td>{{ correct }} / {{ total }}</td>
                </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </section>

      <!-- ===== FEEDBACK ===== -->
      {% if feedback %}
      <section class="feedback-box {{ feedback.tone }}">
        <h2>ðŸ§  Analyse intelligente</h2>

        <p class="feedback-main">{{ feedback.global_message }}</p>

        <ul class="feedback-list">
          {% for s in feedback.skill_feedback %}
            <li class="{{ s.status }}">
              <strong>{{ s.skill }}</strong> :
              {{ s.pct }}% â€” {{ s.message }}
            </li>
          {% endfor %}
        </ul>

        <p class="feedback-reco">{{ feedback.recommendation }}</p>

        {% if feedback.unlocked.unlocked %}
          <div class="unlock-box">
            ðŸ”“ Niveau dÃ©bloquÃ© :
            <strong>{{ feedback.unlocked.old_level }} â†’ {{ feedback.unlocked.new_level }}</strong>
          </div>
        {% endif %}
      </section>
      {% endif %}

      <!-- ===== ACTIONS ===== -->
      <section class="action-row">
        <a class="btn btn-primary"
           href="{% url 'preparation_tests:session_correction' session.id %}">
          Voir le corrigÃ©
        </a>

        <a class="btn btn-soft"
           href="{% url 'preparation_tests:retry_session_errors' session.id %}">
          Refaire mes erreurs
        </a>

        <a class="btn btn-soft"
           href="{% url 'preparation_tests:session_review' %}">
          Historique des sessions
        </a>
      </section>

    </article>

    <!-- =====================
         SIDEBAR
    ====================== -->
    <aside class="sidebar">

      <article class="card side-card">
        <h3>ðŸŽ¯ Conseils de progression</h3>
        <ul>
          <li>Travailler les sections &lt; 60%</li>
          <li>Objectif â‰¥ 70% par compÃ©tence</li>
          <li>Alterner cours et examens blancs</li>
        </ul>
      </article>

      {% if analysis %}
      <article class="card side-card">
        <h3>ðŸ¤– Analyse IA</h3>
        <p>{{ analysis }}</p>
      </article>
      {% endif %}

    </aside>
  </div>

  <!-- =====================
       COACH IA GLOBAL
  ====================== -->
  {% if global_analysis %}
  <article class="card">
    <h2>ðŸ§  Coach IA Global</h2>

    <p>
      <strong>Niveau global estimÃ© :</strong>
      {{ global_analysis.estimated_level }}
      ({{ global_analysis.avg_score }}%)
    </p>

    <h3>ðŸ“Š PrioritÃ©s par compÃ©tence</h3>
    <ul>
      {% for p in global_analysis.priorities %}
        <li>{{ p.section }} â€“ {{ p.score }}% ({{ p.level }})</li>
      {% endfor %}
    </ul>

    <h3>ðŸŽ¯ Recommandations globales</h3>
    <ul>
      {% for advice in global_analysis.global_advice %}
        <li>{{ advice }}</li>
      {% endfor %}
    </ul>
  </article>
  {% endif %}

</section>
{% endblock %}
