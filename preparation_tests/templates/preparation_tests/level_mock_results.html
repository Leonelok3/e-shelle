{% extends "base.html" %}
{% load static %}

{% block body_class %}preparation-tests{% endblock %}
{% block app_scope %}preparation-tests{% endblock %}

{% block title %}
R√©sultats Examen blanc Niveau {{ level }} | Immigration97
{% endblock %}

{% block meta_description %}
R√©sultats de ton examen blanc niveau {{ level }} :
score CO, CE et estimation CECR personnalis√©e par Immigration97.
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/preparation_tests.css' %}?v=20260227">
{% endblock %}

{% block content %}

<!-- HERO -->
<section class="pt-hero pt-hero--result">
  <div class="container pt-fade-up">

    <span class="pt-badge pt-badge--result">
      üß™ R√©sultats ‚Äî Examen blanc
    </span>

    <h1 class="pt-title">
      Niveau <span class="pt-gradient-primary">{{ level }}</span>
    </h1>

    <p class="pt-lead">
      {% if score_global is not None %}
        Score global CO + CE :
        <strong>{{ score_global }}%</strong> ‚Äî
        Niveau CECR estim√© : <strong>{{ cefr_estimate }}</strong>
      {% else %}
        Examen enregistr√© ‚Äî CO et CE non disponibles pour ce niveau.
      {% endif %}
    </p>

  </div>
</section>

<!-- SCORE GLOBAL -->
{% if score_global is not None %}
<section class="pt-section">
  <div class="container">
    <article class="pt-card pt-card--score" style="text-align:center;">

      <div class="pt-score-circle">
        <span>{{ score_global }}%</span>
      </div>

      <div class="pt-score-summary">
        <p class="pt-score-eval">
          {% if score_global >= 80 %}
            üöÄ Excellent niveau ‚Äî pr√™t pour l'examen officiel !
          {% elif score_global >= 60 %}
            üí™ Bon niveau ‚Äî quelques points √† consolider
          {% elif score_global >= 40 %}
            üìö Niveau interm√©diaire ‚Äî poursuis l'entra√Ænement
          {% else %}
            üß± Bases √† renforcer ‚Äî retour aux fondamentaux conseill√©
          {% endif %}
        </p>
        <div class="pt-pill-row">
          <span class="pt-pill">Niveau {{ level }}</span>
          <span class="pt-pill">CECR estim√© : {{ cefr_estimate }}</span>
          <span class="pt-pill">Examen blanc</span>
        </div>
      </div>

    </article>
  </div>
</section>
{% endif %}

<!-- D√âTAIL CO + CE -->
<section class="pt-section">
  <div class="container">
    <div class="pt-info-grid" style="grid-template-columns: 1fr 1fr; gap:1.5rem;">

      {# ‚îÄ‚îÄ Score CO ‚îÄ‚îÄ #}
      <article class="pt-card" style="text-align:center;">
        <h3>üéß Compr√©hension Orale</h3>
        {% if score_co is not None %}
          <div class="pt-score-circle" style="width:80px; height:80px; margin:1rem auto; font-size:1.1rem;">
            <span>{{ score_co }}%</span>
          </div>
          <p class="pt-card-meta">
            {{ co_correct }} / {{ co_total }} correcte{{ co_total|pluralize }}
          </p>
          <div class="pt-progress" style="margin:.75rem 0;">
            <div class="pt-progress-bar">
              <div class="pt-progress-fill" style="width:{{ score_co }}%;"></div>
            </div>
          </div>

          {% if co_results %}
          <details style="margin-top:1rem; text-align:left;">
            <summary style="cursor:pointer; font-weight:600; font-size:.9rem;">
              üìã D√©tail des r√©ponses CO
            </summary>
            <div style="margin-top:.75rem;">
              {% for r in co_results %}
              <div style="
                padding:.5rem .75rem;
                border-radius:6px;
                margin-bottom:.4rem;
                background: {% if r.is_correct %}rgba(46,204,113,.1){% else %}rgba(231,76,60,.08){% endif %};
                border-left: 3px solid {% if r.is_correct %}#2ecc71{% else %}#e74c3c{% endif %};
                font-size:.85rem;
              ">
                <strong>Q{{ forloop.counter }}</strong> ‚Äî {{ r.exercise.question_text }}
                <br>
                {% if r.is_correct %}
                  ‚úÖ <strong>{{ r.submitted }}</strong> ‚Äî Bonne r√©ponse
                {% else %}
                  ‚ùå Ta r√©ponse : <strong>{{ r.submitted|default:"(aucune)" }}</strong>
                  &nbsp;|&nbsp;
                  Correcte : <strong>{{ r.exercise.correct_option }}</strong> ‚Äî
                  {% if r.exercise.correct_option == "A" %}{{ r.exercise.option_a }}
                  {% elif r.exercise.correct_option == "B" %}{{ r.exercise.option_b }}
                  {% elif r.exercise.correct_option == "C" %}{{ r.exercise.option_c }}
                  {% elif r.exercise.correct_option == "D" %}{{ r.exercise.option_d }}
                  {% endif %}
                {% endif %}
                {% if r.exercise.summary and not r.is_correct %}
                  <div style="margin-top:.35rem; padding:.3rem .5rem; background:rgba(0,0,0,.04); border-radius:4px; font-style:italic; color:#555;">
                    üí° {{ r.exercise.summary }}
                  </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </details>
          {% endif %}

        {% else %}
          <p class="pt-empty">Pas de CO disponible pour ce niveau.</p>
        {% endif %}
      </article>

      {# ‚îÄ‚îÄ Score CE ‚îÄ‚îÄ #}
      <article class="pt-card" style="text-align:center;">
        <h3>üìñ Compr√©hension √âcrite</h3>
        {% if score_ce is not None %}
          <div class="pt-score-circle" style="width:80px; height:80px; margin:1rem auto; font-size:1.1rem;">
            <span>{{ score_ce }}%</span>
          </div>
          <p class="pt-card-meta">
            {{ ce_correct }} / {{ ce_total }} correcte{{ ce_total|pluralize }}
          </p>
          <div class="pt-progress" style="margin:.75rem 0;">
            <div class="pt-progress-bar">
              <div class="pt-progress-fill" style="width:{{ score_ce }}%;"></div>
            </div>
          </div>

          {% if ce_results %}
          <details style="margin-top:1rem; text-align:left;">
            <summary style="cursor:pointer; font-weight:600; font-size:.9rem;">
              üìã D√©tail des r√©ponses CE
            </summary>
            <div style="margin-top:.75rem;">
              {% for r in ce_results %}
              <div style="
                padding:.5rem .75rem;
                border-radius:6px;
                margin-bottom:.4rem;
                background: {% if r.is_correct %}rgba(46,204,113,.1){% else %}rgba(231,76,60,.08){% endif %};
                border-left: 3px solid {% if r.is_correct %}#2ecc71{% else %}#e74c3c{% endif %};
                font-size:.85rem;
              ">
                <strong>Q{{ forloop.counter }}</strong> ‚Äî {{ r.exercise.question_text }}
                <br>
                {% if r.is_correct %}
                  ‚úÖ <strong>{{ r.submitted }}</strong> ‚Äî Bonne r√©ponse
                {% else %}
                  ‚ùå Ta r√©ponse : <strong>{{ r.submitted|default:"(aucune)" }}</strong>
                  &nbsp;|&nbsp;
                  Correcte : <strong>{{ r.exercise.correct_option }}</strong> ‚Äî
                  {% if r.exercise.correct_option == "A" %}{{ r.exercise.option_a }}
                  {% elif r.exercise.correct_option == "B" %}{{ r.exercise.option_b }}
                  {% elif r.exercise.correct_option == "C" %}{{ r.exercise.option_c }}
                  {% elif r.exercise.correct_option == "D" %}{{ r.exercise.option_d }}
                  {% endif %}
                {% endif %}
                {% if r.exercise.summary and not r.is_correct %}
                  <div style="margin-top:.35rem; padding:.3rem .5rem; background:rgba(0,0,0,.04); border-radius:4px; font-style:italic; color:#555;">
                    üí° {{ r.exercise.summary }}
                  </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
          </details>
          {% endif %}

        {% else %}
          <p class="pt-empty">Pas de CE disponible pour ce niveau.</p>
        {% endif %}
      </article>

    </div>
  </div>
</section>

<!-- EO + EE : √©valuation IA -->
<section class="pt-section">
  <div class="container">

    {# ‚îÄ‚îÄ EO : enregistrement + √©valuation IA ‚îÄ‚îÄ #}
    {% if eo_items %}
    <article class="pt-card" style="margin-bottom:1.5rem;">
      <h3 style="margin-bottom:1.25rem;">üé§ Expression Orale ‚Äî Correction IA</h3>
      <p class="pt-card-meta" style="margin-bottom:1.25rem;">
        Enregistre ta r√©ponse orale sur chaque sujet. L'IA √©value ta pertinence,
        ta structure, ton vocabulaire et ta grammaire (0‚Äì100).
      </p>

      {% for item in eo_items %}
      <div class="exam-eo-card" data-exercise-id="{{ item.exercise.id }}"
           style="border-left:4px solid #a855f7; padding:1rem 1.25rem; margin-bottom:1rem;
                  border-radius:0 8px 8px 0; background:rgba(168,85,247,.06);">

        <p style="font-weight:600; margin-bottom:.35rem;">
          üé§ Sujet {{ forloop.counter }} ‚Äî {{ item.exercise.title }}
        </p>
        {% if item.exercise.instruction %}
        <p style="font-size:.88rem; opacity:.75; margin-bottom:.4rem;">
          {{ item.exercise.instruction }}
        </p>
        {% endif %}
        {% if item.exercise.question_text %}
        <p style="font-size:.9rem; color:#a855f7; margin-bottom:.75rem;">
          üìù {{ item.exercise.question_text }}
        </p>
        {% endif %}

        <div style="display:flex; align-items:center; gap:.75rem; flex-wrap:wrap; margin-bottom:.5rem;">
          <button class="exam-record-btn pt-btn-primary" style="font-size:.85rem; padding:.45rem .9rem;">
            üé§ Commencer l'enregistrement
          </button>
          <span class="exam-record-timer" style="font-variant-numeric:tabular-nums; font-weight:600; opacity:.7;"></span>
        </div>

        <audio class="exam-playback" controls style="display:none; width:100%; margin:.5rem 0; border-radius:6px;"></audio>

        <div style="display:flex; gap:.75rem; flex-wrap:wrap;">
          <button class="exam-submit-eo pt-btn-secondary" style="display:none; font-size:.85rem; padding:.45rem .9rem;">
            üì§ √âvaluer par IA
          </button>
        </div>

        <div class="exam-eo-loading" style="display:none; margin-top:.5rem; opacity:.7; font-size:.88rem;">
          ‚è≥ Transcription + √©valuation en cours‚Ä¶
        </div>
        <div class="exam-eo-result" style="display:none;"></div>

      </div>
      {% endfor %}
    </article>
    {% endif %}

    {# ‚îÄ‚îÄ EE : textarea + correction IA ‚îÄ‚îÄ #}
    {% if ee_exercise %}
    <article class="pt-card">
      <h3 style="margin-bottom:1.25rem;">‚úçÔ∏è Expression √âcrite ‚Äî Correction IA</h3>
      <p class="pt-card-meta" style="margin-bottom:1.25rem;">
        R√©dige ta r√©ponse dans la zone ci-dessous. L'IA corrige ton texte
        et fournit une version am√©lior√©e (score 0‚Äì100).
      </p>

      <div class="exam-ee-card" data-exercise-id="{{ ee_exercise.id }}"
           style="border-left:4px solid #f59e0b; padding:1rem 1.25rem;
                  border-radius:0 8px 8px 0; background:rgba(245,158,11,.06);">

        <p style="font-weight:600; margin-bottom:.35rem;">
          ‚úçÔ∏è {{ ee_exercise.title }}
        </p>
        {% if ee_exercise.instruction %}
        <p style="font-size:.88rem; opacity:.75; margin-bottom:.4rem;">
          {{ ee_exercise.instruction }}
        </p>
        {% endif %}
        {% if ee_exercise.question_text %}
        <p style="font-size:.9rem; color:#f59e0b; margin-bottom:.75rem;">
          üìù {{ ee_exercise.question_text }}
        </p>
        {% endif %}

        <textarea class="exam-ee-textarea" rows="8"
          placeholder="R√©digez votre r√©ponse ici‚Ä¶"
          style="width:100%; padding:.75rem 1rem; border-radius:6px;
                 border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.2);
                 color:inherit; font-size:.92rem; line-height:1.6; resize:vertical;
                 box-sizing:border-box;"></textarea>

        <div style="display:flex; align-items:center; justify-content:space-between;
                    flex-wrap:wrap; gap:.5rem; margin-top:.5rem;">
          <span style="font-size:.82rem; opacity:.65;">
            <span class="exam-word-count">0</span> mot(s)
          </span>
          <button class="exam-submit-ee pt-btn-secondary" style="font-size:.85rem; padding:.45rem .9rem;">
            ‚úÖ Corriger par IA
          </button>
        </div>

        <div class="exam-ee-loading" style="display:none; margin-top:.5rem; opacity:.7; font-size:.88rem;">
          ‚è≥ Correction en cours‚Ä¶
        </div>
        <div class="exam-ee-result" style="display:none;"></div>

      </div>
    </article>
    {% endif %}

  </div>
</section>

<!-- ACTIONS -->
<section class="pt-section pt-section--cta">
  <div class="container text-center">
    <div class="pt-cta-group">

      <a
        href="{% url "preparation_tests:level_mock_exam" level %}"
        class="pt-btn-primary"
      >
        üîÑ Recommencer le niveau {{ level }}
      </a>

      {% if next_level %}
      <a
        href="{% url "preparation_tests:level_mock_exam" next_level %}"
        class="pt-btn-secondary"
      >
        ‚¨ÜÔ∏è Passer au niveau {{ next_level }}
      </a>
      {% endif %}

      <a
        href="{% url "preparation_tests:level_mock_hub" %}"
        class="pt-btn-ghost"
      >
        üìã Tous les niveaux
      </a>

      <a
        href="{% url "preparation_tests:dashboard_global" %}"
        class="pt-btn-ghost"
      >
        üìä Mon tableau de bord
      </a>

      <a
        href="{% url "preparation_tests:mock_exam_history" %}"
        class="pt-btn-ghost"
      >
        üìà Mon historique
      </a>

    </div>
  </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
(function () {
  "use strict";

  /* ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  function getCsrf() {
    var m = document.cookie.match(/csrftoken=([^;]+)/);
    return m ? decodeURIComponent(m[1]) : "";
  }

  function scoreColor(s) {
    return s >= 70 ? "#2ecc71" : s >= 50 ? "#f59e0b" : "#e74c3c";
  }

  function escHtml(s) {
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  function renderEoResult(div, data) {
    if (!data.ok) {
      div.innerHTML = "<p style=\"color:#e74c3c;\">Erreur : " + escHtml(data.error || "inconnue") + "</p>";
      return;
    }
    var color = scoreColor(data.score);
    var html = "<div style=\"border-left:4px solid " + color + "; padding:.75rem 1rem;"
      + " border-radius:0 6px 6px 0; background:rgba(0,0,0,.08); margin-top:.75rem;\">";
    html += "<p style=\"margin-bottom:.4rem;\"><strong style=\"color:" + color
      + "; font-size:1.15rem;\">" + Math.round(data.score) + "/100</strong>"
      + " &mdash; " + escHtml(data.feedback) + "</p>";

    if (data.criteria) {
      html += "<div style=\"display:flex; flex-wrap:wrap; gap:.4rem; margin:.4rem 0;\">";
      Object.keys(data.criteria).forEach(function (k) {
        html += "<span style=\"background:rgba(255,255,255,.08); border-radius:4px;"
          + " padding:.2rem .5rem; font-size:.78rem;\">"
          + escHtml(k) + " : <strong>" + data.criteria[k] + "</strong></span>";
      });
      html += "</div>";
    }

    if (data.transcript) {
      html += "<details style=\"margin-top:.5rem;\">"
        + "<summary style=\"cursor:pointer; font-size:.85rem; opacity:.75;\">üìù Transcription</summary>"
        + "<p style=\"font-size:.84rem; margin-top:.4rem; opacity:.8; line-height:1.6;\">"
        + escHtml(data.transcript) + "</p></details>";
    }

    if (data.points_covered && data.points_covered.length) {
      html += "<p style=\"margin-top:.5rem; font-size:.85rem;\"><strong>Points couverts :</strong> "
        + data.points_covered.map(escHtml).join(", ") + "</p>";
    }

    if (data.suggestions && data.suggestions.length) {
      html += "<ul style=\"margin-top:.4rem; font-size:.85rem; padding-left:1.2rem;\">"
        + data.suggestions.map(function (s) {
            return "<li>üí° " + escHtml(s) + "</li>";
          }).join("") + "</ul>";
    }

    html += "</div>";
    div.innerHTML = html;
  }

  function renderEeResult(div, data) {
    if (!data.ok) {
      div.innerHTML = "<p style=\"color:#e74c3c;\">Erreur : " + escHtml(data.error || "inconnue") + "</p>";
      return;
    }
    var color = scoreColor(data.score);
    var html = "<div style=\"border-left:4px solid " + color + "; padding:.75rem 1rem;"
      + " border-radius:0 6px 6px 0; background:rgba(0,0,0,.08); margin-top:.75rem;\">";
    html += "<p style=\"margin-bottom:.4rem;\"><strong style=\"color:" + color
      + "; font-size:1.15rem;\">" + Math.round(data.score) + "/100</strong>"
      + " &mdash; " + escHtml(data.feedback) + "</p>";

    if (data.criteria) {
      html += "<div style=\"display:flex; flex-wrap:wrap; gap:.4rem; margin:.4rem 0;\">";
      Object.keys(data.criteria).forEach(function (k) {
        html += "<span style=\"background:rgba(255,255,255,.08); border-radius:4px;"
          + " padding:.2rem .5rem; font-size:.78rem;\">"
          + escHtml(k) + " : <strong>" + data.criteria[k] + "</strong></span>";
      });
      html += "</div>";
    }

    if (data.word_count) {
      html += "<p style=\"font-size:.82rem; opacity:.6; margin-top:.25rem;\">"
        + data.word_count + " mots</p>";
    }

    if (data.errors && data.errors.length) {
      html += "<p style=\"margin-top:.6rem; font-size:.85rem; font-weight:600;\">Corrections :</p>"
        + "<ul style=\"font-size:.85rem; padding-left:1.2rem; margin-top:.25rem;\">";
      data.errors.forEach(function (e) {
        html += "<li><del style=\"color:#e74c3c;\">" + escHtml(e.original) + "</del>"
          + " &rarr; <span style=\"color:#2ecc71;\">" + escHtml(e.correction) + "</span>"
          + " <em style=\"opacity:.55; font-size:.82rem;\">(" + escHtml(e.rule) + ")</em></li>";
      });
      html += "</ul>";
    }

    if (data.corrected_version) {
      html += "<details style=\"margin-top:.6rem;\">"
        + "<summary style=\"cursor:pointer; font-size:.85rem; opacity:.75;\">‚úÖ Version corrig√©e compl√®te</summary>"
        + "<pre style=\"font-size:.82rem; white-space:pre-wrap; margin-top:.4rem;"
        + " background:rgba(0,0,0,.15); padding:.75rem; border-radius:6px; line-height:1.6;\">"
        + escHtml(data.corrected_version) + "</pre></details>";
    }

    html += "</div>";
    div.innerHTML = html;
  }

  /* ‚îÄ‚îÄ EO : MediaRecorder par sujet ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  document.querySelectorAll(".exam-eo-card").forEach(function (card) {
    var exId      = card.dataset.exerciseId;
    var recordBtn = card.querySelector(".exam-record-btn");
    var timerEl   = card.querySelector(".exam-record-timer");
    var playback  = card.querySelector(".exam-playback");
    var submitBtn = card.querySelector(".exam-submit-eo");
    var loading   = card.querySelector(".exam-eo-loading");
    var resultDiv = card.querySelector(".exam-eo-result");

    var mediaRecorder, audioChunks = [], audioBlob, startTime, timerInterval;

    recordBtn.addEventListener("click", function () {
      if (!mediaRecorder || mediaRecorder.state === "inactive") {
        navigator.mediaDevices.getUserMedia({ audio: true }).then(function (stream) {
          var mimeType = MediaRecorder.isTypeSupported("audio/webm;codecs=opus")
            ? "audio/webm;codecs=opus" : "audio/webm";
          audioChunks = [];
          mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });

          mediaRecorder.ondataavailable = function (e) {
            if (e.data && e.data.size > 0) audioChunks.push(e.data);
          };
          mediaRecorder.onstop = function () {
            stream.getTracks().forEach(function (t) { t.stop(); });
            audioBlob = new Blob(audioChunks, { type: mimeType });
            playback.src = URL.createObjectURL(audioBlob);
            playback.style.display = "";
            submitBtn.style.display = "";
          };

          mediaRecorder.start();
          startTime = Date.now();
          timerInterval = setInterval(function () {
            var s = Math.floor((Date.now() - startTime) / 1000);
            timerEl.textContent = Math.floor(s / 60) + ":" + String(s % 60).padStart(2, "0");
          }, 1000);

          recordBtn.textContent = "‚èπÔ∏è Arr√™ter l'enregistrement";
          recordBtn.style.background = "#c0392b";
        }).catch(function (err) {
          alert("Microphone inaccessible : " + err.message);
        });

      } else if (mediaRecorder.state === "recording") {
        clearInterval(timerInterval);
        mediaRecorder.stop();
        recordBtn.textContent = "üé§ Recommencer";
        recordBtn.style.background = "";
      }
    });

    submitBtn.addEventListener("click", function () {
      if (!audioBlob) return;
      submitBtn.disabled = true;
      loading.style.display = "";
      resultDiv.style.display = "none";

      var fd = new FormData();
      fd.append("exercise_id", exId);
      fd.append("audio", audioBlob, "recording.webm");

      fetch("/prep/api/submit-eo/", {
        method: "POST",
        headers: { "X-CSRFToken": getCsrf() },
        body: fd,
      })
        .then(function (r) { return r.json(); })
        .then(function (data) {
          loading.style.display = "none";
          renderEoResult(resultDiv, data);
          resultDiv.style.display = "";
        })
        .catch(function () {
          loading.style.display = "none";
          resultDiv.innerHTML = "<p style=\"color:#e74c3c;\">Erreur r√©seau. R√©essaie.</p>";
          resultDiv.style.display = "";
          submitBtn.disabled = false;
        });
    });
  });

  /* ‚îÄ‚îÄ EE : textarea + correction ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
  document.querySelectorAll(".exam-ee-card").forEach(function (card) {
    var exId      = card.dataset.exerciseId;
    var textarea  = card.querySelector(".exam-ee-textarea");
    var counter   = card.querySelector(".exam-word-count");
    var submitBtn = card.querySelector(".exam-submit-ee");
    var loading   = card.querySelector(".exam-ee-loading");
    var resultDiv = card.querySelector(".exam-ee-result");

    textarea.addEventListener("input", function () {
      counter.textContent = textarea.value.trim().split(/\s+/).filter(Boolean).length;
    });

    submitBtn.addEventListener("click", function () {
      var text = textarea.value.trim();
      if (!text) return;
      submitBtn.disabled = true;
      loading.style.display = "";
      resultDiv.style.display = "none";

      fetch("/prep/api/submit-ee/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCsrf(),
        },
        body: JSON.stringify({ exercise_id: parseInt(exId, 10), text: text }),
      })
        .then(function (r) { return r.json(); })
        .then(function (data) {
          loading.style.display = "none";
          textarea.readOnly = true;
          textarea.style.opacity = ".6";
          submitBtn.style.display = "none";
          renderEeResult(resultDiv, data);
          resultDiv.style.display = "";
        })
        .catch(function () {
          loading.style.display = "none";
          resultDiv.innerHTML = "<p style=\"color:#e74c3c;\">Erreur r√©seau. R√©essaie.</p>";
          resultDiv.style.display = "";
          submitBtn.disabled = false;
        });
    });
  });

})();
</script>
{% endblock %}
