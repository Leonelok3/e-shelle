{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Session CO ‚Äì TEF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root {
      --bg: #020617;
      --surface: #02091a;
      --card: rgba(15,23,42,.96);
      --card-soft: rgba(15,23,42,.88);
      --border: rgba(148,163,184,.35);
      --border-soft: rgba(148,163,184,.18);
      --accent: #7aa2ff;
      --accent-soft: rgba(122,162,255,.22);
      --muted: #94a3b8;
      --good: #22c55e;
      --bad: #ef4444;
      --warn: #f59e0b;
      --radius-lg: 22px;
      --radius-md: 16px;
      --shadow-card: 0 20px 60px rgba(15,23,42,.75);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background:
        radial-gradient(1100px 500px at 0% -10%, rgba(122,162,255,.20), transparent 60%),
        radial-gradient(1100px 500px at 130% 0%, rgba(167,139,250,.25), transparent 60%),
        linear-gradient(135deg, #020617, #020617 45%, #02091a);
      color: #e5e7eb;
      min-height: 100vh;
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 20px 16px 40px;
    }

    a { color: inherit; text-decoration: none; }

    /* Top bar */
    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
    }
    .btn-nav {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15,23,42,.9);
      font-size: .9rem;
      cursor: pointer;
    }
    .btn-nav:hover {
      background: rgba(15,23,42,1);
    }

    /* Hero / objectifs */
    .hero-card {
      background: linear-gradient(145deg, rgba(15,23,42,.98), rgba(15,23,42,.94));
      border-radius: var(--radius-lg);
      border: 1px solid rgba(148,163,184,.4);
      box-shadow: var(--shadow-card);
      padding: 18px 18px 20px;
      margin-bottom: 20px;
    }
    .hero-pill {
      font-size: .78rem;
      letter-spacing: .16em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .hero-title {
      margin: 0;
      font-size: 1.6rem;
      font-weight: 800;
    }
    .hero-title span {
      background: linear-gradient(135deg, var(--accent), #a78bfa);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .hero-sub {
      margin-top: 6px;
      font-size: .9rem;
      color: var(--muted);
      max-width: 720px;
    }

    .hero-grid {
      margin-top: 14px;
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.1fr);
      gap: 14px;
    }
    @media (max-width: 900px) {
      .hero-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .hero-box {
      background: var(--card-soft);
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      padding: 12px 14px;
      position: relative;
      overflow: hidden;
    }
    .hero-box::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: radial-gradient(600px 140px at 0 0, var(--accent-soft), transparent 60%);
      opacity: .4;
      pointer-events: none;
    }
    .hero-box h3 {
      margin: 0 0 6px;
      font-size: .98rem;
    }
    .hero-box ul {
      margin: 6px 0 0 18px;
      font-size: .86rem;
      color: var(--muted);
    }

    /* Layout dessous */
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 1.1fr);
      gap: 18px;
      margin-top: 18px;
    }
    @media (max-width: 980px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card-main,
    .card-side {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-card);
      padding: 16px 16px 18px;
    }

    .card-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .card-title {
      font-size: 1rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge-soft {
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      font-size: .78rem;
      color: var(--muted);
    }

    /* Stats top droite */
    .stats-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: .8rem;
      color: var(--muted);
    }
    .stat-pill {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15,23,42,.9);
    }

    /* Progress bar */
    .progress-bar-wrap {
      margin-top: 8px;
      width: 100%;
      height: 8px;
      border-radius: 999px;
      background: rgba(15,23,42,.9);
      overflow: hidden;
      border: 1px solid var(--border-soft);
    }
    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(135deg, var(--accent), #22c55e);
      transition: width .2s ease;
    }

    /* Audio + question */
    .audio-block {
      margin-top: 14px;
      margin-bottom: 10px;
    }
    .audio-block audio {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: #020617;
    }

    .question-text {
      margin-top: 12px;
      font-size: .95rem;
      line-height: 1.6;
    }

    .options-grid {
      margin-top: 12px;
      display: grid;
      gap: 8px;
    }
    .option-item {
      position: relative;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border-soft);
      background: rgba(15,23,42,.95);
      cursor: pointer;
      font-size: .9rem;
      transition: background .15s ease, border-color .15s ease, transform .07s ease;
    }
    .option-item:hover {
      background: rgba(15,23,42,1);
      transform: translateY(-1px);
    }
    .option-item.selected {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(122,162,255,.6);
    }
    .option-item.correct {
      border-color: var(--good);
      background: rgba(22,163,74,.12);
    }
    .option-item.wrong {
      border-color: var(--bad);
      background: rgba(239,68,68,.12);
    }
    .option-label {
      font-weight: 700;
      margin-right: 6px;
    }

    /* Controls */
    .controls-bar {
      margin-top: 16px;
      padding: 12px 14px 14px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(148,163,184,.45);
      background: radial-gradient(900px 280px at 0 0, rgba(122,162,255,.20), transparent 60%),
                  rgba(15,23,42,.97);
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: flex-start;
    }

    .btn-main {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 11px 20px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15,23,42,.95);
      font-size: .92rem;
      font-weight: 600;
      cursor: pointer;
      min-width: 160px;
    }
    .btn-main.primary {
      background: linear-gradient(135deg, var(--accent), #a78bfa);
      border-color: transparent;
      color: #020617;
      box-shadow: 0 16px 40px rgba(15,23,42,.9);
    }
    .btn-main.secondary {
      border-color: rgba(148,163,184,.7);
    }
    .btn-main.danger {
      border-color: rgba(239,68,68,.8);
      color: #fecaca;
    }
    .btn-main:hover:not(:disabled) {
      filter: brightness(1.06);
      transform: translateY(-1px);
    }
    .btn-main:disabled {
      opacity: .55;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .feedback {
      margin-top: 10px;
      font-size: .88rem;
      color: var(--muted);
    }

    .summary-card {
      margin-top: 16px;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: rgba(15,23,42,.96);
      font-size: .9rem;
    }
    .summary-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 6px;
      font-size: .86rem;
    }
    .summary-pill {
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
    }

    @media (max-width: 640px) {
      .btn-row {
        flex-direction: column;
        align-items: stretch;
      }
      .btn-main {
        width: 100%;
      }
    }

    .lesson-name {
      font-size: .86rem;
      color: var(--muted);
      margin-top: 4px;
    }
  </style>
</head>

<body>
  <div class="page">

    <!-- Top navigation -->
    <div class="top-nav">
      <a href="{% url 'preparation_tests:tef_co' %}" class="btn-nav">‚¨Ö Retour aux cours CO</a>
      <a href="{% url 'preparation_tests:exam_list' %}" class="btn-nav">üìã Tous les examens</a>
    </div>

    <!-- Hero / objectifs -->
    <section class="hero-card">
      <div class="hero-pill">TEF ‚Ä¢ Session d'entra√Ænement ‚Äî Compr√©hension Orale</div>
      <h1 class="hero-title">
        Session CO ‚Äì <span>{{ lesson.title }}</span>
      </h1>
      <p class="hero-sub">
        Tu vas travailler sur les exercices li√©s √† cette le√ßon.
        L‚Äôobjectif est de <strong>t‚Äôentra√Æner √† l‚Äô√©coute active</strong> et de
        <strong>valider ta compr√©hension</strong> avec des QCM corrig√©s en direct.
      </p>
      <p class="lesson-name">
        Le√ßon : {{ lesson.exam.name }} ‚Ä¢ CO ‚Äî mise √† jour le {{ lesson.updated_at|date:"d/m/Y" }}  
        {% if total_exercises %}
          ‚Ä¢ {{ total_exercises }} exercice{{ total_exercises|pluralize:",s" }}
        {% endif %}
      </p>

      <div class="hero-grid">
        <article class="hero-box">
          <h3>üéØ Objectifs d'apprentissage</h3>
          <ul>
            <li>Comprendre le contexte de chaque audio (qui parle, o√π, pourquoi).</li>
            <li>Rep√©rer chiffres, lieux, dates et contraintes importantes.</li>
            <li>Identifier l‚Äôintention du locuteur : demander, proposer, confirmer, refuser‚Ä¶</li>
          </ul>
        </article>
        <article class="hero-box">
          <h3>üß† M√©thode pour cette session</h3>
          <ul>
            <li><strong>√âtape 1</strong> : lance l‚Äôaudio, lis bien la question.</li>
            <li><strong>√âtape 2</strong> : choisis une option puis valide.</li>
            <li><strong>√âtape 3</strong> : lis la correction et passe √† la question suivante.</li>
          </ul>
        </article>
      </div>
    </section>

    <!-- Layout principal -->
    <section class="layout">
      <!-- Colonne principale : session interactive -->
      <article class="card-main">
        <header class="card-title-row">
          <div class="card-title">
            <span>üéß Entra√Ænement CO</span>
          </div>
          <div class="stats-grid">
            <div class="stat-pill">Question <span id="stat-question">0 / 0</span></div>
            <div class="stat-pill">Score : <span id="stat-score">0</span></div>
            <div class="stat-pill">Temps : <span id="stat-time">00:00</span></div>
          </div>
        </header>

        <div class="progress-bar-wrap">
          <div class="progress-bar-fill" id="progress-bar"></div>
        </div>

        <div class="audio-block">
          <audio id="audio" controls></audio>
        </div>

        <div class="question-text" id="question-text">
          Aucune question charg√©e pour le moment.
        </div>

        <div class="options-grid" id="options-grid">
          <!-- options g√©n√©r√©es en JS -->
        </div>

        <!-- BARRE DE CONTR√îLE : BOUTONS + FEEDBACK -->
        <div class="controls-bar">
          <div class="btn-row">
            <button type="button" class="btn-main primary" id="btn-validate">‚úÖ Valider la r√©ponse</button>
            <button type="button" class="btn-main secondary" id="btn-next" disabled>‚û° Question suivante</button>
            <button type="button" class="btn-main danger" id="btn-restart">‚Üª Recommencer la session</button>
          </div>

          <div class="feedback" id="feedback"></div>

          <div class="summary-card" id="summary" style="display:none;">
            <strong>R√©sum√© de ta session</strong>
            <div class="summary-row">
              <div class="summary-pill">Score : <span id="sum-score"></span></div>
              <div class="summary-pill">Questions : <span id="sum-questions"></span></div>
              <div class="summary-pill">Temps total : <span id="sum-time"></span></div>
            </div>
            <p id="sum-message" style="margin-top:8px;"></p>
          </div>
        </div>
      </article>

      <!-- Colonne droite : strat√©gies / conseils -->
      <aside class="card-side">
        <div class="side-section">
          <h3>üîç Strat√©gies d'√©coute</h3>
          <ul>
            <li>Identifie le type de situation (annonce, appel, RDV, service client‚Ä¶).</li>
            <li>Rep√®re les mots-cl√©s : heures, montants, lieux, contraintes.</li>
            <li>√âcoute les verbes d‚Äôaction : reporter, annuler, confirmer, proposer, accepter‚Ä¶</li>
          </ul>
        </div>

        <div class="side-section">
          <h3>‚ö†Ô∏è Erreurs fr√©quentes</h3>
          <ul>
            <li>Se focaliser sur un seul mot sans comprendre la phrase enti√®re.</li>
            <li>Confondre une intention (proposer) avec une autre (demander, refuser).</li>
            <li>Choisir une option trop g√©n√©rale alors que l‚Äôaudio est pr√©cis.</li>
          </ul>
        </div>

        <div class="side-section">
          <h3>üí° Conseils pratiques</h3>
          <ul>
            <li>Lis bien la question avant de lancer l‚Äôaudio.</li>
            <li>Essaie de reformuler mentalement la situation apr√®s l‚Äô√©coute.</li>
            <li>Si tu h√©sites, √©limine d‚Äôabord l‚Äôoption clairement fausse.</li>
          </ul>
        </div>
      </aside>
    </section>
  </div>

  <script>
    const EXERCISES = JSON.parse('{{ exercises_json|escapejs }}');

    let currentIndex = 0;
    let selectedOption = null;
    let answeredCount = 0;
    let correctCount = 0;
    let timerSeconds = 0;
    let timerHandle = null;
    let sessionFinished = false;

    const audioEl = document.getElementById('audio');
    const questionTextEl = document.getElementById('question-text');
    const optionsGridEl = document.getElementById('options-grid');
    const feedbackEl = document.getElementById('feedback');
    const progressBarEl = document.getElementById('progress-bar');

    const statQuestionEl = document.getElementById('stat-question');
    const statScoreEl = document.getElementById('stat-score');
    const statTimeEl = document.getElementById('stat-time');

    const btnValidate = document.getElementById('btn-validate');
    const btnNext = document.getElementById('btn-next');
    const btnRestart = document.getElementById('btn-restart');

    const summaryCard = document.getElementById('summary');
    const sumScoreEl = document.getElementById('sum-score');
    const sumQuestionsEl = document.getElementById('sum-questions');
    const sumTimeEl = document.getElementById('sum-time');
    const sumMessageEl = document.getElementById('sum-message');

    function startTimer() {
      if (timerHandle) clearInterval(timerHandle);
      timerHandle = setInterval(() => {
        timerSeconds++;
        updateTimeDisplay();
      }, 1000);
    }

    function resetTimer() {
      if (timerHandle) clearInterval(timerHandle);
      timerSeconds = 0;
      updateTimeDisplay();
    }

    function formatTime(sec) {
      const m = String(Math.floor(sec / 60)).padStart(2, '0');
      const s = String(sec % 60).padStart(2, '0');
      return `${m}:${s}`;
    }

    function updateTimeDisplay() {
      statTimeEl.textContent = formatTime(timerSeconds);
    }

    function initSession() {
      currentIndex = 0;
      selectedOption = null;
      answeredCount = 0;
      correctCount = 0;
      sessionFinished = false;

      feedbackEl.textContent = '';
      summaryCard.style.display = 'none';

      statScoreEl.textContent = '0';
      statQuestionEl.textContent = `0 / ${EXERCISES.length}`;
      updateProgress();

      if (EXERCISES.length === 0) {
        questionTextEl.textContent = "Aucun exercice n'est encore configur√© pour cette le√ßon.";
        btnValidate.disabled = true;
        btnNext.disabled = true;
        return;
      }

      loadCurrentExercise();
      resetTimer();
      startTimer();
    }

    function loadCurrentExercise() {
      const ex = EXERCISES[currentIndex];

      audioEl.src = ex.audio_url || '';
      questionTextEl.textContent = ex.question || '';
      feedbackEl.textContent = '';
      selectedOption = null;

      statQuestionEl.textContent = `${currentIndex + 1} / ${EXERCISES.length}`;
      updateProgress();

      optionsGridEl.innerHTML = '';
      Object.entries(ex.options).forEach(([key, label]) => {
        const div = document.createElement('div');
        div.className = 'option-item';
        div.dataset.key = key;
        div.innerHTML = `<span class="option-label">${key}.</span> ${label}`;
        div.addEventListener('click', () => {
          if (sessionFinished) return;
          if (btnNext.disabled === false) return;
          selectedOption = key;
          document.querySelectorAll('.option-item').forEach(o => o.classList.remove('selected'));
          div.classList.add('selected');
        });
        optionsGridEl.appendChild(div);
      });

      btnValidate.disabled = false;
      btnNext.disabled = true;
    }

    function updateProgress() {
      if (EXERCISES.length === 0) {
        progressBarEl.style.width = '0%';
        return;
      }
      const pct = ((currentIndex) / EXERCISES.length) * 100;
      progressBarEl.style.width = pct + '%';
    }

    function handleValidate() {
      if (sessionFinished) return;

      const ex = EXERCISES[currentIndex];

      if (!selectedOption) {
        feedbackEl.textContent = "Choisis une option avant de valider.";
        return;
      }

      answeredCount++;

      document.querySelectorAll('.option-item').forEach(o => {
        const key = o.dataset.key;
        o.classList.remove('selected');
        if (key === ex.correct) {
          o.classList.add('correct');
        }
        if (key === selectedOption && key !== ex.correct) {
          o.classList.add('wrong');
        }
      });

      if (selectedOption === ex.correct) {
        correctCount++;
        feedbackEl.innerHTML = "‚úÖ Bonne r√©ponse. " + (ex.explanation || "");
      } else {
        feedbackEl.innerHTML = `‚ùå Mauvaise r√©ponse. La bonne r√©ponse √©tait <strong>${ex.correct}</strong>. ` +
          (ex.explanation || "");
      }

      statScoreEl.textContent = correctCount.toString();

      btnValidate.disabled = true;
      const isLast = currentIndex >= EXERCISES.length - 1;
      btnNext.disabled = isLast;

      if (isLast) {
        finishSession();
      }
    }

    function handleNext() {
      if (sessionFinished) return;
      if (currentIndex < EXERCISES.length - 1) {
        currentIndex++;
        loadCurrentExercise();
      }
    }

    function finishSession() {
      sessionFinished = true;
      if (timerHandle) clearInterval(timerHandle);

      progressBarEl.style.width = '100%';

      const total = EXERCISES.length;
      const pct = total ? Math.round((correctCount / total) * 100) : 0;

      sumScoreEl.textContent = `${correctCount} / ${total} (${pct}%)`;
      sumQuestionsEl.textContent = `${answeredCount} / ${total}`;
      sumTimeEl.textContent = formatTime(timerSeconds);

      let msg = "";
      if (pct >= 80) {
        msg = "Excellent niveau sur cette le√ßon. Tu peux passer aux le√ßons suivantes ou augmenter la difficult√©.";
      } else if (pct >= 60) {
        msg = "Bon niveau. Refais la session ou retravaille la le√ßon pour viser au-dessus de 80%.";
      } else {
        msg = "Continue √† t‚Äôentra√Æner : reprends la le√ßon, r√©√©coute les audios et concentre-toi sur les mots-cl√©s.";
      }

      sumMessageEl.textContent = msg;
      summaryCard.style.display = 'block';
    }

    btnValidate.addEventListener('click', handleValidate);
    btnNext.addEventListener('click', handleNext);
    btnRestart.addEventListener('click', initSession);

    document.addEventListener('DOMContentLoaded', initSession);
  </script>
</body>
</html>
