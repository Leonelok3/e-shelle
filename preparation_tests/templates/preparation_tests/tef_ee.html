{% load static %}
{# tef_ee.html (page cours + atelier EE) #}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>TEF ‚Äî Cours EE (Expression √âcrite)</title>
  <meta name="description" content="TEF ‚Äî Cours EE : mod√®les, structure, connecteurs, bar√®me. Atelier interactif avec plan, compteur, analyse automatique et export PDF." />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SEO / Social -->
  <meta property="og:title" content="TEF ‚Äî Cours EE (Expression √âcrite)" />
  <meta property="og:description" content="Atelier guid√© TEF Expression √âcrite : mod√®les, structure, connecteurs, analyse automatique et export PDF." />
  <meta property="og:image" content="{% static 'img/tef-ee-cover.jpg' %}" />
  <meta property="og:url" content="https://www.immigration97.com/prep/fr/tef/ee" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="TEF ‚Äî Cours EE (Expression √âcrite)" />
  <meta name="twitter:description" content="Atelier guid√© TEF Expression √âcrite : mod√®les, structure, connecteurs, analyse automatique et export PDF." />
  <meta name="twitter:image" content="{% static 'img/tef-ee-cover.jpg' %}" />

  <style>
    /* ============================================
       üé® THEME GLOBAL (align√© CO / CE)
       ============================================ */
    :root{
      --bg:#050816;
      --grad1:#0f2027;--grad2:#203a43;--grad3:#2c5364;
      --panel:rgba(255,255,255,.06);
      --panel2:rgba(255,255,255,.10);
      --stroke:rgba(255,255,255,.14);
      --muted:#b9c6d3;
      --accent:#7aa2ff;
      --hot:#a78bfa;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --br:18px;
      --shadow:0 18px 45px rgba(0,0,0,.55);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}

    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 10% -10%,rgba(122,162,255,.18),transparent 60%),
        radial-gradient(900px 480px at 110% 0,rgba(167,139,250,.22),transparent 60%),
        linear-gradient(135deg,var(--grad1),var(--grad2) 50%,var(--grad3));
      color:#fff;
      overflow-x:hidden;
    }

    .container{
      max-width:1180px;
      margin:0 auto;
      padding:26px 18px 32px;
    }

    .small{color:var(--muted);font-size:.94rem}
    .muted{color:var(--muted);}
    h1{font-size:1.9rem;margin:10px 0}
    h2{font-size:1.35rem;margin:10px 0}

    /* ============================================
       üîù HEADER STICKY (logo + onglets)
       ============================================ */
    .sticky{
      position:sticky;
      top:0;
      z-index:30;
      backdrop-filter:blur(14px);
      background:linear-gradient(180deg,rgba(4,10,18,.92),rgba(4,10,18,.55));
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .topbar{
      max-width:1180px;
      margin:0 auto;
      padding:10px 18px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:14px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .brand-logo{
      width:40px;
      height:40px;
      border-radius:14px;
      background:#020617;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .brand-logo img{
      max-width:140%;
      height:auto;
      display:block;
    }
    .brand-title{
      font-weight:700;
      font-size:.95rem;
      letter-spacing:.04em;
    }

    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .tab{
      padding:8px 16px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(15,23,42,.85);
      color:#e5ecff;
      font-size:.92rem;
      font-weight:700;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      transition:background .15s ease,transform .12s ease,box-shadow .15s ease;
    }
    .tab:hover{
      background:rgba(30,64,175,.9);
      box-shadow:0 12px 30px rgba(15,23,42,.55);
      transform:translateY(-1px);
    }
    .tab.active{
      background:linear-gradient(135deg,var(--accent),var(--hot));
      border-color:transparent;
      color:#fff;
    }

    /* ============================================
       üîò BOUTONS GLOBAUX
       ============================================ */
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 16px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:var(--panel);
      color:#fff;
      text-decoration:none;
      font-weight:700;
      cursor:pointer;
      transition:background .18s ease,transform .12s ease,box-shadow .18s ease;
    }
    .btn:hover{
      background:var(--panel2);
      transform:translateY(-1px);
      box-shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .btn-primary{
      background:linear-gradient(135deg,var(--accent),var(--hot));
      border-color:transparent;
    }
    .btn-primary:hover{filter:brightness(1.07);}
    .btn-soft{
      background:rgba(15,23,42,.8);
    }

    /* ============================================
       üßä CARTES / GRIDS
       ============================================ */
    .hero{
      margin-top:18px;
    }
    .hero-card{
      background:radial-gradient(900px 260px at 10% 0,rgba(122,162,255,.20),transparent 60%),
                 radial-gradient(900px 260px at 100% 0,rgba(167,139,250,.24),transparent 60%),
                 linear-gradient(145deg,rgba(15,23,42,.96),rgba(15,23,42,.92));
      border-radius:24px;
      border:1px solid rgba(148,163,184,.45);
      box-shadow:var(--shadow);
      padding:22px 22px 20px;
    }
    .hero-top{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:16px;
      margin-bottom:12px;
    }
    .hero-title{
      font-size:1.65rem;
      font-weight:800;
    }
    .hero-badge{
      font-size:.8rem;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
      margin-bottom:6px;
    }
    .hero-actions{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:flex-end;
    }
    .hero-actions .btn{
      width:100%;
      justify-content:center;
    }
    .hero-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:14px;
      margin-top:14px;
    }
    .hero-col{
      background:rgba(15,23,42,.86);
      border-radius:18px;
      border:1px solid rgba(148,163,184,.35);
      padding:12px 14px;
      font-size:.93rem;
    }
    .hero-col h3{
      margin:0 0 6px;
      font-size:1rem;
    }
    .tag{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.6);
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.09em;
      color:var(--muted);
      margin-left:6px;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:18px;
      margin-top:18px;
    }
    .card{
      background:linear-gradient(145deg,rgba(15,23,42,.96),rgba(15,23,42,.9));
      border-radius:var(--br);
      border:1px solid var(--stroke);
      padding:18px;
      position:relative;
      overflow:hidden;
      box-shadow:var(--shadow);
      animation:pop .45s ease forwards;
      opacity:0;
      transform:translateY(12px);
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:inherit;
      background:radial-gradient(500px 140px at 12% -10%,rgba(122,162,255,.16),transparent 60%);
      pointer-events:none;
    }
    .card h3{margin:0 0 8px;font-size:1.08rem;position:relative;z-index:1}
    .card p,.card ul{position:relative;z-index:1}
    ul{margin:8px 0 0 18px}
    .pill{
      display:inline-block;
      background:rgba(15,23,42,.9);
      border:1px solid var(--stroke);
      padding:6px 10px;
      border-radius:999px;
      font-size:.88rem;
      margin:4px 6px 0 0;
    }

    @keyframes pop{to{opacity:1;transform:none}}
    .card:nth-child(1){animation-delay:.04s}
    .card:nth-child(2){animation-delay:.08s}
    .card:nth-child(3){animation-delay:.12s}
    .card:nth-child(4){animation-delay:.16s}

    /* ============================================
       üìö LE√áONS DYNAMIQUES
       ============================================ */
    .lessons-section{
      margin-top:30px;
      padding-top:22px;
      border-top:1px solid rgba(148,163,184,.4);
    }
    .lessons-header{
      text-align:center;
      margin-bottom:18px;
    }
    .lessons-header h2{
      font-size:1.5rem;
      margin-bottom:4px;
      background:linear-gradient(135deg,var(--accent),var(--hot));
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .lesson-card{
      background:linear-gradient(145deg,rgba(15,23,42,.97),rgba(15,23,42,.92));
      border-radius:22px;
      border:1px solid var(--stroke);
      padding:18px 18px 16px;
      position:relative;
      overflow:hidden;
      box-shadow:var(--shadow);
    }
    .lesson-card::before{
      content:"";
      position:absolute;
      inset:-1px;
      border-radius:inherit;
      background:radial-gradient(520px 150px at 8% -10%,rgba(167,139,250,.22),transparent 60%);
      pointer-events:none;
    }
    .lesson-card h3{
      margin:0 0 8px;
      font-size:1.1rem;
      position:relative;
      z-index:1;
    }
    .lesson-meta{
      font-size:.82rem;
      color:var(--muted);
      margin-bottom:10px;
      display:flex;
      align-items:center;
      gap:8px;
      position:relative;
      z-index:1;
    }
    .lesson-meta::before{content:"üìÖ";}
    .badge-new{
      display:inline-block;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#fff;
      font-size:.75rem;
      font-weight:700;
      padding:3px 8px;
      border-radius:999px;
      margin-left:8px;
      box-shadow:0 2px 8px rgba(34,197,94,.4);
    }
    .text-body{
      position:relative;
      z-index:1;
      line-height:1.7;
      color:#e0e7ff;
      font-size:.95rem;
    }
    .text-body p{margin:8px 0}
    .text-body ul,.text-body ol{margin:8px 0 8px 20px}
    .text-body strong{color:#fff}
    .text-body em{color:var(--hot)}
    .text-body a{color:var(--accent);text-decoration:underline;}
    .text-body a:hover{color:var(--hot);}
    .text-body audio,.text-body iframe{max-width:100%;border-radius:12px;margin:10px 0;}

    /* ============================================
       üß™ ATELIER INTERACTIF EE
       ============================================ */
    .workshop-section{
      margin-top:32px;
    }
    .workshop-grid{
      display:grid;
      grid-template-columns:1.05fr 1.35fr;
      gap:18px;
    }
    @media (max-width:980px){
      .workshop-grid{grid-template-columns:1fr;}
      .hero-top{flex-direction:column;align-items:flex-start;}
      .hero-actions{align-items:flex-start;width:100%;}
      .hero-actions .btn{width:100%;}
    }

    .row{display:flex;gap:8px;flex-wrap:wrap;}
    .input,.select,.textarea{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(15,23,42,.9);
      color:#e5ecff;
      font-size:.93rem;
    }
    .textarea{min-height:170px;resize:vertical;}
    .select{appearance:none;-webkit-appearance:none;}
    .preview{
      min-height:150px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(15,23,42,.9);
      padding:10px 12px;
      white-space:pre-wrap;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:7px 11px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:rgba(15,23,42,.9);
      font-size:.82rem;
      font-weight:700;
    }

    .checklist{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:8px;
      margin-top:8px;
    }
    .check{
      display:flex;
      gap:8px;
      align-items:flex-start;
      padding:8px 10px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(15,23,42,.92);
      font-size:.9rem;
    }
    .check input{margin-top:3px;}

    .metrics{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(170px,1fr));
      gap:10px;
      margin-top:10px;
    }
    .metric{
      border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(15,23,42,.94);
      padding:8px 10px;
    }
    .metric b{font-size:1.05rem;}

    /* FOOTER */
    .footer-nav{
      margin-top:26px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .footer-bottom{
      text-align:center;
      margin-top:18px;
      font-size:.8rem;
      color:var(--muted);
    }

    @media print{
      body{background:#fff;color:#000;}
      .sticky,.footer-nav,.footer-bottom,.no-print{display:none!important;}
      .card,.lesson-card{box-shadow:none;border:1px solid #000;background:#fff;color:#000;}
      .text-body a{color:#000;}
    }
  </style>
</head>
<body>
  <!-- ============================================
       üîù HEADER
       ============================================ -->
  <header class="sticky no-print">
    <div class="topbar">
      <div class="brand">
        <div class="brand-logo">
          <img src="{% static 'logo e-shelle ton futur sans limite.jpg' %}" alt="E-SHELLE" />
        </div>
        <div>
          <div class="brand-title">IMMIGRATION97 ‚Ä¢ PR√âPARATION TEF</div>
          <div class="small">Expression √âcrite (EE)</div>
        </div>
      </div>
      <nav class="tabs" aria-label="Navigation TEF">
        <span class="tab active">üìö Cours</span>
        <a class="tab" href="{% url 'preparation_tests:tef_hub' %}#train">üß™ Entra√Ænements</a>
        <a class="tab" href="{% url 'preparation_tests:tef_hub' %}#tips">üß≠ Conseils &amp; bar√®mes</a>
        <a class="tab" href="{% url 'preparation_tests:tef_hub' %}#res">üóÇÔ∏è Ressources</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Lien retour -->
    <div class="no-print" style="margin-top:10px;margin-bottom:8px;">
      <!-- Quick Navigation Cours directs -->
    <div class="mb-4" style="display:flex;flex-wrap:wrap;gap:8px;">
      <a class="btn btn-ghost btn-sm" href="{% url 'preparation_tests:tef_co' %}">üéß Cours CO</a>
      <a class="btn btn-ghost btn-sm" href="{% url 'preparation_tests:tef_ce' %}">üìñ Cours CE</a>
      <a class="btn btn-ghost btn-sm" href="{% url 'preparation_tests:tef_ee' %}">‚úçÔ∏è Cours EE</a>
      <a class="btn btn-ghost btn-sm" href="{% url 'preparation_tests:tef_eo' %}">üé§ Cours EO</a>
    </div>
    
    </div>

    <!-- ============================================
         üßä HERO : r√©sum√© du cours EE
         ============================================ -->
    <section class="hero">
      <article class="hero-card">
        <div class="hero-top">
          <div>
            <div class="hero-badge">TEF ‚Ä¢ EXPRESSION √âCRITE</div>
            <h1 class="hero-title">Cours ‚Äì <span style="color:var(--hot)">Expression √âcrite</span></h1>
            <p class="small" style="max-width:520px;margin-top:6px;">
              Atelier complet pour r√©ussir l‚ÄôEE du TEF : mod√®les pr√™ts √† l‚Äôemploi, structure claire,
              connecteurs efficaces, gestion de la longueur et relecture strat√©gique.
            </p>
          </div>
          <div class="hero-actions no-print">
            <a class="btn btn-primary" href="{% url 'preparation_tests:start_session' 'tef' %}?section=ee">
              ‚úçÔ∏è Commencer une session EE
            </a>
            <a class="btn btn-soft" href="{% url 'preparation_tests:exam_detail' 'tef' %}#writing">
              üìÑ Voir le format officiel TEF
            </a>
          </div>
        </div>

        <div class="hero-grid">
          <div class="hero-col">
            <h3>Ce que tu dois ma√Ætriser <span class="tag">Objectifs</span></h3>
            <ul>
              <li>Respecter la consigne (type, destinataire, ton).</li>
              <li>Organiser ton texte : intro ‚Üí 2 id√©es ‚Üí conclusion.</li>
              <li>Utiliser des connecteurs logiques vari√©s.</li>
              <li>Produire ~120‚Äì180 mots, avec un fran√ßais clair.</li>
            </ul>
          </div>
          <div class="hero-col">
            <h3>Avant / pendant / apr√®s √©crire <span class="tag">M√©thode</span></h3>
            <ul>
              <li><strong>Avant</strong> : analyser la consigne, rep√©rer les points √† traiter.</li>
              <li><strong>Pendant</strong> : suivre ton plan, d√©velopper 2 id√©es avec exemples.</li>
              <li><strong>Apr√®s</strong> : v√©rifier longueur, accords, temps, pronoms, connecteurs.</li>
            </ul>
          </div>
          <div class="hero-col">
            <h3>Pi√®ges fr√©quents en EE <span class="tag">Pi√®ges EE</span></h3>
            <ul>
              <li>Texte trop court ou hors-sujet.</li>
              <li>Ne pas r√©pondre √† tous les √©l√©ments de la consigne.</li>
              <li>Ton inadapt√© (trop familier avec une administration).</li>
              <li>Peu de connecteurs, phrases trop longues ou trop hach√©es.</li>
            </ul>
          </div>
        </div>
      </article>
    </section>

    <!-- ============================================
         üìö LE√áONS DYNAMIQUES
         ============================================ -->
    {% if lessons %}
      <section class="lessons-section">
        <div class="lessons-header">
          <h2>üìñ Cours complets ‚Äî Expression √âcrite</h2>
          <p class="small">
            Utilise ces le√ßons comme mini-chapitres : m√©thode, exemples guid√©s, puis quiz/application.
            Niveau conseill√© : B1‚ÄìC1.
          </p>
        </div>

        <div class="grid">
          {% for l in lessons %}
            <article class="lesson-card">
              <h3>
                {{ l.title }}
                {% if forloop.first %}
                  <span class="badge-new">Nouveau</span>
                {% endif %}
              </h3>
              <div class="lesson-meta">
                Mise √† jour : {{ l.updated_at|date:"d/m/Y √† H:i" }}
              </div>
              <div class="text-body">
                {{ l.content_html|safe }}
              </div>

              <!-- Bouton session d'exercices EE pour cette le√ßon -->
              <div style="margin-top: 14px; display: flex; justify-content: flex-end; position:relative; z-index:1;">
                <a href="{% url 'preparation_tests:lesson_session_ee' l.id %}" class="btn btn-primary">
                  üöÄ Lancer la session d'exercices EE
                </a>
              </div>
            </article>
          {% endfor %}
        </div>
      </section>
    {% else %}
      <section class="lessons-section">
        <div class="lesson-card">
          <h3>üìö Cours √† venir</h3>
          <p class="small">
            Les le√ßons d√©taill√©es d‚ÄôExpression √âcrite seront ajout√©es tr√®s bient√¥t.
            En attendant, tu peux utiliser l‚Äôatelier interactif ci-dessous pour t‚Äôentra√Æner
            √† structurer et analyser tes productions. ‚úçÔ∏è
          </p>
        </div>
      </section>
    {% endif %}

    <!-- ============================================
         üß™ ATELIER INTERACTIF EE
         ============================================ -->
    <section class="workshop-section">
      <h2>üõ† Atelier guid√© ‚Äî Expression √âcrite (MVP)</h2>
      <p class="small" style="max-width:760px;margin-bottom:10px;">
        Utilise cet atelier comme un coach : pr√©pare ton plan, r√©dige, puis lance l‚Äôanalyse automatique
        (longueur, connecteurs, richesse lexicale, phrases). L‚Äôoption ¬´ Exporter le bilan ¬ª te permet
        d‚Äôimprimer / enregistrer en PDF pour ton suivi.
      </p>

      <div class="workshop-grid">
        <!-- Colonne 1 : Plan / param√®tres -->
        <article class="card">
          <h3>üß† Plan &amp; param√®tres</h3>

          <div class="row" style="margin-top:4px;">
            <div style="flex:1 1 260px;">
              <label for="topic" class="small">Sujet / consigne</label>
              <input id="topic" class="input" placeholder="Ex. : Demander un changement d‚Äôhoraire de cours" />
            </div>
            <div style="flex:1 1 160px;">
              <label for="type" class="small">Type de texte</label>
              <select id="type" class="select">
                <option value="email">Email</option>
                <option value="avis">Avis</option>
                <option value="note">Note</option>
              </select>
            </div>
            <div style="flex:1 1 160px;">
              <label for="tone" class="small">Ton</label>
              <select id="tone" class="select">
                <option value="formel">Formel</option>
                <option value="neutre">Neutre</option>
                <option value="amical">Amical</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label class="small">Connecteurs rapides</label>
            <div class="row" id="connectors" style="margin-top:4px;">
              <button type="button" class="btn btn-soft" data-insert="Premi√®rement, ">Premi√®rement</button>
              <button type="button" class="btn btn-soft" data-insert="D‚Äôune part, ">D‚Äôune part</button>
              <button type="button" class="btn btn-soft" data-insert="Cependant, ">Cependant</button>
              <button type="button" class="btn btn-soft" data-insert="En outre, ">En outre</button>
              <button type="button" class="btn btn-soft" data-insert="Ainsi, ">Ainsi</button>
              <button type="button" class="btn btn-soft" data-insert="En conclusion, ">En conclusion</button>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="plan" class="small">Plan (brouillon rapide)</label>
            <textarea id="plan" class="textarea"
              placeholder="- Intro : ...&#10;- Id√©e 1 : ...&#10;- Id√©e 2 : ...&#10;- Conclusion : ..."></textarea>
          </div>

          <div class="metrics" style="margin-top:10px;">
            <div class="metric">
              <div class="small">Longueur cible</div>
              <b>120‚Äì180</b> <span class="small">mots</span>
            </div>
            <div class="metric">
              <div class="small">Temps conseill√©</div>
              <b>20 min</b>
            </div>
          </div>
        </article>

        <!-- Colonne 2 : R√©daction + analyse -->
        <article class="card">
          <h3>‚úçÔ∏è R√©dige ton texte</h3>

          <label for="text" class="small">Texte final</label>
          <textarea id="text" class="textarea"
            placeholder="R√©dige ici ta production en respectant le type, le ton et la structure."></textarea>

          <div class="row" style="margin-top:6px;">
            <span class="badge" id="wcBadge">Mots : 0</span>
            <span class="badge" id="lenBadge">Longueur : 0 caract√®res</span>
          </div>

          <div style="margin-top:10px;">
            <label class="small">Aper√ßu</label>
            <div id="preview" class="preview small">Pr√©visualisation‚Ä¶</div>
          </div>

          <div class="row" style="margin-top:10px;">
            <button type="button" class="btn btn-soft" id="btnCopy">üìã Copier</button>
            <button type="button" class="btn btn-soft" id="btnTemplate">üßæ Ins√©rer mod√®le</button>
            <button type="button" class="btn btn-soft" id="btnClear">üóë Effacer</button>
            <button type="button" class="btn btn-primary" id="btnAnalyze">üîç Analyser</button>
            <button type="button" class="btn btn-soft no-print" id="btnPdf">üßæ Exporter le bilan (PDF)</button>
          </div>

          <h3 style="margin-top:16px;">‚úÖ Checklist bar√®me</h3>
          <div class="checklist">
            <label class="check"><input type="checkbox" id="chkTask"> <span>Consigne respect√©e (type, destinataire, but).</span></label>
            <label class="check"><input type="checkbox" id="chkCoherence"> <span>Structure claire (intro ‚Üí id√©es ‚Üí conclusion).</span></label>
            <label class="check"><input type="checkbox" id="chkConnectors"> <span>Connecteurs vari√©s et pertinents.</span></label>
            <label class="check"><input type="checkbox" id="chkLex"> <span>Lexique pr√©cis, niveau adapt√©.</span></label>
            <label class="check"><input type="checkbox" id="chkGrammar"> <span>Orthographe / grammaire ma√Ætris√©es.</span></label>
            <label class="check"><input type="checkbox" id="chkLength"> <span>Environ 120‚Äì180 mots.</span></label>
          </div>

          <h3 style="margin-top:16px;">üìä Indicateurs automatiques</h3>
          <div class="metrics">
            <div class="metric"><div>Longueur</div><b id="ee_words">‚Äî</b> <span class="small">mots</span></div>
            <div class="metric"><div>Phrase moyenne</div><b id="ee_avg">‚Äî</b> <span class="small">mots/phrase</span></div>
            <div class="metric"><div>Connecteurs d√©tect√©s</div><b id="ee_conn">‚Äî</b></div>
            <div class="metric"><div>Richesse lexicale</div><b id="ee_ttr">‚Äî</b> <span class="small">type/token</span></div>
            <div class="metric"><div>Score estim√©</div><b id="ee_score">‚Äî</b> <span class="small">/100</span></div>
          </div>

          <div id="ee_tips" class="small" style="margin-top:10px;"></div>
        </article>
      </div>
    </section>

    <!-- NAV / FOOTER -->
    <div class="footer-nav no-print">
      <center><a class="btn btn-soft" href="{% url 'preparation_tests:tef_hub' %}">‚¨Ö Retour Menu  TEF</a></center>
    </div>
    <div class="footer-bottom">
      ¬© 2025 E-SHELLE ‚Äî Pr√©pare ton avenir sans limite.
    </div>
  </main>

  <!-- ============================================
       üß† LOGIQUE JS ATELIER EE
       ============================================ -->
  <script>
    // Helpers
    const $ = (s,p=document)=>p.querySelector(s);
    const $$ = (s,p=document)=>Array.from(p.querySelectorAll(s));

    const text = $('#text');
    const preview = $('#preview');
    const wcBadge = $('#wcBadge');
    const lenBadge = $('#lenBadge');
    const topic = $('#topic');
    const typeSel = $('#type');
    const toneSel = $('#tone');

    const eeWordsEl = $('#ee_words');
    const eeAvgEl = $('#ee_avg');
    const eeConnEl = $('#ee_conn');
    const eeTtrEl = $('#ee_ttr');
    const eeScoreEl = $('#ee_score');
    const eeTipsEl = $('#ee_tips');

    const connectorsList = [
      'premi√®rement','d‚Äôune part',"d'une part",'cependant','en outre','ainsi','en conclusion',
      "tout d'abord","d‚Äôabord","par ailleurs","en revanche"
    ];

    function getWords(str){
      if(!str) return [];
      const m = str.toLowerCase().match(/[a-z√†-√∂√∏-√ø]+/gi);
      return m ? m : [];
    }

    function analyseTexte(){
      const raw = text.value || '';
      const words = getWords(raw);
      const wordCount = words.length;
      const charCount = raw.length;

      wcBadge.textContent = 'Mots : ' + wordCount;
      lenBadge.textContent = 'Longueur : ' + charCount + ' caract√®res';
      preview.textContent = raw.trim() ? raw : 'Pr√©visualisation‚Ä¶';

      if(!wordCount){
        eeWordsEl.textContent = '‚Äî';
        eeAvgEl.textContent = '‚Äî';
        eeConnEl.textContent = '‚Äî';
        eeTtrEl.textContent = '‚Äî';
        eeScoreEl.textContent = '‚Äî';
        eeTipsEl.textContent = '';
        return;
      }

      eeWordsEl.textContent = wordCount;

      const sentences = raw.split(/[.!?]+/).map(s=>s.trim()).filter(Boolean);
      const avg = sentences.length ? wordCount / sentences.length : wordCount;
      eeAvgEl.textContent = avg.toFixed(1);

      const lower = raw.toLowerCase();
      let connCount = 0;
      connectorsList.forEach(c=>{
        const pattern = c.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
        const re = new RegExp('\\b'+pattern+'\\b','gi');
        const matches = lower.match(re);
        if(matches) connCount += matches.length;
      });
      eeConnEl.textContent = connCount;

      const unique = new Set(words.map(w=>w.toLowerCase()));
      const ttr = unique.size / wordCount;
      eeTtrEl.textContent = ttr.toFixed(2);

      let score = 50;

      if(wordCount >= 120 && wordCount <= 180){
        score += 20;
      } else if(wordCount >= 90 && wordCount <= 210){
        score += 10;
      } else {
        score -= 10;
      }

      if(connCount >= 4){
        score += 10;
      } else if(connCount >= 2){
        score += 5;
      } else if(connCount === 0){
        score -= 5;
      }

      if(ttr > 0.55){
        score += 10;
      } else if(ttr > 0.4){
        score += 5;
      } else {
        score -= 5;
      }

      if(avg >= 10 && avg <= 22){
        score += 10;
      } else if(avg < 6 || avg > 28){
        score -= 5;
      }

      score = Math.max(0, Math.min(100, Math.round(score)));
      eeScoreEl.textContent = score;

      const tips = [];

      if(wordCount < 120){
        tips.push('üî∏ Ton texte est un peu court : vise au moins 120 mots.');
      } else if(wordCount > 190){
        tips.push('üî∏ Ton texte est assez long : essaie de rester entre 120 et 180 mots.');
      } else {
        tips.push('‚úÖ Longueur correcte pour le TEF.');
      }

      if(connCount < 2){
        tips.push('üß© Ajoute davantage de connecteurs logiques (par ex. : ¬´ d‚Äôune part ¬ª, ¬´ cependant ¬ª, ¬´ en outre ¬ª).');
      } else if(connCount < 4){
        tips.push('‚úÖ Connecteurs pr√©sents, tu peux encore varier un peu plus.');
      } else {
        tips.push('‚úÖ Tr√®s bonne utilisation des connecteurs.');
      }

      if(ttr < 0.4){
        tips.push('üí° Essaie de varier ton vocabulaire : √©vite de r√©p√©ter trop souvent les m√™mes mots.');
      } else if(ttr > 0.6){
        tips.push('‚úÖ Vocabulaire vari√©, c‚Äôest un bon point pour le bar√®me.');
      }

      if(avg < 8){
        tips.push('‚úèÔ∏è Tes phrases sont tr√®s courtes : combine certaines phrases avec des connecteurs.');
      } else if(avg > 25){
        tips.push('‚úèÔ∏è Tes phrases sont tr√®s longues : pense √† les couper pour plus de clart√©.');
      }

      eeTipsEl.innerHTML = tips.join('<br>');
    }

    // Insertion connecteurs
    $$('#connectors button').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const insert = btn.getAttribute('data-insert') || '';
        const el = text;
        const start = el.selectionStart ?? el.value.length;
        const end = el.selectionEnd ?? start;
        const before = el.value.slice(0,start);
        const after = el.value.slice(end);
        el.value = before + insert + after;
        const pos = start + insert.length;
        el.focus();
        try{ el.setSelectionRange(pos,pos); }catch(e){}
        analyseTexte();
      });
    });

    function buildTemplate(){
      const t = typeSel.value;
      const tone = toneSel.value;
      const sujet = (topic.value || 'le sujet demand√©').toLowerCase();

      let formuleDebut = 'Madame, Monsieur,';
      let formuleFin = 'Je vous prie d‚Äôagr√©er, Madame, Monsieur, l‚Äôexpression de mes salutations distingu√©es.';
      if(tone === 'amical'){
        formuleDebut = 'Salut,';
        formuleFin = '√Ä bient√¥t,';
      } else if(tone === 'neutre'){
        formuleDebut = 'Bonjour,';
        formuleFin = 'Cordialement,';
      }

      if(t === 'email'){
        return `${formuleDebut}

Je me permets de vous √©crire au sujet de ${sujet}. 

Premi√®rement, ...
En outre, ...

En conclusion, je vous remercie par avance pour votre aide et reste √† votre disposition pour toute information compl√©mentaire.

${formuleFin}
`;
      }

      if(t === 'avis'){
        return `Bonjour,

Je souhaite donner mon avis √† propos de ${sujet}.

Premi√®rement, ...
D‚Äôune part, ...
Cependant, ...

En conclusion, je pense que ...

${formuleFin}
`;
      }

      // NOTE
      return `NOTE

Objet : ${sujet}

Premi√®rement, ...
En outre, ...

Merci de respecter ces consignes avant la date indiqu√©e.

${formuleFin}
`;
    }

    $('#btnTemplate').addEventListener('click',()=>{
      text.value = buildTemplate();
      analyseTexte();
    });

    $('#btnClear').addEventListener('click',()=>{
      text.value = '';
      analyseTexte();
    });

    $('#btnCopy').addEventListener('click',()=>{
      const val = text.value;
      if(!val) return;
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(val).catch(()=>{});
      }else{
        const tmp = document.createElement('textarea');
        tmp.value = val;
        document.body.appendChild(tmp);
        tmp.select();
        try{ document.execCommand('copy'); }catch(e){}
        document.body.removeChild(tmp);
      }
    });

    $('#btnAnalyze').addEventListener('click',()=>{
      analyseTexte();
      eeTipsEl.scrollIntoView({behavior:'smooth',block:'start'});
    });

    $('#btnPdf').addEventListener('click',()=>{
      window.print();
    });

    text.addEventListener('input',analyseTexte);
    analyseTexte();
  </script>
</body>
</html>
