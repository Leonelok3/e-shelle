{% extends "base.html" %}
{% load static %}

{% block body_class %}visa-travail{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/visa_travail.css' %}">
{% endblock %}

{% block content %}
<section class="vt-plan">

  <div class="container">

    <!-- ================= HEADER ================= -->
    <section class="vt-card vt-plan-header vt-fade-up">

      <span class="vt-badge">
        <i class="bi bi-graph-up-arrow"></i>
        Tableau de pilotage Visa Travail
      </span>

      <h1 class="vt-title">
        Ton
        <span class="vt-gradient-primary">plan d’action personnalisé</span>
      </h1>

      <p class="vt-subtle">
        Suis un parcours clair, structuré et priorisé pour
        <strong>travailler légalement à l’étranger</strong>.
        Chaque étape est pensée pour maximiser
        tes chances de succès.
      </p>

      <!-- ================= PROGRESSION ================= -->
      <div class="vt-progress-box">
        <div>
          <span class="vt-label">Progression globale</span>
          <strong>{{ done_steps }} / {{ total_steps }} étapes</strong>
        </div>

        <div>
          <span class="vt-label">Avancement</span>
          <strong>{{ progress_percent }} %</strong>
        </div>

        <span class="vt-badge-soft">
          {{ progress_label }}
        </span>
      </div>

      <!-- ================= BARRE ================= -->
      <div class="vt-progress-bar">
        <div class="vt-progress-fill" style="width: {{ progress_percent }}%"></div>
      </div>

    </section>

    <!-- ================= COACH ================= -->
    <section class="vt-card vt-coach-box vt-fade-up">
      <div class="vt-coach-header">
        <div>
          <span class="vt-coach-label">Coach Visa Travail</span>
          <h2>{{ coach_title }}</h2>
        </div>

        <span class="vt-badge">
          <i class="bi bi-geo-alt"></i>
          Pays prioritaire : {{ pays_prioritaire }}
        </span>
      </div>

      <p class="vt-subtle">
        {{ coach_message }}
      </p>
    </section>

    <!-- ================= ACTIONS RAPIDES ================= -->
    <section class="vt-card vt-actions-grid vt-fade-up">

      <a href="{% url 'visa_travail:export_plan_pdf' profile.id %}"
         class="vt-btn-secondary">
        <i class="bi bi-filetype-pdf"></i>
        Télécharger le plan PDF
      </a>

      <a href="{% url 'visa_travail:job_list' profile.id %}"
         class="vt-btn-secondary">
        <i class="bi bi-clipboard-check"></i>
        Suivi des candidatures
      </a>

      <a href="{% url 'visa_travail:job_offers_list' %}"
         class="vt-btn-secondary">
        <i class="bi bi-briefcase"></i>
        Offres d’emploi
      </a>

      <a href="{% url 'visa_travail:coach_cv' %}"
         class="vt-btn-secondary">
        <i class="bi bi-file-earmark-text"></i>
        Optimiser mon CV
      </a>

      <a href="{% url 'visa_travail:job_offers_list' %}?profile={{ profile.id }}"
         class="vt-btn-primary">
        <i class="bi bi-star"></i>
        Offres compatibles avec mon profil
      </a>

    </section>

    <!-- ================= INFOS PROFIL ================= -->
    <section class="vt-card vt-profile-summary vt-fade-up">
      <h2 class="vt-section-title">
        <i class="bi bi-person-check"></i>
        Rappel de ton profil
      </h2>

      <div class="vt-profile-grid">
        <div><span>Pays ciblés</span><strong>{{ profile.pays_cibles }}</strong></div>
        <div><span>Domaine</span><strong>{{ profile.domaine_metier }}</strong></div>
        <div><span>Horizon</span><strong>{{ profile.get_horizon_depart_display }}</strong></div>
      </div>
    </section>

    <!-- ================= LÉGENDE ================= -->
    <div class="vt-status-legend">
      <span class="status-badge-timeline afaire">À faire</span>
      <span class="status-badge-timeline encours">En cours</span>
      <span class="status-badge-timeline termine">Terminé</span>
    </div>

    <!-- ================= TIMELINE ================= -->
    {% if profile.actions.all %}
      <section class="vt-card vt-timeline vt-fade-up">

        <h2 class="vt-section-title">
          <i class="bi bi-list-check"></i>
          Étapes clés du projet
        </h2>

        {% for step in profile.actions.all %}
          <div class="vt-timeline-item">

            <div class="vt-timeline-index">
              {{ forloop.counter }}
            </div>

            <div class="vt-timeline-content">
              <h3>{{ step.titre }}</h3>
              {% if step.description %}
                <p class="vt-subtle">{{ step.description }}</p>
              {% endif %}
            </div>

            <div class="vt-timeline-status">

              {% if step.statut == "A_FAIRE" %}
                <span class="status-badge-timeline afaire">À faire</span>
              {% elif step.statut == "EN_COURS" %}
                <span class="status-badge-timeline encours">En cours</span>
              {% else %}
                <span class="status-badge-timeline termine">Terminé</span>
              {% endif %}

              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="step_id" value="{{ step.id }}">

                <select name="statut" class="vt-select">
                  <option value="A_FAIRE" {% if step.statut == "A_FAIRE" %}selected{% endif %}>À faire</option>
                  <option value="EN_COURS" {% if step.statut == "EN_COURS" %}selected{% endif %}>En cours</option>
                  <option value="TERMINE" {% if step.statut == "TERMINE" %}selected{% endif %}>Terminé</option>
                </select>

                <button type="submit" class="vt-btn-soft">
                  Mettre à jour
                </button>
              </form>

            </div>

          </div>
        {% endfor %}
      </section>
    {% else %}
      <div class="vt-alert-warning">
        Aucun plan d’action n’a encore été généré pour ce profil.
      </div>
    {% endif %}

  </div>
</section>
{% endblock %}
