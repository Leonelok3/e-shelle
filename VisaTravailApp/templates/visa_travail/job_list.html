{% extends "base.html" %}
{% load static %}

{% block body_class %}visa-travail{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/visa_travail.css' %}">
{% endblock %}

{% block content %}
<section class="vt-job-tracker">

  <div class="container">

    <!-- ==================================================
         HEADER
    =================================================== -->
    <header class="vt-card vt-fade-up vt-job-tracker-header">

      <span class="vt-badge">
        <i class="bi bi-clipboard-check"></i>
        Suivi des candidatures Visa Travail
      </span>

      <h1 class="vt-title">
        Candidatures —
        <span class="vt-gradient-primary">
          {{ profile.nom|default:"ton profil" }}
        </span>
      </h1>

      <p class="vt-subtle">
        Centralise, analyse et optimise toutes tes
        <strong>candidatures à l’international</strong>
        afin d’augmenter concrètement
        tes chances d’obtenir un
        <strong>visa travail légal</strong>.
      </p>

      <div class="vt-cta-group">
        <a href="{% url 'visa_travail:job_create' profile.id %}"
           class="vt-btn-primary">
          <i class="bi bi-plus-circle"></i>
          Ajouter une candidature
        </a>

        <a href="{% url 'visa_travail:job_offers_list' %}"
           class="vt-btn-secondary">
          <i class="bi bi-briefcase"></i>
          Explorer les offres
        </a>
      </div>

    </header>

    <!-- ==================================================
         INDICATEURS CLÉS
    =================================================== -->
    <section class="vt-kpi-grid vt-fade-up">

      <div class="vt-kpi">
        <span>Total candidatures</span>
        <strong>{{ total }}</strong>
        <small>
          {% if last_30_days_count %}
            {{ last_30_days_count }} sur 30 jours
          {% else %}
            Aucune récente
          {% endif %}
        </small>
      </div>

      <div class="vt-kpi">
        <span>Candidatures actives</span>
        <strong>{{ active }}</strong>
        <small>Envoyées & entretiens</small>
      </div>

      <div class="vt-kpi">
        <span>À postuler</span>
        <strong>{{ count_a_postuler }}</strong>
        <small>À planifier</small>
      </div>

      <div class="vt-kpi">
        <span>Taux de succès</span>
        <strong>{{ success_rate }}%</strong>
        <small>Acceptées</small>
      </div>

    </section>

    <!-- ==================================================
         COACH IA
    =================================================== -->
    <section class="vt-card vt-fade-up">

      <span class="vt-badge">
        <i class="bi bi-robot"></i>
        Coach IA Immigration97
      </span>

      <h2 class="vt-section-title">
        {{ coach.title }}
      </h2>

      <p class="vt-subtle">
        {{ coach.advice }}
      </p>

      <ul class="vt-coach-list">
        {% for step in coach.week_plan %}
          <li>{{ step }}</li>
        {% endfor %}
      </ul>

    </section>

    <!-- ==================================================
         FILTRES
    =================================================== -->
    <section class="vt-card vt-fade-up">

      <h2 class="vt-section-title">
        Filtrer mes candidatures
      </h2>

      <form method="get" class="vt-filter-grid">

        <div class="vt-field">
          <label>Pays ciblé</label>
          <input type="text" name="pays" value="{{ pays }}"
                 class="vt-input"
                 placeholder="Canada, Allemagne…">
        </div>

        <div class="vt-field">
          <label>Statut</label>
          <select name="statut" class="vt-input">
            <option value="">Tous</option>
            <option value="A_POSTULER" {% if statut == "A_POSTULER" %}selected{% endif %}>À postuler</option>
            <option value="ENVOYEE" {% if statut == "ENVOYEE" %}selected{% endif %}>Envoyée</option>
            <option value="ENTRETIEN" {% if statut == "ENTRETIEN" %}selected{% endif %}>Entretien</option>
            <option value="ACCEPTEE" {% if statut == "ACCEPTEE" %}selected{% endif %}>Acceptée</option>
            <option value="REFUSEE" {% if statut == "REFUSEE" %}selected{% endif %}>Refusée</option>
          </select>
        </div>

        <div class="vt-filter-actions">
          <button type="submit" class="vt-btn-primary">
            <i class="bi bi-search"></i>
            Filtrer
          </button>

          <a href="{% url 'visa_travail:job_list' profile.id %}"
             class="vt-btn-secondary">
            Réinitialiser
          </a>
        </div>

      </form>

    </section>

    <!-- ==================================================
         TABLE CANDIDATURES
    =================================================== -->
    <section class="vt-card vt-fade-up">

      {% if applications %}
        <div class="vt-table">

          {% for app in applications %}
            <div class="vt-table-row">

              <div>
                <strong>{{ app.titre_poste }}</strong>
                {% if app.entreprise %}
                  <div class="vt-text-soft">{{ app.entreprise }}</div>
                {% endif %}
              </div>

              <div>{{ app.pays|default:"—" }}</div>

              <div>
                <span class="vt-status {{ app.statut|lower }}">
                  {{ app.get_statut_display }}
                </span>
              </div>

              <div>{{ app.date_candidature|default:"—" }}</div>

              <div class="vt-table-actions">
                <a href="{% url 'visa_travail:job_update' app.id %}"
                   class="vt-link">
                  Modifier
                </a>
              </div>

            </div>
          {% endfor %}

        </div>
      {% else %}
        <p class="vt-subtle">
          Aucune candidature enregistrée pour ce profil.
        </p>
      {% endif %}

    </section>

  </div>
</section>
{% endblock %}
