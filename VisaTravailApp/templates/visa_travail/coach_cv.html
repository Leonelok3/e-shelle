{% extends "visa_travail/base.html" %}

{% block title %}Coach CV – Visa Travail{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-xl-9">

    <!-- HEADER -->
    <div class="card card-dark card-dark-hover p-4 p-md-5 mb-4 fade-in-up">
      <span class="badge-soft mb-2 px-3 py-1">
        <i class="bi bi-file-earmark-text me-1"></i> Coach CV – Analyse internationale
      </span>
      <h1 class="fw-bold h4 mb-1">Optimise ton CV pour un visa travail</h1>
      <p class="text-secondary small mb-0">
        Colle ton CV ci-dessous, indique le poste et le pays ciblés. Le coach analyse la structure,
        les sections, les mots-clés et te donne un plan d’action pour le rendre plus compétitif.
      </p>
    </div>

    <!-- MESSAGE ERREUR UPLOAD (SI BESOIN) -->
    {% if upload_error %}
      <div class="alert alert-danger small mb-3 fade-in-up">
        {{ upload_error }}
      </div>
    {% endif %}

    <!-- FORMULAIRE COACH CV -->
    <div class="card card-dark card-dark-hover p-4 mb-4 fade-in-up">
      <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="row">
          <!-- Profil lié (optionnel) -->
          <div class="col-md-6 mb-3">
            <label class="form-label">{{ form.user_profile.label }}</label>
            {{ form.user_profile }}
            {% if form.user_profile.help_text %}
              <div class="form-text text-secondary small">
                {{ form.user_profile.help_text }}
              </div>
            {% endif %}
          </div>

          <!-- Poste ciblé -->
          <div class="col-md-6 mb-3">
            <label class="form-label">{{ form.intitule_poste.label }}</label>
            {{ form.intitule_poste }}
            {% if form.intitule_poste.help_text %}
              <div class="form-text text-secondary small">
                {{ form.intitule_poste.help_text }}
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Pays cible -->
        <div class="mb-3">
          <label class="form-label">{{ form.pays_cible.label }}</label>
          {{ form.pays_cible }}
          {% if form.pays_cible.help_text %}
            <div class="form-text text-secondary small">
              {{ form.pays_cible.help_text }}
            </div>
          {% endif %}
        </div>

        <!-- Upload CV -->
        <div class="mb-3">
          <label class="form-label">Importer mon CV (PDF, DOCX ou TXT)</label>
          <input type="file" name="cv_file" class="form-control">
          {% if uploaded_filename %}
            <div class="text-secondary small mt-1">
              Fichier importé : {{ uploaded_filename }}
            </div>
          {% endif %}
        </div>

        <!-- Contenu texte du CV -->
        <div class="mb-3">
          <label class="form-label">{{ form.texte_cv.label }}</label>
          {{ form.texte_cv }}
          {% if form.texte_cv.help_text %}
            <div class="form-text text-secondary small">
              {{ form.texte_cv.help_text }}
            </div>
          {% endif %}
        </div>

        {% if form.errors %}
          <div class="alert alert-danger small mb-3">
            Merci de vérifier les champs en rouge : certaines informations sont manquantes ou invalides.
          </div>
        {% endif %}

        <button type="submit" class="btn btn-primary btn-lg">
          <i class="bi bi-stars me-1"></i> Analyser mon CV
        </button>
      </form>
    </div>

    <!-- RÉSULTATS ANALYSE -->
    {% if analysis_result %}
      <div class="card card-dark card-dark-hover p-4 mb-4 fade-in-up">
        <h2 class="h5 fw-semibold mb-3">
          <i class="bi bi-bar-chart-line me-1"></i> Résultats de l’analyse
        </h2>

        <p class="small text-secondary mb-2">
          Voici les principales recommandations du coach pour rendre ton CV plus fort
          pour un <strong>visa travail</strong> et des candidatures internationales.
        </p>

        <ul class="small text-secondary ps-3 mb-3">
          {% for msg in analysis_result %}
            <li>{{ msg }}</li>
          {% endfor %}
        </ul>

        <!-- Lien vers le générateur de CV -->
        <hr class="border-secondary mb-3">

        <div class="d-flex flex-wrap gap-2 align-items-center">
          <!--
            On utilise directement /cv-generator/ car ton include est :
            path("cv-generator/", include(("cv_generator.urls", "cv_generator"), ...))

            On passe en bonus :
            - profile = id du UserProfile choisi
            - poste   = intitulé du poste ciblé (url-encodé)
          -->
          <a
            href="/cv-generator/?profile={{ form.user_profile.value|default:'' }}&poste={{ form.intitule_poste.value|urlencode }}"
            class="btn btn-outline-light btn-sm"
          >
            <i class="bi bi-magic me-1"></i> Générer un CV optimisé avec mon profil
          </a>

          <span class="small text-secondary">
            Tu seras redirigé vers le module <strong>CV Generator</strong> pour produire une version
            optimisée de ton CV à partir de ce diagnostic.
          </span>
        </div>
      </div>
    {% endif %}

  </div>
</div>

<style>
.fade-in-up {
  animation: fadeInUp 0.7s ease both;
}
@keyframes fadeInUp {
  from { opacity: 0; transform: translateY(20px); }
  to   { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}
