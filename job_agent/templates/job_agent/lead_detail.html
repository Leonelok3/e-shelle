{% extends "base.html" %}
{% load static %}

{% block body_class %}job-agent{% endblock %}
{% block app_scope %}job-agent{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'job_agent/job_agent.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'job_agent/job_agent.js' %}" defer></script>
{% endblock %}

{% block content %}
<div class="app-main job-agent">
  <div class="ja-container">

    <div class="ja-pagehead">
      <div class="ja-pagehead__title">
        <h1>{{ lead.title|default:"Offre" }}</h1>
        <p>
          <span class="ja-muted">{{ lead.company|default:"Entreprise" }}</span>
          {% if lead.location %}
            <span class="ja-muted-2"> • {{ lead.location }}</span>
          {% endif %}
        </p>
      </div>

      <div class="ja-pagehead__actions">
        <a class="c-btn" href="{% url 'job_agent:lead_list' %}">Offres</a>
        <a class="c-btn" href="{% url 'job_agent:kanban' %}">Kanban</a>
        {% if lead.pack %}
          <a class="c-btn c-btn--primary" href="{% url 'job_agent:pack_detail' lead.id %}">
            Voir le pack
          </a>
        {% endif %}
      </div>
    </div>

    <div class="ja-layout">
      {% include "job_agent/_menu.html" with active="leads" %}

      <div class="ja-content">

        <!-- ========================= -->
        <!-- Résumé -->
        <!-- ========================= -->
        <section class="ja-card">
          <div class="ja-card__head">
            <h2>Résumé</h2>

            <div class="ja-leadcard__meta">
              {% include "job_agent/_status_badge.html" with status=lead.status %}

              {% with s=lead.match_score %}
                <span class="ja-score {% if s >= 75 %}ja-score--good{% elif s >= 45 %}ja-score--mid{% else %}ja-score--low{% endif %}">
                  <span class="ja-score__dot"></span>
                  <span>Score</span> <strong>{{ s }}</strong>
                </span>
              {% endwith %}
            </div>
          </div>

          <div class="ja-card__body">

            {% if lead.url %}
              <p class="ja-muted">
                Lien annonce :
                <a href="{{ lead.url }}" target="_blank" rel="noopener">
                  Ouvrir l’annonce ↗
                </a>
              </p>
            {% endif %}

            {% if not lead.description_text %}
              <div class="ja-alert ja-alert--warn">
                <strong>Description manquante.</strong>
                Ajoute la description pour un scoring plus précis.
              </div>
            {% endif %}

            {% if lead.description_text %}
              <div class="ja-block">
                <div class="ja-block__head">
                  <h3>Description</h3>
                  <span class="ja-muted-2">Copiée depuis l’annonce</span>
                </div>
                <pre>{{ lead.description_text }}</pre>
              </div>
            {% endif %}

          </div>
        </section>

        <div class="ja-divider"></div>

        <!-- ========================= -->
        <!-- Actions -->
        <!-- ========================= -->
        <div class="ja-formgrid">

          <div class="ja-col-6">
            <section class="ja-card">
              <div class="ja-card__head">
                <h2>Actions</h2>
                <span class="ja-muted-2">Score → Pack → Candidature</span>
              </div>

              <div class="ja-card__body">

                <div class="ja-actions ja-actions--wrap">

                  <!-- Recalculer score -->
                  <form method="post" action="{% url 'job_agent:lead_detail' lead.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="score">
                    <button class="c-btn" type="submit">
                      Recalculer score
                    </button>
                  </form>

                  <!-- Générer pack -->
                  <form method="post" action="{% url 'job_agent:lead_detail' lead.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="generate_pack">
                    <button class="c-btn c-btn--primary" type="submit">
                      Générer le pack
                    </button>
                  </form>

                  <!-- Postuler vite (wizard interne) -->
                  <a class="c-btn"
                     href="{% url 'job_agent:apply_wizard' lead.id %}">
                    Postuler vite
                  </a>

                  <!-- Postuler AutoFill (Indeed + extension) -->
                  {% if lead.url %}
                    <a
                      class="c-btn c-btn--primary"
                      target="_blank"
                      rel="noopener"
                      href="{{ lead.url }}{% if '?' in lead.url %}&{% else %}?{% endif %}imm97_lead={{ lead.id }}&imm97_api={{ request.scheme }}://{{ request.get_host }}"
                    >
                      Postuler (AutoFill)
                    </a>
                  {% endif %}

                  {% if lead.pack %}
                    <a class="c-btn"
                       href="{% url 'job_agent:pack_detail' lead.id %}">
                      Ouvrir le pack
                    </a>
                  {% endif %}

                </div>

                <div class="ja-divider"></div>

                <!-- Changer statut -->
                <form method="post" action="{% url 'job_agent:lead_detail' lead.id %}">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="set_status">

                  <div class="ja-field">
                    <label for="ja-status">Statut</label>
                    <select class="c-input" id="ja-status" name="status">
                      {% for key,label in status_choices %}
                        <option value="{{ key }}" {% if lead.status == key %}selected{% endif %}>
                          {{ label }}
                        </option>
                      {% endfor %}
                    </select>
                  </div>

                  <button class="c-btn" type="submit">
                    Enregistrer
                  </button>
                </form>

              </div>
            </section>
          </div>

          <!-- ========================= -->
          <!-- Contact -->
          <!-- ========================= -->
          <div class="ja-col-6">
            <section class="ja-card">
              <div class="ja-card__head">
                <h2>Contact recruteur</h2>
              </div>

              <div class="ja-card__body">

                {% if lead.contact_email %}
                  <div class="ja-alert ja-alert--ok">
                    Email enregistré : <strong>{{ lead.contact_email }}</strong>
                  </div>
                {% endif %}

                <form method="post" action="{% url 'job_agent:lead_detail' lead.id %}">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="save_contact_email">

                  <div class="ja-field">
                    <label>Email recruteur</label>
                    <input
                      class="c-input"
                      name="contact_email"
                      type="email"
                      value="{{ lead.contact_email|default:'' }}"
                      placeholder="recruteur@entreprise.com">
                  </div>

                  <button class="c-btn" type="submit">
                    Enregistrer
                  </button>
                </form>

                <div class="ja-divider"></div>

                <form method="post" action="{% url 'job_agent:lead_detail' lead.id %}">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="send_followup_now">
                  <button class="c-btn c-btn--primary" type="submit">
                    Envoyer relance
                  </button>
                </form>

              </div>
            </section>
          </div>

        </div>

      </div>
    </div>

  </div>
</div>
{% endblock %}
