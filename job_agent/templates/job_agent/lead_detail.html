{% extends "base.html" %}
{% load static %}

{% block body_class %}job-agent{% endblock %}
{% block app_scope %}job-agent{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'job_agent/job_agent.css' %}">
{% endblock %}

{% block extra_js %}
<script src="{% static 'job_agent/job_agent.js' %}" defer></script>
{% endblock %}

{% block content %}
<div class="app-main job-agent">
  <div class="ja-container">

    <div class="ja-pagehead">
      <div class="ja-pagehead__title">
        <h1>{{ lead.title|default:"Offre" }}</h1>
        <p>
          <span class="ja-muted">{{ lead.company|default:"Entreprise" }}</span>
          {% if lead.location %}<span class="ja-muted-2"> • {{ lead.location }}</span>{% endif %}
        </p>
      </div>

      <div class="ja-pagehead__actions">
        <a class="c-btn" href="{% url 'job_agent:lead_list' %}" aria-label="Retour à la liste des offres">Offres</a>
        <a class="c-btn" href="{% url 'job_agent:kanban' %}" aria-label="Ouvrir le kanban">Kanban</a>
        {% if lead.pack %}
          <a class="c-btn c-btn--primary" href="{% url 'job_agent:pack_detail' lead.id %}" aria-label="Voir le pack de candidature">
            Voir le pack
          </a>
        {% endif %}
      </div>
    </div>

    <div class="ja-layout">
      {% include "job_agent/_menu.html" with active="leads" %}

      <div class="ja-content">

        <section class="ja-card" aria-label="Résumé de l'offre">
          <div class="ja-card__head">
            <h2>Résumé</h2>

            <div class="ja-leadcard__meta" aria-label="Statut et score">
              {% include "job_agent/_status_badge.html" with status=lead.status %}

              {% with s=lead.match_score %}
                <span class="ja-score {% if s >= 75 %}ja-score--good{% elif s >= 45 %}ja-score--mid{% else %}ja-score--low{% endif %}">
                  <span class="ja-score__dot" aria-hidden="true"></span>
                  <span>Score</span> <strong>{{ s }}</strong>
                </span>
              {% endwith %}
            </div>
          </div>

          <div class="ja-card__body">

            {% if lead.url %}
              <p class="ja-muted">
                Lien annonce :
                <a href="{{ lead.url }}" target="_blank" rel="noopener" aria-label="Ouvrir l'annonce dans un nouvel onglet">
                  Ouvrir l’annonce ↗
                </a>
              </p>
            {% endif %}

            {% if not lead.description_text %}
              <div class="ja-alert ja-alert--warn" role="note">
                <strong>Description manquante.</strong>
                Ajoute la description pour un scoring plus précis et un pack plus pertinent.
              </div>
            {% endif %}

            {% if lead.description_text %}
              <div class="ja-block" aria-label="Description de l'offre">
                <div class="ja-block__head">
                  <h3>Description</h3>
                  <span class="ja-muted-2">Copiée depuis l’annonce</span>
                </div>
                <pre>{{ lead.description_text }}</pre>
              </div>
            {% endif %}

          </div>
        </section>

        <div class="ja-divider" aria-hidden="true"></div>

        <div class="ja-formgrid" aria-label="Actions et suivi">

          <!-- Actions rapides -->
          <div class="ja-col-6">
            <section class="ja-card" aria-label="Actions sur l'offre">
              <div class="ja-card__head">
                <h2>Actions</h2>
                <span class="ja-muted-2">Score → Pack → Candidature</span>
              </div>

              <div class="ja-card__body">
                <div class="ja-actions ja-actions--wrap" aria-label="Boutons actions">
                  <form method="post" action="{% url 'job_agent:lead_detail' lead.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="score">
                    <button class="c-btn" type="submit" aria-label="Recalculer le score">
                      Recalculer score
                    </button>
                  </form>

                  <form method="post" action="{% url 'job_agent:lead_detail' lead.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="generate_pack">
                    <button class="c-btn c-btn--primary" type="submit" aria-label="Générer le pack de candidature">
                      Générer le pack
                    </button>
                  </form>

                  {% if lead.pack %}
                    <a class="c-btn" href="{% url 'job_agent:pack_detail' lead.id %}" aria-label="Ouvrir le pack de candidature">
                      Ouvrir le pack
                    </a>
                  {% endif %}
                </div>

                <div class="ja-divider" aria-hidden="true"></div>

                <form method="post" action="{% url 'job_agent:lead_detail' lead.id %}" aria-label="Changer le statut">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="set_status">

                  <div class="ja-field">
                    <label for="ja-status">Statut</label>
                    <select class="c-input" id="ja-status" name="status" aria-label="Sélectionner un statut">
                      {% for key,label in status_choices %}
                        <option value="{{ key }}" {% if lead.status == key %}selected{% endif %}>{{ label }}</option>
                      {% endfor %}
                    </select>
                    <p class="ja-help">Garde un pipeline net : trouvée → à postuler → postulée → relance → réponse.</p>
                  </div>

                  <button class="c-btn" type="submit" aria-label="Enregistrer le statut">
                    Enregistrer
                  </button>
                </form>
              </div>
            </section>
          </div>

          <!-- Contact & relance -->
          <div class="ja-col-6">
            <section class="ja-card" aria-label="Contact recruteur et relance">
              <div class="ja-card__head">
                <h2>Contact recruteur</h2>
                <span class="ja-muted-2">Pour relancer proprement</span>
              </div>

              <div class="ja-card__body">

                {% if lead.contact_email %}
                  <div class="ja-alert ja-alert--ok" role="note">
                    Email enregistré : <strong>{{ lead.contact_email }}</strong>
                  </div>
                {% else %}
                  <div class="ja-alert ja-alert--warn" role="note">
                    Email recruteur manquant. Ajoute-le pour pouvoir envoyer une relance.
                  </div>
                {% endif %}

                <form method="post" action="{% url 'job_agent:lead_detail' lead.id %}" aria-label="Sauvegarder l'email recruteur">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="save_contact_email">

                  <div class="ja-field">
                    <label for="ja-contact-email">Email recruteur</label>
                    <input
                      class="c-input"
                      id="ja-contact-email"
                      name="contact_email"
                      type="email"
                      value="{{ lead.contact_email|default:'' }}"
                      placeholder="recruteur@entreprise.com"
                      aria-label="Email recruteur"
                      autocomplete="email"
                    >
                    <p class="ja-help">On l’utilise uniquement pour le suivi de cette offre.</p>
                  </div>

                  <button class="c-btn" type="submit" aria-label="Enregistrer l'email recruteur">
                    Enregistrer
                  </button>
                </form>

                <div class="ja-divider" aria-hidden="true"></div>

                <form method="post" action="{% url 'job_agent:lead_detail' lead.id %}" aria-label="Envoyer une relance maintenant">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="send_followup_now">

                  <button class="c-btn c-btn--primary" type="submit" aria-label="Envoyer une relance">
                    Envoyer relance
                  </button>
                  <p class="ja-help">
                    Relance seulement si la candidature a été envoyée et si le contexte est complet.
                  </p>
                </form>

              </div>
            </section>
          </div>

        </div>

        <div class="ja-toast" role="status" aria-live="polite" aria-atomic="true">
          <span class="ja-toast__msg">OK</span>
          <button class="ja-toast__btn" type="button" data-toast-dismiss aria-label="Fermer la notification">OK</button>
        </div>

      </div>
    </div>

  </div>
</div>
{% endblock %}
