{# billing/templates/billing/buy_plan.html #}
{% extends 'base.html' %}
{% load static %}

{% block title %}Paiement S√©curis√© {{ plan.name }} - Abonnement Immigration Canada | Immigration97{% endblock %}

{% block meta_description %}Finalisez votre abonnement {{ plan.name }} pour acc√©der aux outils premium d'immigration Canada. Paiement s√©curis√© 100% par Mobile Money Afrique (Orange, MTN, Moov, Wave) et Carte Bancaire Internationale. Activation instantan√©e.{% endblock %}

{% block body_class %}billing{% endblock %}
{% block app_scope %}billing{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/billing.css' %}">
{% endblock %}

{% block content %}
<!-- Schema.org pour SEO e-commerce -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "CheckoutPage",
  "name": "Paiement S√©curis√© {{ plan.name }}",
  "description": "Finalisez votre abonnement premium Immigration97",
  "provider": {
    "@type": "Organization",
    "name": "Immigration97"
  },
  "paymentAccepted": ["Mobile Money", "Visa", "Mastercard"],
  "priceRange": "{{ plan.price_usd }} USD"
}
</script>

<div class="checkout-container">
    <!-- NAVIGATION RETOUR -->
    <nav class="checkout-nav">
        <a href="{% url 'billing:pricing' %}" class="back-link">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            <span>Retour aux plans d'abonnement</span>
        </a>
    </nav>

    <div class="checkout-layout">
        <!-- COLONNE GAUCHE: R√âCAPITULATIF PLAN -->
        <aside class="plan-summary">
            <div class="summary-sticky">
                <div class="plan-badge">‚ö° Activation instantan√©e</div>

                <h1 class="plan-title">{{ plan.name }}</h1>
                <p class="plan-subtitle">
                    Abonnement premium immigration Canada
                </p>

                <!-- PRIX PRINCIPAL -->
                <div class="price-display">
                    <div class="price-main">
                        <span class="currency">$</span>
                        <span class="amount">{{ plan.price_usd }}</span>
                        <span class="unit">USD</span>
                    </div>

                    <div class="price-local">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 6v6l4 2"></path>
                        </svg>
                        Environ {{ plan.price_xaf|floatformat:0 }} FCFA
                    </div>

                    <p class="duration-badge">
                        ‚è±Ô∏è Acc√®s complet {{ plan.get_duration_display }}
                    </p>
                </div>

                <!-- CE QUI EST INCLUS -->
                <div class="included-features">
                    <h3 class="features-title">‚úÖ Inclus dans votre abonnement</h3>
                    <ul class="features-list">
                        <li>üéØ G√©n√©rateur CV International ATS</li>
                        <li>üì∏ Photo Visa Biom√©trique</li>
                        <li>üìö Tests IELTS, TCF, TEF complets</li>
                        <li>üá®üá¶ Guides Visa Canada & RP</li>
                        <li>üßÆ Calculateurs CRS & √âligibilit√©</li>
                        <li>üí¨ Support prioritaire 24/7</li>
                        <li>üìä Suivi dossier immigration</li>
                        {% if plan.duration_days >= 365 %}
                        <li>‚≠ê Consultation gratuite incluse</li>
                        <li>üéÅ Mises √† jour exclusives</li>
                        {% endif %}
                    </ul>
                </div>

                <!-- GARANTIES -->
                <div class="guarantees">
                    <div class="guarantee-item">
                        <span class="guarantee-icon">üîí</span>
                        <div>
                            <strong>Paiement 100% s√©curis√©</strong>
                            <p>Cryptage SSL 256-bit</p>
                        </div>
                    </div>
                    <div class="guarantee-item">
                        <span class="guarantee-icon">‚ö°</span>
                        <div>
                            <strong>Acc√®s imm√©diat</strong>
                            <p>Activ√© en moins de 2 minutes</p>
                        </div>
                    </div>
                    <div class="guarantee-item">
                        <span class="guarantee-icon">üíØ</span>
                        <div>
                            <strong>Satisfait ou rembours√©</strong>
                            <p>Garantie 30 jours</p>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- COLONNE DROITE: FORMULAIRE PAIEMENT -->
        <main class="payment-section">
            <form method="POST" action="{% url 'billing:initiate_payment' transaction.id %}" class="payment-form">
                {% csrf_token %}

                {# IMPORTANT: conserver next #}
                <input type="hidden" name="next" value="{{ next|default:'' }}">

                <!-- HEADER S√âCURIT√â -->
                <div class="security-header">
                    <h2 class="section-title">Finaliser mon abonnement</h2>
                    <div class="secure-badge">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Paiement s√©curis√© SSL
                    </div>
                </div>

                <!-- M√âTHODES DE PAIEMENT -->
                <div class="payment-methods">
                    <h3 class="methods-title">Choisissez votre mode de paiement</h3>

                    {% if cinetpay_available %}
                    <label class="payment-method">
                        <input type="radio" name="payment_method" value="MOBILE_MONEY" required>
                        <div class="method-card">
                            <div class="method-header">
                                <span class="method-icon">üì±</span>
                                <div class="method-info">
                                    <h4 class="method-name">Mobile Money Afrique</h4>
                                    <p class="method-desc">Orange Money, MTN, Moov, Wave, Airtel Money</p>
                                </div>
                            </div>
                            <div class="method-badge">Recommand√©</div>
                            <div class="radio-check"></div>
                        </div>
                        <div class="method-details">
                            <div class="detail-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                <span>Paiement instantan√© depuis votre t√©l√©phone</span>
                            </div>
                            <div class="detail-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                <span>Disponible dans toute l'Afrique francophone</span>
                            </div>
                        </div>
                    </label>
                    {% endif %}

                    {% if stripe_available %}
                    <label class="payment-method">
                        <input type="radio" name="payment_method" value="CARD" required>
                        <div class="method-card">
                            <div class="method-header">
                                <span class="method-icon">üí≥</span>
                                <div class="method-info">
                                    <h4 class="method-name">Carte Bancaire</h4>
                                    <p class="method-desc">Visa, Mastercard, American Express</p>
                                </div>
                            </div>
                            <div class="method-badge method-badge--international">International</div>
                            <div class="radio-check"></div>
                        </div>
                        <div class="method-details">
                            <div class="detail-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                <span>Accept√© partout dans le monde</span>
                            </div>
                            <div class="detail-item">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                                <span>Protection 3D Secure incluse</span>
                            </div>
                        </div>
                    </label>
                    {% endif %}

                    {% if not cinetpay_available and not stripe_available %}
                    <div class="maintenance-alert">
                        <div class="alert-icon">‚ö†Ô∏è</div>
                        <div class="alert-content">
                            <h4>Maintenance temporaire</h4>
                            <p>Nos passerelles de paiement sont momentan√©ment indisponibles.</p>
                            <a href="{% url 'billing:redeem' %}?next={{ next|urlencode }}" class="btn btn-secondary">
                                Utiliser un code d'activation ‚Üí
                            </a>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- ACTIONS -->
                {% if cinetpay_available or stripe_available %}
                <div class="checkout-actions">
                    <button type="submit" class="btn-checkout-primary">
                        <span class="btn-text">Confirmer et Payer</span>
                        <span class="btn-icon">üîí</span>
                    </button>

                    <p class="checkout-notice">
                        En cliquant sur "Confirmer et Payer", vous acceptez nos
                        <a href="/terms/" target="_blank">conditions d'utilisation</a> et
                        <a href="/privacy/" target="_blank">politique de confidentialit√©</a>.
                    </p>

                    <div class="trust-badges">
                        <div class="trust-badge">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            <span>Activation instantan√©e</span>
                        </div>
                        <div class="trust-badge">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            <span>Facture automatique</span>
                        </div>
                        <div class="trust-badge">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="20 6 9 17 4 12"></polyline>
                            </svg>
                            <span>Support d√©di√©</span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </form>

            <!-- SECTION FAQ RAPIDE -->
            <div class="checkout-faq">
                <h3 class="faq-title">‚ùì Questions fr√©quentes</h3>

                <details class="faq-item">
                    <summary>Quand aurais-je acc√®s √† mon abonnement ?</summary>
                    <p>Votre acc√®s est activ√© <strong>imm√©diatement</strong> apr√®s confirmation du paiement. Vous recevrez un email et pourrez utiliser tous les outils premium dans les 2 minutes.</p>
                </details>

                <details class="faq-item">
                    <summary>Le paiement Mobile Money est-il s√©curis√© ?</summary>
                    <p>Oui, 100% s√©curis√©. Nous utilisons une passerelle certifi√©e, avec cryptage SSL. Vos donn√©es bancaires ne transitent jamais par nos serveurs.</p>
                </details>

                <details class="faq-item">
                    <summary>Puis-je obtenir une facture ?</summary>
                    <p>Oui, une facture peut √™tre g√©n√©r√©e et disponible dans votre espace membre (selon votre int√©gration).</p>
                </details>

                <details class="faq-item">
                    <summary>Que se passe-t-il si le paiement √©choue ?</summary>
                    <p>Vous pourrez r√©essayer ou choisir une autre m√©thode. Aucun frais ne sera d√©bit√© si le paiement n‚Äôest pas valid√©.</p>
                </details>
            </div>

            <!-- SECTION S√âCURIT√â -->
            <div class="security-footer">
                <h4 class="security-title">üîê Votre s√©curit√©, notre priorit√©</h4>
                <div class="security-grid">
                    <div class="security-item">
                        <span class="security-icon">üõ°Ô∏è</span>
                        <p>Cryptage SSL</p>
                    </div>
                    <div class="security-item">
                        <span class="security-icon">üè¶</span>
                        <p>Paiement certifi√©</p>
                    </div>
                    <div class="security-item">
                        <span class="security-icon">‚úÖ</span>
                        <p>Conformit√© RGPD</p>
                    </div>
                    <div class="security-item">
                        <span class="security-icon">üåç</span>
                        <p>Standard international</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Animation radio buttons
document.addEventListener('DOMContentLoaded', function() {
    const radioInputs = document.querySelectorAll('.payment-method input[type="radio"]');

    radioInputs.forEach(input => {
        input.addEventListener('change', function() {
            document.querySelectorAll('.payment-method').forEach(label => {
                label.classList.remove('is-selected');
            });

            if (this.checked) {
                this.closest('.payment-method').classList.add('is-selected');
            }
        });
    });

    // S√©lectionner la premi√®re option par d√©faut
    const firstRadio = document.querySelector('.payment-method input[type="radio"]');
    if (firstRadio) {
        firstRadio.checked = true;
        firstRadio.closest('.payment-method').classList.add('is-selected');
    }
});
</script>
{% endblock %}
