{% extends "base.html" %}
{% load static %}

{% block title %}Passer un test d'anglais ‚Äì {{ test.name }}{% endblock %}

{% block content %}
<main class="relative min-h-screen overflow-hidden bg-slate-950 text-slate-50">

    {# üåà BACKGROUND GRADIENTS #}
    <div class="pointer-events-none absolute inset-0 -z-10 overflow-hidden">
        <div class="absolute -top-40 -left-32 h-72 w-72 rounded-full bg-gradient-to-br from-blue-500/25 via-emerald-400/10 to-transparent blur-3xl opacity-60"></div>
        <div class="absolute top-1/3 -right-32 h-80 w-80 rounded-full bg-gradient-to-br from-purple-600/25 via-pink-500/10 to-transparent blur-3xl opacity-60"></div>
        <div class="absolute bottom-0 left-1/2 h-72 w-[420px] -translate-x-1/2 translate-y-1/3 rounded-full bg-gradient-to-t from-amber-500/20 via-emerald-500/10 to-transparent blur-3xl opacity-60"></div>
    </div>

    <div class="relative z-10 mx-auto flex min-h-screen max-w-7xl flex-col px-4 pb-10 pt-6 sm:px-6 lg:pb-16 lg:pt-10">

        {# HEADER CONTEXTUEL #}
        <header class="mb-6 flex flex-col gap-3 border-b border-slate-800/70 pb-4 sm:mb-8 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <p class="text-[0.7rem] font-semibold uppercase tracking-[0.22em] text-slate-400">
                    Immigration97 ‚Ä¢ English Preparation
                </p>
                <h1 class="mt-3 bg-gradient-to-r from-blue-400 via-emerald-300 to-purple-400 bg-clip-text text-2xl font-light tracking-tight text-transparent sm:text-3xl lg:text-4xl">
                    Passer le test <span class="text-slate-50/95">{{ test.name }}</span>
                </h1>
                <p class="mt-3 max-w-2xl text-sm font-light leading-relaxed text-slate-300 sm:text-base">
                    R√©ponds aux questions une seule fois, comme √† l‚Äôexamen. √Ä la fin du test, tu obtiens ton score,
                    une correction d√©taill√©e et ton XP est ajout√© √† ton profil d‚Äôanglais.
                </p>
            </div>

            <div class="grid w-full grid-cols-2 gap-3 text-[0.7rem] sm:w-auto sm:grid-cols-1">
                <div class="rounded-2xl border border-slate-800/80 bg-slate-900/80 px-3 py-2">
                    <p class="text-[0.7rem] font-semibold uppercase tracking-[0.18em] text-slate-400">Type</p>
                    <p class="mt-1 text-sm font-light text-slate-100">
                        {{ test.get_exam_type_display }}
                    </p>
                </div>
                <div class="rounded-2xl border border-slate-800/80 bg-slate-900/80 px-3 py-2">
                    <p class="text-[0.7rem] font-semibold uppercase tracking-[0.18em] text-slate-400">Niveau cible</p>
                    <p class="mt-1 text-sm font-light text-slate-100">
                        {{ test.get_level_display }}
                    </p>
                </div>
            </div>
        </header>

        {# META EXAMEN (ligne) #}
        <section class="mb-6 rounded-2xl border border-slate-800/80 bg-slate-900/80 px-4 py-3 text-xs text-slate-200 shadow-lg shadow-black/50 backdrop-blur-xl sm:px-5 sm:py-4">
            <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
                <div class="flex flex-wrap gap-4">
                    <div>
                        <p class="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-slate-400">
                            Type
                        </p>
                        <p class="mt-0.5 text-sm font-light text-slate-100">
                            {{ test.get_exam_type_display }}
                        </p>
                    </div>
                    <div>
                        <p class="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-slate-400">
                            Niveau cible
                        </p>
                        <p class="mt-0.5 text-sm font-light text-slate-100">
                            {{ test.get_level_display }}
                        </p>
                    </div>
                    <div>
                        <p class="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-slate-400">
                            Dur√©e indicative
                        </p>
                        <p class="mt-0.5 text-sm font-light text-slate-100">
                            {{ duration_minutes }} min
                        </p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <p class="text-[0.65rem] font-semibold uppercase tracking-[0.18em] text-slate-400">
                        Temps restant
                    </p>
                    <div class="inline-flex items-center gap-2 rounded-full border border-amber-400/60 bg-amber-500/10 px-3 py-1 text-sm font-semibold text-amber-200 shadow-sm shadow-amber-500/30">
                        <span class="text-xs" aria-hidden="true">‚è±</span>
                        <span id="exam-timer" data-duration="{{ duration_minutes }}">--:--</span>
                    </div>
                </div>
            </div>
        </section>

        {# LAYOUT 2 COLONNES #}
        <section class="grid flex-1 gap-6 lg:grid-cols-[minmax(0,2.1fr)_minmax(260px,1fr)]">
            {# COLONNE GAUCHE ‚Äì QUESTIONS #}
            <article class="rounded-2xl border border-slate-800/80 bg-gradient-to-br from-slate-900/95 via-slate-900/75 to-slate-800/70 p-5 text-sm shadow-2xl shadow-black/70 backdrop-blur-xl sm:p-6">
                <header class="mb-4">
                    <h2 class="text-lg font-light tracking-tight text-slate-50 sm:text-xl">
                        Questions du test
                    </h2>
                    <p class="mt-1 text-xs font-light text-slate-300 sm:text-sm">
                        Choisis une seule r√©ponse par question. Prends le temps de lire les √©nonc√©s avec attention.
                    </p>
                </header>

                <form id="exam-form" method="post" class="space-y-4 sm:space-y-5">
                    {% csrf_token %}

                    {% for question in questions %}
                        <div class="rounded-2xl border border-slate-800/80 bg-slate-950/70 p-4 sm:p-5">
                            <div class="mb-3 flex flex-wrap items-center justify-between gap-2">
                                <div class="text-[0.75rem] font-semibold uppercase tracking-[0.18em] text-slate-400">
                                    Question {{ forloop.counter }} / {{ questions|length }}
                                </div>
                                <div class="inline-flex items-center rounded-full border border-slate-700/80 bg-slate-900/80 px-3 py-1 text-[0.7rem] font-medium text-slate-200">
                                    {% if question.skill == "READING" %}
                                        <span class="mr-1.5 text-xs" aria-hidden="true">üìñ</span>
                                        Reading
                                    {% elif question.skill == "USE_OF_ENGLISH" %}
                                        <span class="mr-1.5 text-xs" aria-hidden="true">‚úèÔ∏è</span>
                                        Grammaire / Vocabulaire
                                    {% else %}
                                        <span class="mr-1.5 text-xs" aria-hidden="true">üåç</span>
                                        G√©n√©ral
                                    {% endif %}
                                </div>
                            </div>

                            <p class="whitespace-pre-line text-sm font-light leading-relaxed text-slate-100 sm:text-base">
                                {{ question.text }}
                            </p>

                            <div class="mt-3 space-y-2">
                                {% for choice in question.choices.all %}
                                    <label class="group flex cursor-pointer items-start gap-3 rounded-xl border border-slate-800/80 bg-slate-950/80 px-3 py-2.5 text-sm text-slate-200 transition-all duration-300 hover:border-blue-400/70 hover:bg-slate-900/80">
                                        <input
                                            type="radio"
                                            name="question_{{ question.id }}"
                                            value="{{ choice.id }}"
                                            class="mt-1 h-4 w-4 border-slate-500 bg-slate-900 text-blue-500 focus:ring-blue-500"
                                            required
                                        >
                                        <span class="flex h-6 w-6 flex-none items-center justify-center rounded-full border border-slate-700/80 bg-slate-900/80 text-[0.75rem] font-semibold text-slate-200 group-hover:border-blue-400/80 group-hover:text-blue-200">
                                            {{ forloop.counter0|add:"A"|slice:":1" }}
                                        </span>
                                        <span class="leading-relaxed">
                                            {{ choice.text }}
                                        </span>
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}

                    <div class="mt-6 flex flex-col gap-3 border-t border-slate-800/70 pt-4 sm:flex-row sm:items-center sm:justify-between">
                        <button
                            type="submit"
                            class="inline-flex items-center justify-center rounded-3xl bg-gradient-to-r from-blue-400 via-emerald-400 to-sky-400 px-6 py-2.5 text-sm font-semibold text-slate-950 shadow-lg shadow-blue-500/40 transition-all duration-300 hover:scale-105 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-400/80 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-950"
                        >
                            <span class="mr-1.5 text-base" aria-hidden="true">‚úÖ</span>
                            Valider mes r√©ponses
                        </button>
                        <p class="text-[0.75rem] font-light text-slate-400 sm:max-w-sm">
                            Une fois valid√©, tu verras ton score, l‚Äôimpact sur ton profil et une correction d√©taill√©e
                            question par question.
                        </p>
                    </div>
                </form>
            </article>

            {# COLONNE DROITE ‚Äì CONSEILS EXAMEN #}
            <aside class="space-y-4">
                <article class="rounded-2xl border border-slate-800/80 bg-slate-900/85 p-5 text-sm shadow-xl shadow-black/60 backdrop-blur-xl sm:p-6">
                    <h3 class="text-base font-light tracking-tight text-slate-50 sm:text-lg">
                        Conditions ‚Äúexamen‚Äù
                    </h3>
                    <p class="mt-2 text-[0.85rem] font-light text-slate-300 sm:text-sm">
                        Pour profiter au maximum de ce test, mets-toi dans des conditions proches de l‚Äôexamen
                        officiel (IELTS, TOEFL, TOEIC ou g√©n√©ral).
                    </p>
                    <ul class="mt-3 space-y-1.5 text-[0.85rem] font-light text-slate-300 sm:text-sm">
                        <li>‚è±Ô∏è Pr√©vois {{ duration_minutes }} minutes sans interruption.</li>
                        <li>üìµ Coupe les notifications et les distractions.</li>
                        <li>üßò Respire quelques secondes avant de commencer.</li>
                        <li>‚úÖ R√©ponds spontan√©ment, sans chercher sur Internet.</li>
                    </ul>
                    <p class="mt-4 rounded-xl border border-slate-800/80 bg-slate-950/80 px-3 py-3 text-[0.8rem] font-light text-slate-400">
                        <span class="font-semibold text-slate-100">Bient√¥t :</span>
                        minuteur temps r√©el synchronis√© serveur, sauvegarde automatique
                        et analyse IA avanc√©e de tes r√©ponses directement dans Immigration97.
                    </p>
                </article>
            </aside>
        </section>
    </div>
</main>

{# TIMER JS #}
<script>
document.addEventListener("DOMContentLoaded", function () {
    const timerEl = document.getElementById("exam-timer");
    if (!timerEl) return;

    const durationMin = parseInt(timerEl.dataset.duration || "20", 10);
    let remaining = durationMin * 60; // secondes

    function tick() {
        const minutes = String(Math.floor(remaining / 60)).padStart(2, "0");
        const seconds = String(remaining % 60).padStart(2, "0");
        timerEl.textContent = minutes + ":" + seconds;

        if (remaining <= 0) {
            const form = document.getElementById("exam-form");
            if (form) {
                form.submit();
            }
            return;
        }

        remaining -= 1;
        setTimeout(tick, 1000);
    }

    tick();
});
</script>
{% endblock %}
