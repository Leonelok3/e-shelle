{% extends "base.html" %}
{% load static %}

{% block title %}
Profil allemand – Progression & objectifs – Immigration97
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/germanprep.css' %}">
{% endblock %}

{% block content %}
<main class="page page-dark page-germanprep page--german-profile">

  <section class="section">
    <div class="container-narrow">

      <p class="hero-kicker">Préparation • Allemand • Profil</p>

      <h1 class="hero-title">
        Ton profil d’allemand sur Immigration97
      </h1>

      <p class="hero-subtitle">
        Suis ton XP, ton niveau et tes performances, et laisse le coach IA
        construire un plan sur mesure pour réussir tes examens officiels
        (Goethe, telc, TestDaF, DSH).
      </p>

      <!-- PROFIL GLOBAL -->
      <div class="profile-header-card">
        <div class="profile-main-info">
          <p>Niveau interne : <strong>{{ profile.level }}</strong></p>
          <p>XP total : <strong>{{ profile.xp }}</strong></p>
          <p>Tests passés : <strong>{{ profile.total_tests }}</strong></p>
          <p>Meilleur score : <strong>{{ profile.best_score|default:0|floatformat:1 }} %</strong></p>
        </div>

        <div class="profile-progress">
          <p>Progression vers le niveau {{ next_level }}</p>
          <div class="progress-bar">
            <div class="progress-bar-fill"
                 style="width: {{ level_progress_pct }}%;">
            </div>
          </div>
          <p class="progress-caption">
            {{ level_progress_pct }} % ({{ current_min_xp }} → {{ next_level_xp }} XP)
          </p>
        </div>
      </div>

      {% if profile.badges %}
      <section class="section">
        <h2 class="section-title">Badges débloqués</h2>
        <ul class="badge-list">
          {% for b in profile.badges %}
            <li class="badge-item">{{ b }}</li>
          {% endfor %}
        </ul>
      </section>
      {% endif %}

      <section class="section">
        <h2 class="section-title">Résumé par niveau (A1 → C2)</h2>

        {% if level_stats %}
        <div class="stats-grid">
          {% for _, data in level_stats.items %}
            <article class="stat-card">
              <h3>{{ data.label }}</h3>
              <p>Tests : <strong>{{ data.count }}</strong></p>
              <p>Score moyen : <strong>{{ data.avg }} %</strong></p>
              <p>Meilleur score : <strong>{{ data.best }} %</strong></p>
            </article>
          {% endfor %}
        </div>
        {% else %}
          <p class="section-empty">
            Aucun test d’allemand enregistré pour l’instant.
          </p>
        {% endif %}
      </section>

      <section class="section">
        <h2 class="section-title">Prochaine étape recommandée</h2>
        <p class="next-step">{{ next_step }}</p>
      </section>

      <section class="section">
        <h2 class="section-title">Coach IA allemand</h2>
        <p class="section-subtitle">
          Copie ce message pour démarrer une discussion avec ton coach IA.
        </p>

        <textarea class="coach-preset"
                  rows="8"
                  readonly
                  onclick="this.select();">{{ coach_preset }}</textarea>

        <div class="section-footer-cta">
          <a href="{% url 'germanprep:progress_dashboard' %}"
             class="btn btn-secondary">
            Ouvrir mon tableau de bord
          </a>
        </div>
      </section>

      <section class="section">
        <h2 class="section-title">Derniers tests d’allemand</h2>

        {% if sessions %}
        <ul class="session-list">
          {% for s in sessions %}
            <li class="session-item">
              <div class="session-main">
                <p class="session-title">
                  {{ s.exam.title }} ({{ s.exam.level }})
                </p>
                <p class="session-meta">
                  {{ s.started_at|date:"d/m/Y H:i" }}
                </p>
              </div>
              <div class="session-score">
                {{ s.score|default:"0.0" }} %
              </div>
            </li>
          {% endfor %}
        </ul>
        {% else %}
          <p class="section-empty">
            Aucun test enregistré pour l’instant.
          </p>
        {% endif %}
      </section>

    </div>
  </section>

</main>
{% endblock %}
