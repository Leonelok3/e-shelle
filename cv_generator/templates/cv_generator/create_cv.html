{% extends "base.html" %}
{% load static %}

{# ====== SEO : Title dynamique selon le template ====== #}
{% block title %}
  {% if cv.template and cv.template.style_type == 'canada' %}
    CV Canada optimis√© (ATS, recruteurs) ¬∑ Immigration97
  {% elif cv.template and cv.template.style_type == 'europe' %}
    CV Europe (Europass / standards UE) ¬∑ Immigration97
  {% elif cv.template and cv.template.style_type == 'modern' %}
    CV Moderne pour candidatures internationales ¬∑ Immigration97
  {% elif cv.template and cv.template.style_type == 'professional' %}
    CV Professionnel pour poste qualifi√© ¬∑ Immigration97
  {% else %}
    √âditeur de CV ‚Äî Cr√©e ton CV complet en 3 √©tapes ¬∑ Immigration97
  {% endif %}
{% endblock %}

{% block meta_description %}
  Cr√©e un CV professionnel en 3 √©tapes : infos, exp√©riences, comp√©tences. Mod√®les Canada, Europe, Moderne, Professionnel.
  Compatible recruteurs & ATS. Export PDF, IA, langues, projets, certifications. Immigration97.
{% endblock %}

{% block head_extra %}
  {# Styles sp√©cifiques √† l‚Äô√©diteur de CV (on garde 100% ta logique, juste styl√© proprement) #}
  <style>
    :root{
      --cv-bg:#0b1220;
      --cv-panel:#0f172a;
      --cv-muted:#94a3b8;
      --cv-text:#e5e7eb;
      --cv-ok:#22c55e;
      --cv-brand:#3b82f6;
    }
    *{box-sizing:border-box}

    .cv-editor-wrap{
      max-width:1000px;
      margin:0 auto;
      padding:24px 0 40px;
    }

    .cv-editor-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:1rem;
      margin-bottom:12px;
      flex-wrap:wrap;
    }

    .cv-editor-header a.btn-link{
      color:#cbd5e1;
      text-decoration:none;
      border:1px solid #334155;
      padding:6px 12px;
      border-radius:999px;
      font-size:.85rem;
      display:inline-flex;
      align-items:center;
      gap:.25rem;
      transition:all .18s ease-out;
      background:rgba(15,23,42,0.9);
      box-shadow:0 10px 24px rgba(15,23,42,0.85);
    }
    .cv-editor-header a.btn-link:hover{
      border-color:#64748b;
      transform:translateY(-1px);
      background:radial-gradient(circle at top left,rgba(59,130,246,0.25),rgba(15,23,42,0.98));
      color:#e5e7eb;
    }

    .cv-title-line{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:center;
      margin-bottom:16px;
      flex-wrap:wrap;
    }

    .cv-title-line h1{
      margin:0;
      font-size:1.35rem;
      font-weight:750;
      color:#f9fafb;
    }

    .cv-step-pill{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      background:#020617;
      border:1px solid #1f2937;
      border-radius:999px;
      padding:6px 12px;
      font-size:.8rem;
      color:#cbd5e1;
    }

    .cv-step-pill span.badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border-radius:50%;
      background:linear-gradient(120deg,#22c55e,#16a34a);
      color:#020617;
      font-weight:700;
      font-size:.7rem;
    }

    .cv-substrap{
      margin-top:6px;
      font-size:.85rem;
      color:#9ca3af;
    }

    .cv-substrap strong{
      color:#22c55e;
      font-weight:600;
    }

    .cv-upsell{
      margin-top:14px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(34,197,94,0.35);
      background:radial-gradient(circle at top left,rgba(34,197,94,0.16),transparent 55%);
      font-size:.85rem;
      color:#bbf7d0;
      display:flex;
      align-items:flex-start;
      gap:.6rem;
    }

    .cv-upsell .emoji{
      font-size:1.1rem;
    }

    .cv-upsell a{
      color:#a5b4fc;
      text-decoration:underline;
      text-decoration-thickness:1px;
    }

    .panel{
      background:#0f172a;
      border:1px solid #1f2937;
      border-radius:12px;
      padding:16px 14px 18px;
      margin-top:14px;
      box-shadow:0 18px 36px rgba(15,23,42,0.85);
    }

    .panel h2,
    .panel h3{
      margin:0 0 8px;
      font-size:1.05rem;
      color:#e5e7eb;
    }

    label{
      display:block;
      margin:8px 0 4px;
      color:#cbd5e1;
      font-size:14px;
    }

    input, textarea, select{
      width:100%;
      background:#020617;
      border:1px solid #334155;
      border-radius:8px;
      color:#e5e7eb;
      padding:10px;
      font:inherit;
    }
    textarea{min-height:120px}

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }

    .actions{
      margin-top:12px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    .btn{
      background:linear-gradient(120deg,#6366f1,#0ea5e9);
      border:1px solid transparent;
      border-radius:10px;
      padding:10px 14px;
      color:#fff;
      font-weight:700;
      cursor:pointer;
      font-size:.9rem;
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      text-decoration:none;
      box-shadow:0 14px 32px rgba(15,23,42,0.9);
      transition:all .18s ease-out;
    }
    .btn:hover{
      transform:translateY(-1px);
      box-shadow:0 18px 44px rgba(15,23,42,0.95);
    }

    .btn.secondary{
      background:transparent;
      border-color:#334155;
      color:#cbd5e1;
      box-shadow:none;
    }
    .btn.secondary:hover{
      border-color:#64748b;
      background:rgba(15,23,42,0.9);
    }

    .list{
      margin:8px 0 0;
      padding:0;
      list-style:none;
    }

    .item{
      padding:10px;
      border:1px solid #1f2937;
      border-radius:8px;
      margin-top:8px;
      background:#020617;
    }

    .muted{color:#94a3b8;font-size:.85rem}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-top:14px}

    .danger{color:#ef4444;font-size:.9rem}

    .cv-mini-cta{
      margin-top:8px;
      font-size:.8rem;
      color:#9ca3af;
    }
    .cv-mini-cta strong{
      color:#22c55e;
    }

    @media (max-width: 900px){
      .row{grid-template-columns:1fr;}
      .grid2,.grid3{grid-template-columns:1fr;}
      .cv-editor-header{flex-direction:column;align-items:flex-start;}
      .cv-title-line{flex-direction:column;align-items:flex-start;}
    }
  </style>

  {# JSON-LD pour SEO (Service / CV Builder) #}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Service",
    "name": "√âditeur de CV Immigration97",
    "provider": {
      "@type": "Organization",
      "name": "Immigration97"
    },
    "serviceType": "Cr√©ation de CV pour immigration, √©tudes et travail √† l'international",
    "description": "√âditeur de CV en 3 √©tapes avec mod√®les Canada, Europe, moderne et professionnel. Compatible ATS, export PDF, sections exp√©riences, comp√©tences, langues, projets et certifications.",
    "areaServed": {"@type": "Country", "name": "Global"}
  }
  </script>
{% endblock %}

{% block content %}
<main class="cv-editor-wrap">
  <header class="cv-editor-header">
    <a class="btn-link" href="{% url 'cv_generator:template_selection' %}">
      ‚üµ Changer de mod√®le
    </a>
    <a class="btn-link" href="{% url 'cv_generator:cv_list' %}">
      üìÑ Mes CV sauvegard√©s
    </a>
  </header>

  <div class="cv-title-line">
    <div>
      <h1>
        {% if cv.template and cv.template.style_type == 'canada' %}
          √âditeur de CV ‚Äî Mod√®le Canada
        {% elif cv.template and cv.template.style_type == 'europe' %}
          √âditeur de CV ‚Äî Mod√®le Europe
        {% elif cv.template and cv.template.style_type == 'modern' %}
          √âditeur de CV ‚Äî Mod√®le Moderne
        {% elif cv.template and cv.template.style_type == 'professional' %}
          √âditeur de CV ‚Äî Mod√®le Professionnel
        {% else %}
          √âditeur de CV ‚Äî 3 √©tapes rapides
        {% endif %}
      </h1>
      <p class="cv-substrap">
        Optimis√© pour <strong>les recruteurs & ATS</strong> ‚Äî remplis chaque √©tape, puis exporte ton CV en PDF
        pr√™t pour <strong>Canada, Europe, USA, UK‚Ä¶</strong>
      </p>
    </div>

    <div class="cv-step-pill">
      <span class="badge">{{ current_step }}</span>
      <span>√âtape actuelle</span>
    </div>
  </div>

  <div class="cv-upsell">
    <span class="emoji">üöÄ</span>
    <div>
      <strong>Astuce :</strong> avec l‚Äôabonnement <strong>Immigration97 Pro</strong>, tu peux cr√©er plusieurs CV,
      les adapter √† diff√©rents pays et les mettre √† jour sans limite.
      <br>
      <a href="{% url 'billing:access' %}">Activer mon acc√®s complet</a>
    </div>
  </div>

  {# ===================== √âTAPE 1 : infos personnelles ===================== #}
  {% if current_step == 1 %}
    <div class="panel">
      <h2>√âtape 1 ‚Äî Informations personnelles strat√©giques</h2>
      <p class="muted">
        Ces informations s‚Äôafficheront en haut de ton CV : c‚Äôest ta carte de visite.
        Utilise un <strong>titre de poste clair</strong> et un <strong>e-mail professionnel</strong>.
      </p>

      <form method="post" action="">
        {% csrf_token %}
        {% if form.non_field_errors %}
          <p class="danger">{{ form.non_field_errors }}</p>
        {% endif %}

        <div class="row">
          <div>
            <label>Nom</label>
            {{ form.nom }}
          </div>
          <div>
            <label>Pr√©nom</label>
            {{ form.prenom }}
          </div>
        </div>

        <div class="row">
          <div>
            <label>Email</label>
            {{ form.email }}
          </div>
          <div>
            <label>T√©l√©phone</label>
            {{ form.telephone }}
          </div>
        </div>

        <div class="row">
          <div>
            <label>Profession / Titre sur le CV</label>
            {{ form.profession }}
            <p class="cv-mini-cta">
              Exemple : <strong>D√©veloppeur Full-Stack junior</strong>, <strong>Infirmier(√®re) dipl√¥m√©(e)</strong>, <strong>√âtudiant(e) en Master‚Ä¶</strong>
            </p>
          </div>
          <div>
            <label>Pays cibl√©</label>
            {{ form.pays_cible }}
            <p class="cv-mini-cta">
              Ce champ aide √† adapter ton CV aux <strong>codes du pays</strong> (Canada, France, Belgique, etc.).
            </p>
          </div>
        </div>

        <div class="actions">
          <button class="btn" type="submit">
            Continuer ‚Üí √âtape 2 (Exp√©riences)
          </button>
          <a class="btn secondary" href="{% url 'wizard' %}">
            üß≠ V√©rifier mon parcours avec l‚Äôassistant √âligibilit√©
          </a>
        </div>
      </form>
    </div>
  {% endif %}

  {# ===================== √âTAPE 2 : exp√©riences ===================== #}
  {% if current_step == 2 %}
    <div class="panel">
      <h2>√âtape 2 ‚Äî Exp√©riences professionnelles</h2>
      <p class="muted">
        Ajoute chaque exp√©rience avec un <strong>intitul√© clair</strong> et une description orient√©e
        <strong>r√©sultats</strong> (chiffres, impact, responsabilit√©s).
      </p>

      <form method="post" action="">
        {% csrf_token %}

        <div class="row">
          <div>
            <label>Intitul√© du poste *</label>
            <input type="text" name="title" required />
          </div>
          <div>
            <label>Entreprise *</label>
            <input type="text" name="company" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Date d√©but (YYYY-MM-DD) *</label>
            <input type="date" name="start_date" required />
          </div>
          <div>
            <label>Date fin (optionnel)</label>
            <input type="date" name="end_date" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Lieu</label>
            <input type="text" name="location" />
          </div>
          <div></div>
        </div>

        <label>Description (une ligne = une puce) *</label>
        <textarea name="description_raw" required placeholder="- T√¢che cl√© 1
- T√¢che cl√© 2
- R√©sultat chiffr√© (ex : +25% de ventes)‚Ä¶"></textarea>

        <div class="actions">
          <button class="btn" type="submit">
            ‚ûï Ajouter l‚Äôexp√©rience
          </button>
          <a class="btn secondary" href="{% url 'cv_generator:create_cv_step3' cv.id %}">
            Passer √† l‚Äô√©tape 3 (Formations & comp√©tences)
          </a>
        </div>
      </form>

      <p class="cv-mini-cta">
        Plus tu ajoutes d‚Äôexp√©riences structur√©es, plus ton CV sera <strong>cr√©dible pour les recruteurs</strong>.
      </p>
    </div>

    <div class="panel">
      <h3>Exp√©riences ajout√©es</h3>
      <ul class="list">
        {% for e in experiences %}
          <li class="item">
            <div><strong>{{ e.title }}</strong> ‚Äî {{ e.company }}</div>
            <div class="muted">
              {{ e.start_date|date:"d/m/Y" }}
              {% if e.end_date %} ‚Äì {{ e.end_date|date:"d/m/Y" }}{% else %} ‚Äì Pr√©sent{% endif %}
              {% if e.location %} | {{ e.location }}{% endif %}
            </div>
            <div class="actions">
              <a class="btn secondary" href="{% url 'cv_generator:delete_experience' cv.id e.id %}">
                Supprimer
              </a>
            </div>
          </li>
        {% empty %}
          <li class="muted">Aucune exp√©rience pour l‚Äôinstant. Ajoute au moins une exp√©rience significative.</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {# ===================== √âTAPE 3 : formation / skills / etc. ===================== #}
  {% if current_step == 3 %}
    <div class="panel">
      <h2>√âtape 3 ‚Äî Finalisation de ton CV</h2>
      <p class="muted">
        Compl√®te ton CV avec les <strong>formations</strong>, <strong>comp√©tences</strong>, <strong>langues</strong>,
        <strong>certifications</strong>, <strong>b√©n√©volats</strong> et <strong>projets</strong>, puis
        <strong>exporte en PDF</strong>.
      </p>
    </div>

    <div class="grid2">
      <div class="panel">
        <h3>Formations</h3>
        <form method="post" action="{% url 'cv_generator:add_education' cv.id %}">
          {% csrf_token %}
          <label>Dipl√¥me</label>{{ education_form.diploma }}
          <label>√âtablissement</label>{{ education_form.institution }}
          <div class="row">
            <div><label>D√©but</label>{{ education_form.start_date }}</div>
            <div><label>Fin</label>{{ education_form.end_date }}</div>
          </div>
          <label>Lieu</label>{{ education_form.location }}
          <label>Description</label>{{ education_form.description }}
          <div class="actions"><button class="btn" type="submit">Ajouter</button></div>
        </form>

        <ul class="list">
          {% for ed in educations %}
            <li class="item">
              <div><strong>{{ ed.diploma }}</strong> ‚Äî {{ ed.institution }}</div>
              <div class="muted">
                {{ ed.start_date|date:"m/Y" }}{% if ed.end_date %} ‚Äì {{ ed.end_date|date:"m/Y" }}{% endif %}
                {% if ed.location %} | {{ ed.location }}{% endif %}
              </div>
              <div class="actions">
                <a class="btn secondary" href="{% url 'cv_generator:delete_education' cv.id ed.id %}">Supprimer</a>
              </div>
            </li>
          {% empty %}
            <li class="muted">Aucune formation. Ajoute au moins ton dernier dipl√¥me.</li>
          {% endfor %}
        </ul>
      </div>

      <div class="panel">
        <h3>R√©sum√© professionnel</h3>
        <form method="post" action="{% url 'cv_generator:update_summary' cv.id %}">
          {% csrf_token %}
          <textarea name="summary" placeholder="Court r√©sum√© d‚Äôimpact‚Ä¶">{{ cv.summary }}</textarea>
          <div class="actions">
            <button class="btn" type="submit">Enregistrer le r√©sum√©</button>
          </div>
        </form>
        <p class="cv-mini-cta">
          Un bon r√©sum√© = <strong>3 √† 5 lignes</strong> qui r√©sument ton profil, ton exp√©rience et ton objectif.
        </p>
      </div>
    </div>

    <div class="grid3">
      <div class="panel">
        <h3>Comp√©tences</h3>
        <form method="post" action="{% url 'cv_generator:add_skill' cv.id %}">
          {% csrf_token %}
          <label>Nom</label>{{ skill_form.name }}
          <label>Cat√©gorie</label>{{ skill_form.category }}
          {% if skill_form.level %}
            <label>Niveau</label>{{ skill_form.level }}
          {% endif %}
          <div class="actions"><button class="btn" type="submit">Ajouter</button></div>
        </form>
        <ul class="list">
          {% for s in skills %}
            <li class="item">
              {{ s.name }} <span class="muted">({{ s.get_category_display }})</span>
              <div class="actions">
                <a class="btn secondary" href="{% url 'cv_generator:delete_skill' cv.id s.id %}">Supprimer</a>
              </div>
            </li>
          {% empty %}
            <li class="muted">Aucune comp√©tence. Ajoute au moins 5 √† 8 comp√©tences cl√©s.</li>
          {% endfor %}
        </ul>
      </div>

      <div class="panel">
        <h3>Langues</h3>
        <form method="post" action="{% url 'cv_generator:add_language' cv.id %}">
          {% csrf_token %}
          <label>Langue</label>{{ language_form.name }}
          <label>Niveau</label>{{ language_form.level }}
          <div class="actions"><button class="btn" type="submit">Ajouter</button></div>
        </form>
        <ul class="list">
          {% for lg in languages %}
            <li class="item">
              {{ lg.name }} ‚Äî <span class="muted">{{ lg.get_level_display }}</span>
              <div class="actions">
                <a class="btn secondary" href="{% url 'cv_generator:delete_language' cv.id lg.id %}">Supprimer</a>
              </div>
            </li>
          {% empty %}
            <li class="muted">Ajoute au moins ta langue maternelle et une langue √©trang√®re.</li>
          {% endfor %}
        </ul>
      </div>

      <div class="panel">
        <h3>Certifications</h3>
        <form method="post" action="{% url 'cv_generator:add_certification' cv.id %}">
          {% csrf_token %}
          <label>Nom</label>{{ certification_form.name }}
          <label>Organisme</label>{{ certification_form.organization }}
          <label>Date d‚Äôobtention</label>{{ certification_form.date_obtained }}
          <div class="actions"><button class="btn" type="submit">Ajouter</button></div>
        </form>
        <ul class="list">
          {% for c in certifications %}
            <li class="item">
              {{ c.name }} ‚Äî <span class="muted">{{ c.organization }}</span>
              <div class="actions">
                <a class="btn secondary" href="{% url 'cv_generator:delete_certification' cv.id c.id %}">Supprimer</a>
              </div>
            </li>
          {% empty %}
            <li class="muted">Aucune certification (optionnel mais tr√®s appr√©ci√©).</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="grid2">
      <div class="panel">
        <h3>B√©n√©volat</h3>
        <form method="post" action="{% url 'cv_generator:add_volunteer' cv.id %}">
          {% csrf_token %}
          <label>Organisation</label>{{ volunteer_form.organization }}
          <label>R√¥le</label>{{ volunteer_form.role }}
          <div class="row">
            <div><label>D√©but</label>{{ volunteer_form.start_date }}</div>
            <div><label>Fin</label>{{ volunteer_form.end_date }}</div>
          </div>
          <label>Lieu</label>{{ volunteer_form.location }}
          <label>Description</label>{{ volunteer_form.description }}
          <div class="actions"><button class="btn" type="submit">Ajouter</button></div>
        </form>
        <ul class="list">
          {% for v in volunteers %}
            <li class="item">
              {{ v.role }} ‚Äî <span class="muted">{{ v.organization }}</span>
              <div class="actions">
                <a class="btn secondary" href="{% url 'cv_generator:delete_volunteer' cv.id v.id %}">Supprimer</a>
              </div>
            </li>
          {% empty %}
            <li class="muted">Le b√©n√©volat valorise ton engagement (surtout pour les visas √©tudes / travail).</li>
          {% endfor %}
        </ul>
      </div>

      <div class="panel">
        <h3>Projets</h3>
        <form method="post" action="{% url 'cv_generator:add_project' cv.id %}">
          {% csrf_token %}
          <label>Titre</label>{{ project_form.title }}
          <label>Description</label>{{ project_form.description }}
          <div class="row">
            <div><label>D√©but</label>{{ project_form.start_date }}</div>
            <div><label>Fin</label>{{ project_form.end_date }}</div>
          </div>
          <label>URL</label>{{ project_form.url }}
          <label>Technologies</label>{{ project_form.technologies }}
          <div class="actions"><button class="btn" type="submit">Ajouter</button></div>
        </form>
        <ul class="list">
          {% for p in projects %}
            <li class="item">
              <strong>{{ p.title }}</strong>
              {% if p.url %}<span class="muted"> ‚Äî {{ p.url }}</span>{% endif %}
              <div class="actions">
                <a class="btn secondary" href="{% url 'cv_generator:delete_project' cv.id p.id %}">Supprimer</a>
              </div>
            </li>
          {% empty %}
            <li class="muted">Ajoute 1 √† 3 projets pour montrer ton savoir-faire (technique ou non).</li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <div class="panel">
      <h3>Finaliser ton CV</h3>
      <p class="muted">
        Quand tout est bon, marque ton CV comme termin√© puis exporte la version PDF.
        Tu pourras toujours revenir modifier si besoin.
      </p>
      <div class="actions">
        <form method="post" action="{% url 'cv_generator:complete_cv' cv.id %}" onsubmit="event.preventDefault(); finalizeCV(this);">
          {% csrf_token %}
          <button class="btn" type="submit">
            ‚úÖ Marquer comme termin√©
          </button>
        </form>
        <a class="btn secondary" href="{% url 'cv_generator:export_pdf' cv.id %}">
          üìÑ Exporter en PDF
        </a>
        <a class="btn secondary" href="{% url 'billing:access' %}">
          üîê D√©bloquer tous les modules Immigration97
        </a>
      </div>
    </div>
  {% endif %}
</main>
{% endblock %}

{% block body_end %}
  {{ block.super }}
  <script>
    async function finalizeCV(form){
      try{
        const res = await fetch(form.action, {
          method:'POST',
          headers:{'X-CSRFToken': '{{ csrf_token }}'}
        });
        if (res.ok){
          window.location.href = "{% url 'cv_generator:cv_list' %}";
        }else{
          alert("Une erreur est survenue.");
        }
      }catch(e){
        alert("R√©seau indisponible.");
      }
    }
  </script>
{% endblock %}
