{% extends "base.html" %}
{% load static %}

{% block title %}Choisissez votre mod√®le de CV optimis√© | Immigration97{% endblock %}
{% block meta_description %}
Choisissez un mod√®le de CV optimis√© (Canada, Europe, Moderne, Professionnel) avant de remplir l‚Äô√©diteur guid√©. Compatible ATS et adapt√© aux candidatures d‚Äôimmigration.
{% endblock %}

{% block head_extra %}
  <link rel="canonical" href="{{ request.build_absolute_uri }}">

  <style>
    .cv-page-wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 20px 40px;
      color: #e5e7eb;
    }
    .cv-page-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:0.75rem;
      margin-bottom:1.25rem;
      flex-wrap:wrap;
    }
    .cv-page-brand{
      font-weight:700;
      font-size:.95rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#e5e7eb;
      opacity:.9;
    }
    .cv-pill-link{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.9);
      color:#e5e7eb;
      font-size:.85rem;
      text-decoration:none;
      transition:.15s;
    }
    .cv-pill-link:hover{
      border-color:rgba(129,140,248,0.9);
      color:#f9fafb;
    }

    .cv-title{
      font-size:1.6rem;
      font-weight:800;
      margin:4px 0 4px;
      color:#f9fafb;
    }
    .cv-lead{
      font-size:.95rem;
      color:#9ca3af;
      margin:0 0 16px;
      max-width:620px;
    }
    .cv-lead strong{ color:#a5b4fc; }

    .cv-badge-row{
      display:flex;
      flex-wrap:wrap;
      gap:0.5rem;
      margin-bottom:0.75rem;
    }
    .cv-badge{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.5);
      background:rgba(15,23,42,0.9);
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.06em;
      color:#cbd5e1;
    }
    .cv-badge--accent{
      border-color:rgba(52,211,153,0.9);
      background:rgba(16,185,129,0.16);
      color:#bbf7d0;
    }

    .cv-grid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:18px;
      margin-top:18px;
    }
    @media (max-width:1024px){
      .cv-grid{ grid-template-columns:repeat(2,minmax(0,1fr)); }
    }
    @media (max-width:640px){
      .cv-grid{ grid-template-columns:minmax(0,1fr); }
    }

    .cv-card{
      background:#020617;
      border-radius:14px;
      border:1px solid #1f2937;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      box-shadow:0 16px 40px rgba(15,23,42,0.85);
    }
    .cv-thumb{
      height:150px;
      background:#020617 url("{% static 'cv_generator/cv-thumb.svg' %}") center/110px no-repeat;
      border-bottom:1px solid #1f2937;
      position:relative;
    }
    .cv-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .cv-card-body{
      padding:14px 14px 10px;
    }
    .cv-card-title{
      font-weight:700;
      margin:2px 0;
      color:#f9fafb;
      font-size:.97rem;
    }
    .cv-card-tag{
      display:inline-block;
      margin:6px 0 8px;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid #334155;
      color:#cbd5e1;
      font-size:11px;
    }
    .cv-card-desc{
      color:#cbd5e1;
      font-size:.85rem;
      min-height:44px;
    }
    .cv-card-actions{
      padding:10px 14px 14px;
    }
    .cv-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:100%;
      padding:9px 12px;
      border-radius:10px;
      border:1px solid transparent;
      background:linear-gradient(120deg,#6366f1,#0ea5e9);
      color:#f9fafb;
      font-weight:700;
      font-size:.9rem;
      cursor:pointer;
      transition:.16s;
      box-shadow:0 14px 30px rgba(30,64,175,0.55);
    }
    .cv-btn:hover{
      filter:brightness(1.04);
      transform:translateY(-1px);
      box-shadow:0 18px 40px rgba(30,64,175,0.8);
    }
    .cv-btn:disabled{
      opacity:.6;
      cursor:not-allowed;
      transform:none;
      box-shadow:none;
    }

    .cv-empty{
      padding:26px;
      border-radius:12px;
      border:1px dashed #334155;
      text-align:center;
      color:#9ca3af;
      margin-top:20px;
      font-size:.9rem;
      background:rgba(15,23,42,0.9);
    }

    .cv-bottom-cta{
      margin-top:26px;
      padding:16px 18px;
      border-radius:16px;
      border:1px solid rgba(79,70,229,0.7);
      background:radial-gradient(circle at top left,rgba(79,70,229,0.25),transparent 60%),
                 rgba(15,23,42,0.96);
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .cv-bottom-cta-title{
      font-weight:700;
      font-size:1rem;
      color:#e5e7eb;
    }
    .cv-bottom-cta-text{
      font-size:.85rem;
      color:#cbd5e1;
    }
    .cv-bottom-cta strong{ color:#a5b4fc; }

    .cv-bottom-cta-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .cv-bottom-btn-primary{
      padding:8px 14px;
      border-radius:999px;
      border:none;
      background:linear-gradient(120deg,#4ade80,#22c55e,#22c55e,#6366f1);
      color:#020617;
      font-weight:700;
      font-size:.85rem;
      text-decoration:none;
      box-shadow:0 14px 36px rgba(22,163,74,0.75);
    }
    .cv-bottom-btn-secondary{
      padding:8px 14px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      background:transparent;
      color:#e5e7eb;
      font-size:.85rem;
      text-decoration:none;
    }
  </style>
{% endblock %}

{% block content %}
<div class="cv-page-wrap">

  <header class="cv-page-header">
    <div>
      <div class="cv-page-brand">Immigration97 ¬∑ CV Generator</div>
      <div class="cv-badge-row">
        <span class="cv-badge cv-badge--accent">√âtape 1 ‚Äî Choisir un mod√®le</span>
        <span class="cv-badge">Compatible ATS ¬∑ Canada / Europe / US</span>
      </div>
    </div>

    <a href="{% url 'cv_generator:cv_list' %}" class="cv-pill-link">
      üìÇ Voir mes CV existants
    </a>
  </header>

  <h1 class="cv-title">Choisissez le mod√®le de CV qui vous met le mieux en valeur</h1>
  <p class="cv-lead">
    S√©lectionnez un design adapt√© √† votre <strong>pays cible</strong> et √† votre <strong>style</strong>.
    Vos informations seront ensuite collect√©es dans un √©diteur guid√© en 3 √©tapes, puis
    export√©es en PDF compatible ATS.
  </p>

  {% if templates %}
    <div class="cv-grid">
      {% for t in templates %}
        {% with st=t.style_type|lower %}
          {% if st in 'canada,europe,modern,professional' %}
            <article class="cv-card">
              <div class="cv-thumb">
                {% if t.thumbnail %}
                  <img src="{{ t.thumbnail.url }}" alt="Aper√ßu mod√®le {{ t.name }}">
                {% endif %}
              </div>
              <div class="cv-card-body">
                <div class="cv-card-title">
                  {% if st == 'canada' %}CV Canada (sans photo)
                  {% elif st == 'europe' %}CV Europe
                  {% elif st == 'modern' %}CV Moderne
                  {% elif st == 'professional' %}CV Professionnel
                  {% else %}{{ t.name }}{% endif %}
                </div>
                <div class="cv-card-tag">
                  {% if st == 'canada' %}Recommand√© pour Canada / USA{% elif st == 'europe' %}Adapt√© France / Belgique / UE{% elif st == 'modern' %}Profil dynamique & tech{% else %}Classique & sobre{% endif %}
                </div>
                <div class="cv-card-desc">
                  {% if st == 'canada' %}
                    Format orient√© march√© nord-am√©ricain, sans photo ni √¢ge, id√©al pour l‚Äôimmigration au Canada.
                  {% elif st == 'europe' %}
                    Style europ√©en lisible et structur√©, avec sections classiques (formation, exp√©riences, comp√©tences).
                  {% elif st == 'modern' %}
                    Design contemporain, hi√©rarchie visuelle forte, parfait pour les profils digitaux et tech.
                  {% else %}
                    Mod√®le sobre et robuste, compatible avec tous les secteurs (administration, finance, √©ducation, etc.).
                  {% endif %}
                </div>
              </div>
              <div class="cv-card-actions">
                <button id="btn-{{ t.id }}" class="cv-btn" onclick="chooseTemplate({{ t.id }})">
                  Choisir ce mod√®le et passer √† l‚Äô√©dition
                </button>
              </div>
            </article>
          {% endif %}
        {% endwith %}
      {% endfor %}
    </div>
  {% else %}
    <div class="cv-empty">
      Aucun mod√®le actif pour le moment.  
      Active au moins un template ¬´ Canada ¬ª, ¬´ Europe ¬ª, ¬´ Moderne ¬ª ou ¬´ Professionnel ¬ª dans l‚Äôadmin Django.
    </div>
  {% endif %}

  {# Bandeau CTA bas de page pour pousser l‚Äôaction #}
  <section class="cv-bottom-cta" aria-label="Finaliser le choix du mod√®le">
    <div class="cv-bottom-cta-title">
      Commence par un mod√®le adapt√© √† ton objectif (Canada, Europe, job tech, fonction publique‚Ä¶)
    </div>
    <p class="cv-bottom-cta-text">
      Tu pourras toujours <strong>changer de mod√®le plus tard</strong> en dupliquant ton CV.
      L‚Äôimportant est de lancer la premi√®re version pour ne plus repousser tes candidatures.
    </p>
    <div class="cv-bottom-cta-row">
      {% if templates %}
        {# Bouton qui clique le premier mod√®le dispo (pratique mobile) #}
        {% with first=templates.0 %}
          <button type="button"
                  class="cv-bottom-btn-primary"
                  onclick="chooseTemplate({{ first.id }})">
            Commencer avec le premier mod√®le disponible
          </button>
        {% endwith %}
      {% endif %}

      <a href="{% url 'billing:access' %}" class="cv-bottom-btn-secondary">
        Voir les acc√®s complets Immigration97 (photos, lettres, guides‚Ä¶)
      </a>
    </div>
  </section>

</div>

<script>
  function csrfToken(){
    const meta = document.querySelector('meta[name="csrf-token"]');
    if (meta && meta.content && meta.content !== 'NOTPROVIDED') return meta.content;
    const m = document.cookie.match('(^|;)\\s*csrftoken\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  const DEFAULT_BTN_TEXT = 'Choisir ce mod√®le et passer √† l‚Äô√©dition';

  function resetButtons(){
    document.querySelectorAll('.cv-btn').forEach(b => {
      b.disabled = false;
      b.textContent = DEFAULT_BTN_TEXT;
    });
    localStorage.removeItem('cvCreating');
  }
  window.addEventListener('pageshow', resetButtons);
  document.addEventListener('DOMContentLoaded', resetButtons);

  async function chooseTemplate(templateId){
    const btn = document.getElementById('btn-'+templateId);
    try{
      localStorage.setItem('cvCreating', String(templateId));
      if (btn){
        btn.disabled = true;
        btn.textContent = 'Cr√©ation du CV‚Ä¶';
      }

      const res = await fetch("{% url 'cv_generator:set_template' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken()
        },
        body: JSON.stringify({ template_id: templateId })
      });

      const data = await res.json();
      if (!data || !data.success){
        alert("Erreur : " + (data && data.error ? data.error : "impossible de cr√©er le CV."));
        resetButtons();
        return;
      }
      window.location.href = data.data.redirect_url;

    }catch(e){
      console.error(e);
      alert("Erreur r√©seau. V√©rifie ta connexion et r√©essaie.");
      resetButtons();
    } finally {
      setTimeout(resetButtons, 8000);
    }
  }
</script>
{% endblock %}
