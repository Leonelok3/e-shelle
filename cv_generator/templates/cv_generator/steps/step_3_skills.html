{# ==========================
   cv_generator/steps/step_3_skills.html
   VERSION SOLIDE (corrig√©e)
   - R√©sum√©: affiche FR d'abord puis EN (fallback)
   - Langues: affiche langue/niveau OU name/level (fallback)
   - Delete langue: route = delete_language (comme ton urls.py)
   - JS IA summary: accepte {"summary":...} OU {"data":[...]} OU {"data":"..."}
   ========================== #}

{% extends "base.html" %}
{% load static %}

{% block body_class %}cv-generator cv-step-finalization{% endblock %}
{% block app_scope %}cv-generator{% endblock %}

{% block title %}Finaliser CV professionnel Canada - Comp√©tences, Formations, Langues ATS | Immigration97{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cv_generator.css' %}">
{% endblock %}

{% block content %}

<nav class="cv-breadcrumb" aria-label="Fil d'Ariane">
  <ol>
    <li><a href="{% url 'cv_generator:index' %}">Accueil</a></li>
    <li><a href="{% url 'cv_generator:cv_list' %}">Mes CV</a></li>
    <li><a href="{% url 'cv_generator:create_cv' cv.id %}">√âtape 1</a></li>
    <li><a href="{% url 'cv_generator:create_cv_step2' cv.id %}">√âtape 2</a></li>
    <li><span>√âtape 3 - Finalisation</span></li>
  </ol>
</nav>

<main class="app-main cv-generator">
  <section class="cv-step-box">

    <header class="cv-step-header">
      <h1 class="cv-step-title">
        √âtape 3 ‚Äî Finalisation de votre CV professionnel Canada ATS
      </h1>
      <p class="cv-step-help">
        Compl√©tez votre <strong>CV professionnel</strong> avec les √©l√©ments cl√©s pour maximiser
        vos chances aupr√®s des <strong>recruteurs canadiens</strong> et des <strong>syst√®mes ATS</strong>.
      </p>
    </header>

    <!-- ================= MESSAGES ================= -->
    {% if messages %}
      {% for message in messages %}
        <div class="cv-alert {% if message.tags %}{{ message.tags }}{% endif %}" role="alert">
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <!-- ================= SECTION: R√âSUM√â ================= -->
    <fieldset class="cv-form-section">
      <legend class="cv-section-title">üìù R√©sum√© professionnel optimis√© ATS</legend>

      <aside class="cv-alert info">
        <p>
          üí° <strong>Le r√©sum√© professionnel</strong> est lu en premier par les recruteurs et les ATS.
          Il doit contenir en <strong>3-4 lignes</strong> : votre <strong>m√©tier</strong>,
          <strong>ann√©es d'exp√©rience</strong>, <strong>comp√©tences cl√©s</strong> et
          <strong>objectif professionnel</strong>.
        </p>
      </aside>

      <form method="post" action="{% url 'cv_generator:create_cv_step3' cv.id %}" class="cv-step-form">
        {% csrf_token %}

        <div class="form-group">
          <label for="id_summary" class="required">
            R√©sum√© professionnel
          </label>
          <textarea
            id="id_summary"
            name="summary"
            class="form-control"
            rows="4"
            required
            placeholder="Ex : Technicien de maintenance industrielle avec 5 ans d'exp√©rience en environnement manufacturier. Expertise en maintenance pr√©ventive, d√©pannage √©lectrom√©canique et optimisation des √©quipements. Recherche un poste au Canada pour contribuer √† l'excellence op√©rationnelle.">{{ cv.resume_professionnel|default:cv.summary|default:"" }}</textarea>
        </div>

        <div class="cv-inline-actions">
          <button type="submit" class="cv-btn-primary" name="save_summary">
            üíæ Sauvegarder le r√©sum√©
          </button>

          <button
            type="button"
            class="cv-btn-secondary"
            id="ai-summary-btn"
            data-url="{% url 'cv_generator:generate_ai_summary' cv.id %}">
            ü§ñ G√©n√©rer avec l'IA
          </button>

          <button
            type="button"
            class="cv-btn-secondary"
            id="translate-summary-btn"
            data-url="{% url 'cv_generator:translate_summary' cv.id %}">
            üåê Traduire
          </button>
        </div>
      </form>

      <div id="ai-summary-result" role="status" aria-live="polite"></div>
    </fieldset>

    <hr class="cv-divider">

    <!-- ================= SECTION: FORMATIONS ================= -->
    <fieldset class="cv-form-section">
      <legend class="cv-section-title">üéì Formations et dipl√¥mes</legend>

      <form method="post"
            action="{% url 'cv_generator:create_cv_step3' cv.id %}"
            class="cv-step-form">

        {% csrf_token %}
        <input type="hidden" name="action" value="add_formation">

        <div class="cv-form-row">
          <div class="form-group">
            <label for="id_diplome" class="required">Dipl√¥me / Certification</label>
            <input type="text" id="id_diplome" name="diplome" class="form-control" required
                   placeholder="Ex: DEC en √âlectrom√©canique">
          </div>

          <div class="form-group">
            <label for="id_etablissement" class="required">√âtablissement</label>
            <input type="text" id="id_etablissement" name="etablissement" class="form-control" required
                   placeholder="Ex: C√©gep de Trois-Rivi√®res">
          </div>
        </div>

        <div class="cv-form-row">
          <div class="form-group">
            <label for="id_start_date">Date de d√©but</label>
            <input type="date" id="id_start_date" name="start_date" class="form-control">
          </div>

          <div class="form-group">
            <label for="id_end_date">Date de fin</label>
            <input type="date" id="id_end_date" name="end_date" class="form-control">
            <small class="cv-muted">Laissez vide si formation en cours</small>
          </div>
        </div>

        <button type="submit" class="cv-btn-primary">‚ûï Ajouter cette formation</button>
      </form>

      {% if formations %}
        <div class="cv-list-container">
          <h3 class="cv-list-title">Formations enregistr√©es</h3>
          <ul class="cv-list">
            {% for edu in formations %}
              <li class="cv-list-item">
                <div class="cv-list-header">
                  <strong>{{ edu.diplome|default:edu.diploma }}</strong>
                  <span class="cv-list-meta">{{ edu.etablissement|default:edu.institution }}</span>
                </div>

                <p class="cv-list-dates">
                  {% if edu.start_date %}
                    {{ edu.start_date|date:"m/Y" }}
                  {% endif %}
                  {% if edu.start_date and edu.end_date %}
                    ‚Üí
                  {% endif %}
                  {% if edu.end_date %}
                    {{ edu.end_date|date:"m/Y" }}
                  {% elif edu.start_date %}
                    En cours
                  {% elif edu.annee_obtention %}
                    {{ edu.annee_obtention }}
                  {% endif %}
                </p>

                <a href="{% url 'cv_generator:delete_formation' cv.id edu.id %}"
                   class="cv-btn-delete-inline"
                   onclick="return confirm('Supprimer cette formation ?')">üóëÔ∏è</a>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </fieldset>

    <hr class="cv-divider">

    <!-- ================= SECTION: COMP√âTENCES ================= -->
    <fieldset class="cv-form-section">
      <legend class="cv-section-title">üß† Comp√©tences techniques</legend>

      <form method="post"
            action="{% url 'cv_generator:create_cv_step3' cv.id %}"
            class="cv-step-form">

        {% csrf_token %}
        <input type="hidden" name="action" value="add_competence">

        <div class="form-group">
          <label for="id_competence" class="required">Comp√©tence</label>
          <input type="text" id="id_competence" name="competence" class="form-control" required
                 placeholder="Ex: Python, Leadership, Excel">
        </div>

        <button type="submit" class="cv-btn-primary">‚ûï Ajouter</button>
      </form>

      {% if competences %}
        <div class="cv-list-container">
          <h3 class="cv-list-title">Comp√©tences enregistr√©es</h3>
          <ul class="cv-skills-grid">
            {% for comp in competences %}
              <li class="cv-skill-tag">
                {{ comp.nom }}
                <a href="{% url 'cv_generator:delete_competence' cv.id comp.id %}"
                   class="cv-skill-delete"
                   onclick="return confirm('Supprimer cette comp√©tence ?')">‚úï</a>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </fieldset>

    <hr class="cv-divider">

    <!-- ================= SECTION: LANGUES (CORRIG√âE) ================= -->
    <fieldset class="cv-form-section">
      <legend class="cv-section-title">üåç Langues parl√©es</legend>

      <form method="post"
            action="{% url 'cv_generator:create_cv_step3' cv.id %}"
            class="cv-step-form">

        {% csrf_token %}
        <input type="hidden" name="action" value="add_langue">

        <div class="cv-form-row">
          <div class="form-group">
            <label for="id_langue" class="required">Langue</label>
            <input type="text" id="id_langue" name="langue" class="form-control" required
                   placeholder="Ex: Fran√ßais, English, Deutsch">
          </div>

          <div class="form-group">
            <label for="id_niveau" class="required">Niveau</label>
            <input type="text" id="id_niveau" name="niveau" class="form-control" required
                   placeholder="Ex: Langue maternelle, Courant (C1), Interm√©diaire (B2)">
          </div>
        </div>

        <button type="submit" class="cv-btn-primary">‚ûï Ajouter</button>
      </form>

      {% if langues %}
        <div class="cv-list-container">
          <h3 class="cv-list-title">Langues enregistr√©es</h3>
          <ul class="cv-list">
            {% for lang in langues %}
              <li class="cv-list-item">
                <div class="cv-list-header">
                  <strong>{{ lang.langue|default:lang.name }}</strong>
                  <span class="cv-list-badge">{{ lang.niveau|default:lang.level }}</span>
                </div>

                {# ‚úÖ IMPORTANT: route = delete_language (ton urls.py) #}
                <a href="{% url 'cv_generator:delete_language' cv.id lang.id %}"
                   class="cv-btn-delete-inline"
                   onclick="return confirm('Supprimer cette langue ?')">üóëÔ∏è</a>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% endif %}
    </fieldset>

    <hr class="cv-divider">

    <!-- ================= SECTION: ANALYSE ATS ================= -->
    <fieldset class="cv-form-section cv-ats-section">
      <legend class="cv-section-title">üìä Analyse ATS gratuite</legend>

      <div id="ats-result" class="cv-ats-result" role="status" aria-live="polite">
        <p class="cv-empty">Cliquez pour analyser la compatibilit√© ATS de votre CV.</p>
      </div>

      <button type="button" class="cv-btn-primary cv-ats-btn" id="ats-btn"
              data-url="{% url 'cv_generator:ats_score' cv.id %}">
        üîç Analyser mon CV (ATS)
      </button>
    </fieldset>

    <!-- ================= BOUTON FINAL ================= -->
    <div class="mt-5 pt-4 border-top">
      <div class="card border-success">
        <div class="card-body text-center">
          <h4 class="card-title text-success">
            ‚úÖ Votre CV est presque pr√™t !
          </h4>
          <p class="card-text">
            Vous avez ajout√© <strong>{{ experiences.count }} exp√©rience(s)</strong>,
            <strong>{{ formations.count }} formation(s)</strong> et
            <strong>{{ competences.count }} comp√©tence(s)</strong>.<br>
            Passez √† l'√©tape finale pour voir l'aper√ßu complet et t√©l√©charger.
          </p>

          <div class="d-flex justify-content-center gap-3">
            <a href="{% url 'cv_generator:create_cv_step2' cv.id %}" class="cv-btn-secondary">
              ‚¨ÖÔ∏è Retour aux exp√©riences
            </a>

            <a href="{% url 'cv_generator:finalize_cv' cv.id %}"
               class="btn btn-success btn-lg px-5">
              üëÅÔ∏è VOIR L'APER√áU FINAL & T√âL√âCHARGER
            </a>
          </div>

          <p class="text-muted mt-3 small">
            Sur la page finale : Aper√ßu complet ‚Ä¢ T√©l√©chargement PDF ‚Ä¢ Score ATS d√©taill√©
          </p>
        </div>
      </div>
    </div>

  </section>
</main>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/cv_generator.js' %}"></script>
<script>
function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
}

function pickSummaryFromResponse(data) {
  // Supporte:
  // - {summary: "..."}
  // - {data: ["...", "..."]}  (ton generate_summary renvoie souvent √ßa)
  // - {data: "..."}
  if (!data) return "";
  if (typeof data.summary === "string" && data.summary.trim()) return data.summary.trim();

  if (Array.isArray(data.data) && data.data.length) {
    // si liste de suggestions, prendre la premi√®re
    const first = data.data[0];
    if (typeof first === "string" && first.trim()) return first.trim();
    return String(first || "").trim();
  }

  if (typeof data.data === "string" && data.data.trim()) return data.data.trim();
  return "";
}

document.addEventListener("DOMContentLoaded", function () {

  // IA SUMMARY
  const aiBtn = document.getElementById("ai-summary-btn");
  if (aiBtn) {
    aiBtn.addEventListener("click", function () {
      const textarea = document.getElementById("id_summary");
      const resultBox = document.getElementById("ai-summary-result");
      const originalText = aiBtn.innerText;

      aiBtn.disabled = true;
      aiBtn.innerText = "‚è≥ G√©n√©ration...";

      fetch(aiBtn.dataset.url, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "Content-Type": "application/json"
        },
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(data => {
        const summary = pickSummaryFromResponse(data);
        if (summary) {
          textarea.value = summary;
          resultBox.innerHTML = '<div class="cv-alert success">‚úÖ R√©sum√© g√©n√©r√© !</div>';
        } else {
          resultBox.innerHTML = '<div class="cv-alert warning">‚ö†Ô∏è Aucune suggestion retourn√©e.</div>';
        }
      })
      .catch(() => {
        resultBox.innerHTML = '<div class="cv-alert error">‚ùå Erreur</div>';
      })
      .finally(() => {
        aiBtn.innerText = originalText;
        aiBtn.disabled = false;
      });
    });
  }

  // TRADUCTION
  const translateBtn = document.getElementById("translate-summary-btn");
  if (translateBtn) {
    translateBtn.addEventListener("click", function () {
      const textarea = document.getElementById("id_summary");
      const resultBox = document.getElementById("ai-summary-result");
      const originalText = translateBtn.innerText;

      translateBtn.disabled = true;
      translateBtn.innerText = "‚è≥ Traduction...";

      fetch(translateBtn.dataset.url, {
        method: "POST",
        headers: {
          "X-CSRFToken": getCSRFToken(),
          "Content-Type": "application/json"
        },
        body: JSON.stringify({})
      })
      .then(res => res.json())
      .then(data => {
        if (data.translated) {
          textarea.value = data.translated;
          resultBox.innerHTML = '<div class="cv-alert success">‚úÖ Traduit !</div>';
        } else {
          resultBox.innerHTML = '<div class="cv-alert warning">‚ö†Ô∏è Rien √† traduire.</div>';
        }
      })
      .catch(() => {
        resultBox.innerHTML = '<div class="cv-alert error">‚ùå Erreur</div>';
      })
      .finally(() => {
        translateBtn.innerText = originalText;
        translateBtn.disabled = false;
      });
    });
  }

  // ATS SCORE
  const atsBtn = document.getElementById("ats-btn");
  if (atsBtn) {
    atsBtn.addEventListener("click", function () {
      const resultBox = document.getElementById("ats-result");
      const originalText = atsBtn.innerText;

      atsBtn.disabled = true;
      atsBtn.innerText = "‚è≥ Analyse...";

      fetch(atsBtn.dataset.url, { method: "GET" })
      .then(res => res.json())
      .then(data => {
        const score = data.score || 0;
        const feedback = data.feedback || [];

        let scoreClass = score >= 80 ? "success" : score >= 60 ? "warning" : "error";
        let scoreEmoji = score >= 80 ? "‚úÖ" : score >= 60 ? "‚ö†Ô∏è" : "‚ùå";

        resultBox.innerHTML = `
          <div class="cv-alert ${scoreClass}">
            <h4>${scoreEmoji} Score ATS : ${score} / 100</h4>
            ${feedback.length > 0 ? `
              <p><strong>Recommandations :</strong></p>
              <ul>${feedback.map(f => `<li>‚Ä¢ ${f}</li>`).join('')}</ul>
            ` : `<p>‚úÖ Excellent ! CV bien optimis√© ATS.</p>`}
          </div>
        `;
      })
      .catch(() => {
        resultBox.innerHTML = '<div class="cv-alert error">‚ùå Erreur analyse</div>';
      })
      .finally(() => {
        atsBtn.innerText = originalText;
        atsBtn.disabled = false;
      });
    });
  }

});
</script>
{% endblock %}
