{% extends "base.html" %}
{% load static %}

{% block body_class %}cv-generator cv-step-experience{% endblock %}
{% block app_scope %}cv-generator{% endblock %}

{% block title %}Ajouter exp√©riences professionnelles CV Canada - Optimisation ATS | Immigration97{% endblock %}

{% block meta_description %}
Ajoutez vos exp√©riences professionnelles pour cr√©er un CV conforme aux standards canadiens ATS. Optimisation IA pour recruteurs Canada, reformulation automatique, templates NOC et mots-cl√©s sectoriels.
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cv_generator.css' %}">
{% endblock %}

{% block content %}

<!-- ================= BREADCRUMB SEO ================= -->
<nav class="cv-breadcrumb" aria-label="Fil d'Ariane">
  <ol>
    <li><a href="{% url 'cv_generator:index' %}">Accueil G√©n√©rateur CV</a></li>
    <li><a href="{% url 'cv_generator:cv_list' %}">Mes CV</a></li>
    <li><a href="{% url 'cv_generator:create_cv' cv.id %}">√âtape 1 - Informations</a></li>
    <li><span>√âtape 2 - Exp√©riences professionnelles</span></li>
  </ol>
</nav>

<!-- ================= MAIN SECTION ================= -->
<main class="app-main cv-generator">
  <section class="cv-step-box">

    <!-- ================= HEADER ================= -->
    <header class="cv-step-header">
      <h1 class="cv-step-title">
        √âtape 2 ‚Äî Exp√©riences professionnelles pour CV Canada ATS
      </h1>
      <p class="cv-step-help">
        Cette √©tape est <strong>essentielle</strong> pour votre <strong>CV Canada</strong>.
        Les recruteurs canadiens et les <strong>syst√®mes ATS</strong> accordent une importance majeure 
        aux exp√©riences avec <strong>verbes d'action</strong>, <strong>r√©sultats quantifi√©s</strong> et 
        <strong>mots-cl√©s sectoriels</strong>.
      </p>
    </header>

    <!-- ================= LISTE DES EXP√âRIENCES EXISTANTES ================= -->
    {% if experiences %}
      <section class="cv-experiences-list" aria-labelledby="experiences-heading">
        <h2 id="experiences-heading" class="cv-section-title">
          Exp√©riences professionnelles enregistr√©es
        </h2>

        <ul class="cv-list" role="list">
          {% for e in experiences %}
            <li class="cv-list-item cv-experience-item" role="listitem">

              <!-- En-t√™te exp√©rience -->
              <div class="cv-exp-header">
                <h3 class="cv-exp-title">
                  <strong>{{ e.title }}</strong>
                </h3>
                <p class="cv-exp-company">{{ e.company }}</p>
                <p class="cv-exp-dates">
                  {{ e.start_date|date:"F Y" }}
                  ‚Üí
                  {% if e.end_date %}
                    {{ e.end_date|date:"F Y" }}
                  {% else %}
                    <span>novembre 2025</span>
                  {% endif %}
                </p>
              </div>

              <!-- Version optimis√©e IA -->
              {% if e.description_ai %}
                <div class="cv-ai-box" role="region" aria-label="Version optimis√©e Canada ATS">
                  <h4 class="cv-ai-title">
                    üá®üá¶ <strong>Version optimis√©e Canada (ATS-friendly)</strong>
                  </h4>
                  <div class="cv-ai-content">
                    {{ e.description_ai|linebreaks }}
                  </div>
                  <p class="cv-ai-badge">
                    ‚úÖ <strong>Conforme standards recrutement Canada</strong> : 
                    Verbes d'action, r√©sultats quantifi√©s, mots-cl√©s NOC
                  </p>
                </div>
              {% else %}
                <aside class="cv-tip-box" role="complementary">
                  <p class="cv-muted">
                    üí° <strong>Conseil d'expert :</strong> 
                    Optimisez cette exp√©rience avec notre <strong>IA Canada ATS</strong> pour :
                  </p>
                  <ul class="cv-tip-list">
                    <li>‚úì Reformulation en <strong>verbes d'action</strong></li>
                    <li>‚úì Quantification des <strong>r√©sultats mesurables</strong></li>
                    <li>‚úì Int√©gration des <strong>mots-cl√©s NOC</strong></li>
                    <li>‚úì Conformit√© <strong>ATS</strong></li>
                  </ul>
                </aside>
              {% endif %}

              <!-- Actions -->
              <div class="cv-exp-actions">
                <button
                  type="button"
                  class="cv-btn-ai"
                  onclick="generateTasks(this)"
                  data-url="{% url 'cv_generator:generate_experience_tasks' cv.id e.id %}"
                  aria-label="Optimiser cette exp√©rience pour le format Canada ATS">
                  ü§ñ Optimiser pour le Canada (ATS)
                </button>

                <a href="{% url 'cv_generator:delete_experience' cv.id e.id %}" 
                   class="cv-btn-delete"
                   onclick="return confirm('Supprimer cette exp√©rience ?')"
                   aria-label="Supprimer cette exp√©rience">
                  üóëÔ∏è Supprimer
                </a>
              </div>

              <!-- Container pour r√©sultat IA -->
              <div class="cv-ai-result" role="status" aria-live="polite"></div>

            </li>
          {% endfor %}
        </ul>
      </section>

      <hr class="cv-divider">
    {% endif %}

    <!-- ================= FORMULAIRE AJOUT NOUVELLE EXP√âRIENCE ================= -->
    <section class="cv-form-section">
      <h2 class="cv-section-title">
        {% if experiences %}
          ‚ûï Ajouter une nouvelle exp√©rience
        {% else %}
          üìã Ajouter votre premi√®re exp√©rience professionnelle
        {% endif %}
      </h2>

      <aside class="cv-alert info" role="complementary">
        <p>
          üí° <strong>Ajoutez vos exp√©riences professionnelles</strong> une par une.
          Notre <strong>IA sp√©cialis√©e Canada</strong> pourra ensuite les reformuler
          au <strong>format ATS-friendly</strong>.
        </p>
      </aside>

      <form method="post" 
            action="{% url 'cv_generator:create_cv_step2' cv.id %}"
            class="cv-step-form"
            novalidate>
        
        {% csrf_token %}

        <div class="form-group">
          <label for="id_title" class="required">
            Poste occup√© / Titre du poste
          </label>
          <input type="text" 
                 id="id_title"
                 name="title" 
                 class="form-control"
                 required 
                 placeholder="Ex : Technicien de maintenance industrielle">
          <small class="cv-muted">
            Exemples : D√©veloppeur Full-Stack, Infirmier autoris√©, Ing√©nieur civil
          </small>
        </div>

        <div class="form-group">
          <label for="id_company" class="required">
            Nom de l'entreprise / Employeur
          </label>
          <input type="text" 
                 id="id_company"
                 name="company" 
                 class="form-control"
                 required 
                 placeholder="Ex : Bombardier Inc.">
        </div>

        <div class="cv-form-row">
          <div class="form-group">
            <label for="id_start_date" class="required">
              Date de d√©but
            </label>
            <input type="date" 
                   id="id_start_date"
                   name="start_date" 
                   class="form-control"
                   required>
          </div>

          <div class="form-group">
            <label for="id_end_date">
              Date de fin
            </label>
            <input type="date" 
                   id="id_end_date"
                   name="end_date" 
                   class="form-control">
            <small class="cv-muted">
              Laissez vide si <strong>poste actuel</strong>
            </small>
          </div>
        </div>

        <div class="form-group">
          <label for="id_description_raw" class="required">
            Description de vos missions et r√©alisations
          </label>
          <textarea
            id="id_description_raw"
            name="description_raw"
            class="form-control"
            rows="6"
            required
            placeholder="D√©crivez vos missions principales, responsabilit√©s et r√©alisations. Soyez pr√©cis et quantifiez si possible.

Exemple :
- Maintenance pr√©ventive et corrective sur 50+ machines industrielles
- R√©duction des temps d'arr√™t de 30% gr√¢ce √† un programme de maintenance optimis√©
- Formation de 5 nouveaux techniciens aux protocoles de s√©curit√©"></textarea>
          <small class="cv-muted">
            <strong>üí° Astuce :</strong> Incluez des <strong>chiffres</strong> et des 
            <strong>verbes d'action</strong>. Notre IA les optimisera ensuite.
          </small>
        </div>

        <button type="submit" 
                class="cv-btn-primary">
          ‚ûï Ajouter cette exp√©rience
        </button>
      </form>
    </section>

    <!-- ================= NAVIGATION ================= -->
    <nav class="cv-step-actions">
      <a href="{% url 'cv_generator:create_cv' cv.id %}" 
         class="cv-btn-secondary">
        ‚¨ÖÔ∏è Retour √† l'√©tape 1
      </a>

      <a href="{% url 'cv_generator:create_cv_step3' cv.id %}"
         class="cv-btn-success">
        Continuer vers la finalisation ‚Üí
      </a>
    </nav>

  </section>
</main>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/cv_generator.js' %}"></script>
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function generateTasks(btn) {
  const url = btn.dataset.url;
  const container = btn.closest("li");
  const resultBox = container.querySelector(".cv-ai-result");

  const originalText = btn.innerText;
  btn.innerText = "‚è≥ Optimisation en cours...";
  btn.disabled = true;

  fetch(url, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie('csrftoken')
    }
  })
  .then(res => {
    if (!res.ok) throw new Error(`Erreur HTTP ${res.status}`);
    return res.json();
  })
  .then(data => {
    if (data.success && data.tasks) {
      resultBox.innerHTML = `
        <div class="cv-ai-box cv-ai-success" role="alert">
          <h4 class="cv-ai-title">‚úÖ <strong>Optimisation r√©ussie</strong></h4>
          <div class="cv-ai-content">${data.tasks.replace(/\n/g, '<br>')}</div>
          <p class="cv-ai-badge">üá®üá¶ Conforme standards ATS Canada</p>
        </div>
      `;
      
      setTimeout(() => window.location.reload(), 2000);
    } else {
      throw new Error(data.error || "R√©ponse invalide");
    }
  })
  .catch(err => {
    console.error("Erreur:", err);
    resultBox.innerHTML = `
      <div class="cv-alert error" role="alert">
        ‚ùå <strong>Erreur lors de l'optimisation.</strong> ${err.message}
      </div>
    `;
  })
  .finally(() => {
    btn.innerText = originalText;
    btn.disabled = false;
  });
}
</script>
{% endblock %}