{% load static %}
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Wizard √âligibilit√© ‚Äì √âtapes | Immigration97</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="index,follow">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <style>
    :root { --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --line:#334155; --txt:#e5e7eb; --cta:#16a34a; --cta2:#1d4ed8; }
    body { max-width: 980px; margin: 22px auto; font-family: system-ui, -apple-system, Segoe UI, Roboto; background: var(--bg); color: var(--txt); }
    .header{margin:6px 0 16px}
    .sub{color:var(--muted)}
    .card { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 18px; margin: 16px 0; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; }
    label{font-weight:700; display:block; margin:6px 0}
    input,select,textarea{width:100%; padding:11px 12px; border-radius:10px; border:1px solid var(--line); background:var(--bg); color:var(--txt)}
    .actions{display:flex; gap:10px; justify-content:space-between; margin-top:14px}
    .btn{border:0; border-radius:10px; padding:12px 16px; cursor:pointer}
    .btn-primary{background:var(--cta); color:#fff}
    .btn-secondary{background:var(--cta2); color:#fff}
    .btn-ghost{background:transparent; border:1px solid var(--line); color:var(--txt)}
    .muted{color:var(--muted)}
    .error{color:#fca5a5; margin-top:8px}
    .ok{color:#86efac; margin-top:8px}
    .progress{height:10px; background:#0b1220; border:1px solid var(--line); border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg, #22c55e, #16a34a)}
    .step-title{font-size:20px; margin-bottom:8px}
    .sep{height:1px; background:var(--line); margin:16px 0}
    .pill{font-size:12px; padding:3px 8px; border-radius:999px; border:1px solid var(--line); color:var(--muted)}
    @media (max-width:820px){ .grid, .grid-3{grid-template-columns:1fr} body{margin:12px} }
  </style>
</head>
<body>
  <header class="header">
    <h1>Assistant d‚Äô√©ligibilit√© ‚Äì 6 √©tapes</h1>
    <p class="sub">R√©pondez √©tape par √©tape. Nous sauvegardons automatiquement et calculons votre score √† la fin.</p>
    <div class="progress"><div id="bar" class="bar"></div></div>
    <div class="muted" style="margin-top:6px">√âtape <span id="stepNum">1</span> / 6</div>
  </header>

  <!-- Etape 1 : Profil -->
  <section class="card step" data-step="1">
    <div class="step-title">üë§ Profil</div>
    <div class="grid">
      <div>
        <label for="first_name">Pr√©nom</label>
        <input id="first_name" autocomplete="given-name" placeholder="Ex. Marc">
      </div>
      <div>
        <label for="last_name">Nom</label>
        <input id="last_name" autocomplete="family-name" placeholder="Ex. NGONO">
      </div>
      <div>
        <label for="email">Email</label>
        <input id="email" type="email" autocomplete="email" placeholder="nom@exemple.com">
      </div>
      <div>
        <label for="age">√Çge</label>
        <input id="age" type="number" min="16" max="65" value="25">
      </div>
      <div>
        <label for="origin_country">Pays de citoyennet√©</label>
        <input id="origin_country" placeholder="Ex. Cameroun">
      </div>
      <div>
        <label for="residence_country">Pays de r√©sidence</label>
        <input id="residence_country" placeholder="Ex. Cameroun">
      </div>
      <div>
        <label for="marital_status">√âtat matrimonial</label>
        <select id="marital_status">
          <option value="single">C√©libataire</option>
          <option value="married">Mari√©(e)</option>
          <option value="common_law">Union libre</option>
          <option value="divorced">Divorc√©(e)</option>
        </select>
      </div>
      <div>
        <label for="children_count">Enfants (nombre)</label>
        <input id="children_count" type="number" min="0" max="10" value="0">
      </div>
    </div>
    <div class="actions">
      <span></span>
      <button class="btn btn-secondary" data-next>Suivant</button>
    </div>
  </section>

  <!-- Etape 2 : Projet -->
  <section class="card step" data-step="2" hidden>
    <div class="step-title">üéØ Projet d‚Äôimmigration</div>
    <div class="grid">
      <div>
        <label for="target_country">Pays cible</label>
        <select id="target_country">
          <option>Canada</option><option>France</option><option>Allemagne</option>
          <option>Royaume-Uni</option><option>USA</option><option>Maroc</option>
        </select>
        <div class="muted">Nous adapterons les r√®gles et sources officielles.</div>
      </div>
      <div>
        <label for="project_type">Type de projet</label>
        <select id="project_type">
          <option value="study">√âtudes</option>
          <option value="work">Travail</option>
          <option value="pr">R√©sidence permanente</option>
          <option value="visit">Court s√©jour</option>
        </select>
      </div>
      <div>
        <label for="budget">Budget disponible (USD)</label>
        <input id="budget" type="number" min="0" step="100" value="15000">
        <div class="muted">üí° Sert √† filtrer des options r√©alistes (vous ne payez rien ici).</div>
      </div>
      <div>
        <label for="timeline">D√©lai souhait√©</label>
        <select id="timeline">
          <option value="0-3">0‚Äì3 mois</option>
          <option value="3-6">3‚Äì6 mois</option>
          <option value="6-12">6‚Äì12 mois</option>
          <option value="12+">12+ mois</option>
        </select>
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-ghost" data-prev>Retour</button>
      <button class="btn btn-secondary" data-next>Suivant</button>
    </div>
  </section>

  <!-- Etape 3 : √âducation -->
  <section class="card step" data-step="3" hidden>
    <div class="step-title">üéì √âducation</div>
    <div class="grid">
      <div>
        <label for="education_level">Dernier dipl√¥me</label>
        <select id="education_level">
          <option>Secondaire</option><option>Licence</option><option>Master</option><option>Doctorat</option>
        </select>
      </div>
      <div>
        <label for="education_field">Domaine d‚Äô√©tude</label>
        <input id="education_field" placeholder="Ex. Informatique">
      </div>
      <div>
        <label for="education_year">Ann√©e d‚Äôobtention</label>
        <input id="education_year" type="number" min="1980" max="2025" value="2022">
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-ghost" data-prev>Retour</button>
      <button class="btn btn-secondary" data-next>Suivant</button>
    </div>
  </section>

  <!-- Etape 4 : Exp√©rience -->
  <section class="card step" data-step="4" hidden>
    <div class="step-title">üíº Exp√©rience</div>
    <div class="grid">
      <div>
        <label for="job_title">Profession actuelle</label>
        <input id="job_title" placeholder="Ex. Ing√©nieur logiciel">
      </div>
      <div>
        <label for="exp_years">Ann√©es d‚Äôexp√©rience</label>
        <input id="exp_years" type="number" min="0" max="40" value="3">
      </div>
      <div>
        <label for="skills">Comp√©tences (s√©par√©es par virgules)</label>
        <input id="skills" placeholder="Python, Data, Gestion projet">
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-ghost" data-prev>Retour</button>
      <button class="btn btn-secondary" data-next>Suivant</button>
    </div>
  </section>

  <!-- Etape 5 : Langues -->
  <section class="card step" data-step="5" hidden>
    <div class="step-title">üó£Ô∏è Langues</div>
    <div class="grid-3">
      <div>
        <label for="ielts">IELTS (overall)</label>
        <input id="ielts" placeholder="6.5" value="6.5">
        <div class="muted">Mettre ‚Äú0‚Äù si non pass√©.</div>
      </div>
      <div>
        <label for="toefl">TOEFL</label>
        <input id="toefl" placeholder="0" value="0">
      </div>
      <div>
        <label for="tef">TEF (global)</label>
        <input id="tef" placeholder="B2 / 400" value="0">
      </div>
    </div>
    <div class="actions">
      <button class="btn btn-ghost" data-prev>Retour</button>
      <button class="btn btn-secondary" data-next>Suivant</button>
    </div>
  </section>

  <!-- Etape 6 : Documents & Confirmation -->
  <section class="card step" data-step="6" hidden>
    <div class="step-title">üßæ Documents & Confirmation</div>
    <div class="grid">
      <label><input type="checkbox" id="doc_passport"> Passeport valide</label>
      <label><input type="checkbox" id="doc_bank"> Relev√©s bancaires</label>
      <label><input type="checkbox" id="doc_work"> Attestation de travail</label>
      <label><input type="checkbox" id="doc_cv"> CV</label>
      <label><input type="checkbox" id="doc_reco"> Lettre de recommandation</label>
      <label><input type="checkbox" id="doc_diplomas"> Dipl√¥mes / relev√©s de notes</label>
    </div>
    <div class="sep"></div>
    <label style="display:flex; gap:8px; align-items:center">
      <input type="checkbox" id="consent" checked> J‚Äôaccepte d‚Äô√™tre recontact√© pour recevoir mon plan et des opportunit√©s pertinentes.
    </label>
    <div class="actions">
      <button class="btn btn-ghost" data-prev>Retour</button>
      <button class="btn btn-primary" id="finishBtn">Terminer & Voir mes r√©sultats</button>
    </div>
    <div id="msg" class="muted" style="margin-top:8px">Sauvegarde automatique activ√©e.</div>
    <div id="formError" class="error" hidden></div>
  </section>

  <script>
    // ==== Helpers ====
    function getCookie(name){
      const v = `; ${document.cookie}`; const p = v.split(`; ${name}=`);
      if(p.length===2) return p.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');
    const STEPS = 6;
    const $ = (id)=>document.getElementById(id);

    function parseFloatSafe(x){ if(typeof x!=="string") return Number(x||0); return Number(x.replace(",", ".")||0); }
    function yes(b){ return b ? true : false; }
    function setProgress(i){ const pct = Math.round((i-1)/(STEPS-1)*100); $("bar").style.width = pct+"%"; $("stepNum").textContent = i; }
    function showStep(i){
      document.querySelectorAll(".step").forEach(sec => sec.hidden = (Number(sec.dataset.step)!==i));
      setProgress(i);
      localStorage.setItem("wiz_step", String(i));
    }

    async function post(url, data){
      const r = await fetch(url,{ method:"POST", headers:{ "Content-Type":"application/json", "X-CSRFToken": csrftoken }, body: JSON.stringify(data||{}) });
      if(!r.ok){ throw new Error(await r.text()); }
      return r.json();
    }

    function sessionId(){
      return Number(localStorage.getItem("wiz_session_id")||0);
    }

    async function ensureSession(){
      if(sessionId()>0) return sessionId();
      const s = await post("/api/eligibility/sessions/", { locale:"fr" });
      localStorage.setItem("wiz_session_id", String(s.id));
      return s.id;
    }

    function collectCommon(){
      return {
        "profile.first_name": $("first_name").value.trim(),
        "profile.last_name": $("last_name").value.trim(),
        "contact.email": $("email").value.trim(),
        "age": Number($("age").value||0),
        "origin_country": $("origin_country").value.trim(),
        "residence_country": $("residence_country").value.trim(),
        "marital.status": $("marital_status").value,
        "children.count": Number($("children_count").value||0),

        "target_country": $("target_country").value,
        "project.type": $("project_type").value,
        "budget.usd": Number($("budget").value||0),
        "timeline.pref": $("timeline").value,

        "education.level": $("education_level").value,
        "education.field": $("education_field").value.trim(),
        "education.year": Number($("education_year").value||0),

        "job.title": $("job_title").value.trim(),
        "experience.years": Number($("exp_years").value||0),
        "skills": $("skills").value.split(",").map(s=>s.trim()).filter(Boolean),

        "language.ielts.overall": parseFloatSafe($("ielts").value),
        "language.toefl.score": parseFloatSafe($("toefl").value),
        "language.tef.global": $("tef").value.trim(),

        "docs.passport": yes($("doc_passport").checked),
        "docs.bank": yes($("doc_bank").checked),
        "docs.work_attestation": yes($("doc_work").checked),
        "docs.cv": yes($("doc_cv").checked),
        "docs.recommendation": yes($("doc_reco").checked),
        "docs.diplomas": yes($("doc_diplomas").checked),

        "consent.contact": yes($("consent").checked)
      };
    }

    async function saveStep(i){
      const sid = await ensureSession();
      const payload = {};
      // On envoie seulement le sous-ensemble utile par √©tape pour limiter la charge
      if(i===1){
        Object.assign(payload, {
          "profile.first_name": $("first_name").value.trim(),
          "profile.last_name": $("last_name").value.trim(),
          "contact.email": $("email").value.trim(),
          "age": Number($("age").value||0),
          "origin_country": $("origin_country").value.trim(),
          "residence_country": $("residence_country").value.trim(),
          "marital.status": $("marital_status").value,
          "children.count": Number($("children_count").value||0)
        });
      } else if(i===2){
        Object.assign(payload, {
          "target_country": $("target_country").value,
          "project.type": $("project_type").value,
          "budget.usd": Number($("budget").value||0),
          "timeline.pref": $("timeline").value
        });
      } else if(i===3){
        Object.assign(payload, {
          "education.level": $("education_level").value,
          "education.field": $("education_field").value.trim(),
          "education.year": Number($("education_year").value||0)
        });
      } else if(i===4){
        Object.assign(payload, {
          "job.title": $("job_title").value.trim(),
          "experience.years": Number($("exp_years").value||0),
          "skills": $("skills").value.split(",").map(s=>s.trim()).filter(Boolean)
        });
      } else if(i===5){
        Object.assign(payload, {
          "language.ielts.overall": parseFloatSafe($("ielts").value),
          "language.toefl.score": parseFloatSafe($("toefl").value),
          "language.tef.global": $("tef").value.trim()
        });
      } else if(i===6){
        Object.assign(payload, {
          "docs.passport": yes($("doc_passport").checked),
          "docs.bank": yes($("doc_bank").checked),
          "docs.work_attestation": yes($("doc_work").checked),
          "docs.cv": yes($("doc_cv").checked),
          "docs.recommendation": yes($("doc_reco").checked),
          "docs.diplomas": yes($("doc_diplomas").checked),
          "consent.contact": yes($("consent").checked)
        });
      }
      // API answers (patch cumulatif)
      await post(`/api/eligibility/sessions/${sid}/answers/`, payload);
    }

    async function finish(){
      const sid = await ensureSession();
      // Derni√®re sauvegarde compl√®te par s√©curit√©
      await post(`/api/eligibility/sessions/${sid}/answers/`, collectCommon());
      // Score (pays cible pris comme filtre)
      const country = $("target_country").value || undefined;
      await post(`/api/eligibility/sessions/${sid}/score/`, country ? { country } : {});
      // Redirection
      window.location.href = `/wizard/result/${sid}/`;
    }

    // ==== Navigation ====
    function goNext(){
      const i = Number(localStorage.getItem("wiz_step")||"1");
      const next = Math.min(STEPS, i+1);
      showStep(next);
    }
    function goPrev(){
      const i = Number(localStorage.getItem("wiz_step")||"1");
      const prev = Math.max(1, i-1);
      showStep(prev);
    }

    // Boutons Next/Prev/Finish
    document.querySelectorAll("[data-next]").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        e.preventDefault();
        const i = Number(localStorage.getItem("wiz_step")||"1");
        try{ await saveStep(i); goNext(); }catch(err){ alert("Erreur de sauvegarde : "+(err.message||"r√©seau")); }
      });
    });
    document.querySelectorAll("[data-prev]").forEach(btn=>{
      btn.addEventListener("click", (e)=>{ e.preventDefault(); goPrev(); });
    });
    $("finishBtn").addEventListener("click", async (e)=>{
      e.preventDefault();
      $("formError").hidden = true;
      try{ await saveStep(6); await finish(); }
      catch(err){ $("formError").hidden = false; $("formError").textContent = "Erreur : "+(err.message||"r√©seau/serveur"); }
    });

    // ==== Restore state ====
    function restore(){
      const s = Number(localStorage.getItem("wiz_step")||"1");
      showStep(s);
      // (Option) on pourrait aussi restaurer les champs depuis localStorage
    }

    // ==== Boot ====
    (async function init(){
      try{
        // cr√©e la session si besoin, mais silencieusement
        await ensureSession();
      }catch(e){ console.warn("Session non cr√©√©e pour l‚Äôinstant :", e); }
      restore();
    })();

    // Truc utile : pour repartir de z√©ro si tu veux r√©initialiser
    // localStorage.removeItem("wiz_session_id"); localStorage.removeItem("wiz_step");
  </script>
</body>
</html>
