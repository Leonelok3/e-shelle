{% load static %}
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Wizard √âligibilit√© ‚Äì √âtapes | Immigration97</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="index,follow">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">

  <style>
    :root{
      --bg:#070c16;
      --card: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.10);
      --txt: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.70);
      --green:#10b981;
      --green2:#059669;
      --blue:#3b82f6;
      --shadow: 0 24px 80px rgba(0,0,0,.55);
      --r: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(ellipse 80% 50% at 50% 0%, rgba(16,185,129,.14), transparent 70%), var(--bg);
      color: var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{max-width: 1100px; margin: 24px auto; padding: 0 16px;}
    .header{
      background: linear-gradient(135deg, rgba(16,185,129,.14) 0%, rgba(59,130,246,.08) 40%, rgba(255,255,255,.03) 100%);
      border: 1px solid var(--line);
      border-radius: 22px;
      padding: 20px;
      box-shadow: var(--shadow);
      position: relative;
      overflow:hidden;
    }
    .header:before{
      content:"";
      position:absolute; inset:-50%;
      background: radial-gradient(circle, rgba(16,185,129,.18) 0%, transparent 55%);
      filter: blur(12px);
      pointer-events:none;
    }
    .header-inner{position:relative; z-index:1;}
    h1{margin:0 0 6px; font-size: clamp(26px, 3vw, 40px); font-weight: 950; letter-spacing:-.02em;}
    .sub{margin:0; color: var(--muted); line-height: 1.6;}
    .progress{
      margin-top: 14px;
      height: 10px;
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, #22c55e, #16a34a);
    }
    .stepLine{margin-top:8px; color: var(--muted); font-size: 13px;}
    .card{
      margin-top: 14px;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--line);
      border-radius: var(--r);
      padding: 16px;
    }
    .step-title{font-size: 18px; font-weight: 950; margin-bottom: 10px;}
    .grid{display:grid; grid-template-columns: 1fr 1fr; gap: 12px;}
    .grid-3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;}
    @media (max-width: 860px){ .grid,.grid-3{grid-template-columns:1fr;} }

    label{font-weight: 850; display:block; margin: 6px 0; color: rgba(255,255,255,.88);}
    input,select,textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      outline:none;
    }
    input:focus,select:focus,textarea:focus{
      border-color: rgba(16,185,129,.45);
      box-shadow: 0 0 0 4px rgba(16,185,129,.18);
    }

    .actions{display:flex; justify-content:space-between; gap: 10px; margin-top: 14px; flex-wrap:wrap;}
    .btn{
      border: 0;
      border-radius: 999px;
      padding: 12px 18px;
      font-weight: 950;
      letter-spacing: .01em;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap: 10px;
      transition: transform .18s ease, box-shadow .18s ease, background .18s ease, border-color .18s ease;
      will-change: transform;
      user-select:none;
    }
    .btn-primary{
      background: linear-gradient(135deg, var(--green) 0%, var(--green2) 100%);
      color:#fff;
      border: 1px solid rgba(16,185,129,.40);
      box-shadow: 0 18px 55px rgba(16,185,129,.28);
    }
    .btn-primary:hover{transform: translateY(-2px); box-shadow: 0 24px 70px rgba(16,185,129,.40);}
    .btn-secondary{
      background: linear-gradient(135deg, rgba(59,130,246,1) 0%, rgba(29,78,216,1) 100%);
      color:#fff;
      border: 1px solid rgba(59,130,246,.45);
      box-shadow: 0 18px 55px rgba(59,130,246,.24);
    }
    .btn-secondary:hover{transform: translateY(-2px); box-shadow: 0 24px 70px rgba(59,130,246,.34);}
    .btn-ghost{
      background: rgba(255,255,255,.02);
      color: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 44px rgba(0,0,0,.28);
    }
    .btn-ghost:hover{transform: translateY(-2px); border-color: rgba(16,185,129,.30); background: rgba(255,255,255,.06);}

    .muted{color: var(--muted); font-size: 13px; line-height: 1.6;}
    .sep{height:1px; background: rgba(255,255,255,.10); margin: 14px 0;}
    .error{
      margin-top: 10px;
      background: rgba(251,113,133,.10);
      border: 1px solid rgba(251,113,133,.25);
      color: rgba(255,255,255,.90);
      padding: 10px 12px;
      border-radius: 14px;
      display:none;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .ok{color: rgba(134,239,172,.95); font-weight: 800;}
  </style>
</head>

<body>
  <div class="wrap">
    <header class="header">
      <div class="header-inner">
        <h1>Assistant d‚Äô√©ligibilit√© ‚Äì 6 √©tapes</h1>
        <p class="sub">R√©pondez √©tape par √©tape. Sauvegarde automatique + calcul final.</p>
        <div class="progress"><div id="bar" class="bar"></div></div>
        <div class="stepLine">√âtape <span id="stepNum">1</span> / 6 ‚Ä¢ <span class="ok">Autosave activ√©</span></div>
        <div id="topError" class="error"></div>
      </div>
    </header>

    <!-- Etape 1 -->
    <section class="card step" data-step="1">
      <div class="step-title">üë§ Profil</div>
      <div class="grid">
        <div><label for="first_name">Pr√©nom</label><input id="first_name" autocomplete="given-name" placeholder="Ex. Marc"></div>
        <div><label for="last_name">Nom</label><input id="last_name" autocomplete="family-name" placeholder="Ex. NGONO"></div>
        <div><label for="email">Email</label><input id="email" type="email" autocomplete="email" placeholder="nom@exemple.com"></div>
        <div><label for="age">√Çge</label><input id="age" type="number" min="16" max="65" value="25"></div>
        <div><label for="origin_country">Pays de citoyennet√©</label><input id="origin_country" placeholder="Ex. Cameroun"></div>
        <div><label for="residence_country">Pays de r√©sidence</label><input id="residence_country" placeholder="Ex. Cameroun"></div>
        <div>
          <label for="marital_status">√âtat matrimonial</label>
          <select id="marital_status">
            <option value="single">C√©libataire</option>
            <option value="married">Mari√©(e)</option>
            <option value="common_law">Union libre</option>
            <option value="divorced">Divorc√©(e)</option>
          </select>
        </div>
        <div><label for="children_count">Enfants (nombre)</label><input id="children_count" type="number" min="0" max="10" value="0"></div>
      </div>
      <div class="actions">
        <a class="btn btn-ghost" href="/wizard/">‚¨Ö Retour</a>
        <button class="btn btn-secondary" data-next>Suivant ‚ûú</button>
      </div>
    </section>

    <!-- Etape 2 -->
    <section class="card step" data-step="2" hidden>
      <div class="step-title">üéØ Projet d‚Äôimmigration</div>
      <div class="grid">
        <div>
          <label for="target_country">Pays cible</label>
          <select id="target_country">
            <option>Canada</option><option>France</option><option>Allemagne</option>
            <option>Royaume-Uni</option><option>USA</option><option>Maroc</option>
          </select>
          <div class="muted">Nous adaptons les r√®gles et sources officielles.</div>
        </div>
        <div>
          <label for="project_type">Type de projet</label>
          <select id="project_type">
            <option value="study">√âtudes</option>
            <option value="work">Travail</option>
            <option value="pr">R√©sidence permanente</option>
            <option value="visit">Court s√©jour</option>
          </select>
        </div>
        <div>
          <label for="budget">Budget disponible (USD)</label>
          <input id="budget" type="number" min="0" step="100" value="15000">
          <div class="muted">Sert √† filtrer des options r√©alistes.</div>
        </div>
        <div>
          <label for="timeline">D√©lai souhait√©</label>
          <select id="timeline">
            <option value="0-3">0‚Äì3 mois</option>
            <option value="3-6">3‚Äì6 mois</option>
            <option value="6-12">6‚Äì12 mois</option>
            <option value="12+">12+ mois</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button class="btn btn-ghost" data-prev>‚¨Ö Retour</button>
        <button class="btn btn-secondary" data-next>Suivant ‚ûú</button>
      </div>
    </section>

    <!-- Etape 3 -->
    <section class="card step" data-step="3" hidden>
      <div class="step-title">üéì √âducation</div>
      <div class="grid">
        <div>
          <label for="education_level">Dernier dipl√¥me</label>
          <select id="education_level">
            <option>Secondaire</option><option>Licence</option><option>Master</option><option>Doctorat</option>
          </select>
        </div>
        <div><label for="education_field">Domaine d‚Äô√©tude</label><input id="education_field" placeholder="Ex. Informatique"></div>
        <div><label for="education_year">Ann√©e d‚Äôobtention</label><input id="education_year" type="number" min="1980" max="2026" value="2022"></div>
      </div>
      <div class="actions">
        <button class="btn btn-ghost" data-prev>‚¨Ö Retour</button>
        <button class="btn btn-secondary" data-next>Suivant ‚ûú</button>
      </div>
    </section>

    <!-- Etape 4 -->
    <section class="card step" data-step="4" hidden>
      <div class="step-title">üíº Exp√©rience</div>
      <div class="grid">
        <div><label for="job_title">Profession actuelle</label><input id="job_title" placeholder="Ex. Ing√©nieur logiciel"></div>
        <div><label for="exp_years">Ann√©es d‚Äôexp√©rience</label><input id="exp_years" type="number" min="0" max="40" value="3"></div>
        <div style="grid-column:1/-1"><label for="skills">Comp√©tences (s√©par√©es par virgules)</label><input id="skills" placeholder="Python, Data, Gestion projet"></div>
      </div>
      <div class="actions">
        <button class="btn btn-ghost" data-prev>‚¨Ö Retour</button>
        <button class="btn btn-secondary" data-next>Suivant ‚ûú</button>
      </div>
    </section>

    <!-- Etape 5 -->
    <section class="card step" data-step="5" hidden>
      <div class="step-title">üó£Ô∏è Langues</div>
      <div class="grid-3">
        <div>
          <label for="ielts">IELTS (overall)</label>
          <input id="ielts" placeholder="6.5" value="6.5">
          <div class="muted">Mettre ‚Äú0‚Äù si non pass√©.</div>
        </div>
        <div><label for="toefl">TOEFL</label><input id="toefl" placeholder="0" value="0"></div>
        <div><label for="tef">TEF (global)</label><input id="tef" placeholder="B2 / 400" value="0"></div>
      </div>
      <div class="actions">
        <button class="btn btn-ghost" data-prev>‚¨Ö Retour</button>
        <button class="btn btn-secondary" data-next>Suivant ‚ûú</button>
      </div>
    </section>

    <!-- Etape 6 -->
    <section class="card step" data-step="6" hidden>
      <div class="step-title">üßæ Documents & Confirmation</div>
      <div class="grid">
        <label><input type="checkbox" id="doc_passport"> Passeport valide</label>
        <label><input type="checkbox" id="doc_bank"> Relev√©s bancaires</label>
        <label><input type="checkbox" id="doc_work"> Attestation de travail</label>
        <label><input type="checkbox" id="doc_cv"> CV</label>
        <label><input type="checkbox" id="doc_reco"> Lettre de recommandation</label>
        <label><input type="checkbox" id="doc_diplomas"> Dipl√¥mes / relev√©s de notes</label>
      </div>

      <div class="sep"></div>

      <label style="display:flex; gap:10px; align-items:center; font-weight:850">
        <input type="checkbox" id="consent" checked>
        J‚Äôaccepte d‚Äô√™tre recontact√© pour recevoir mon plan et des opportunit√©s pertinentes.
      </label>

      <div class="actions">
        <button class="btn btn-ghost" data-prev>‚¨Ö Retour</button>
        <button class="btn btn-primary" id="finishBtn">Terminer & Voir mes r√©sultats ‚úÖ</button>
      </div>

      <div class="muted" style="margin-top:10px">Sauvegarde automatique activ√©e.</div>
      <div id="formError" class="error"></div>
    </section>
  </div>

  <script>
    // ===== CSRF helper =====
    function getCookie(name){
      const v = `; ${document.cookie}`;
      const p = v.split(`; ${name}=`);
      if(p.length===2) return p.pop().split(';').shift();
    }
    const csrftoken = getCookie('csrftoken');

    const STEPS = 6;
    const $ = (id)=>document.getElementById(id);

    function parseFloatSafe(x){
      if(typeof x !== "string") return Number(x||0);
      return Number(x.replace(",", ".") || 0);
    }
    function yes(b){ return b ? true : false; }

    function safeText(t){
      if(!t) return "";
      return String(t).slice(0, 900).replace(/<[^>]*>/g, "").trim();
    }

    function setProgress(i){
      const pct = Math.round((i-1)/(STEPS-1)*100);
      $("bar").style.width = pct + "%";
      $("stepNum").textContent = i;
    }
    function showStep(i){
      document.querySelectorAll(".step").forEach(sec => {
        sec.hidden = (Number(sec.dataset.step) !== i);
      });
      setProgress(i);
      localStorage.setItem("wiz_step", String(i));
    }

    async function post(url, data){
      const r = await fetch(url, {
        method:"POST",
        credentials: "same-origin",
        headers:{
          "Content-Type":"application/json",
          "X-CSRFToken": csrftoken
        },
        body: JSON.stringify(data || {})
      });

      const ct = (r.headers.get("content-type")||"").toLowerCase();

      if(!r.ok){
        if(ct.includes("application/json")){
          let j = {};
          try{ j = await r.json(); }catch(e){}
          throw new Error(j.detail || JSON.stringify(j) || `HTTP ${r.status}`);
        }
        const t = await r.text();
        throw new Error(safeText(t) || `HTTP ${r.status}`);
      }

      if(ct.includes("application/json")){
        return r.json();
      }
      const t = await r.text();
      throw new Error("R√©ponse inattendue (non JSON). " + safeText(t));
    }

    function sessionId(){
      return Number(localStorage.getItem("wiz_session_id") || 0);
    }

    async function ensureSession(){
      if(sessionId() > 0) return sessionId();

      // ‚úÖ FIX FINAL: endpoint correct
      const s = await post("/api/eligibility/sessions/create/", { locale:"fr", source:"wizard" });

      localStorage.setItem("wiz_session_id", String(s.id));
      return s.id;
    }

    function collectCommon(){
      return {
        "profile.first_name": $("first_name").value.trim(),
        "profile.last_name": $("last_name").value.trim(),
        "contact.email": $("email").value.trim(),
        "age": Number($("age").value||0),
        "origin_country": $("origin_country").value.trim(),
        "residence_country": $("residence_country").value.trim(),
        "marital.status": $("marital_status").value,
        "children.count": Number($("children_count").value||0),

        "target_country": $("target_country").value,
        "project.type": $("project_type").value,
        "budget.usd": Number($("budget").value||0),
        "timeline.pref": $("timeline").value,

        "education.level": $("education_level").value,
        "education.field": $("education_field").value.trim(),
        "education.year": Number($("education_year").value||0),

        "job.title": $("job_title").value.trim(),
        "experience.years": Number($("exp_years").value||0),
        "skills": $("skills").value.split(",").map(s=>s.trim()).filter(Boolean),

        "language.ielts.overall": parseFloatSafe($("ielts").value),
        "language.toefl.score": parseFloatSafe($("toefl").value),
        "language.tef.global": $("tef").value.trim(),

        "docs.passport": yes($("doc_passport").checked),
        "docs.bank": yes($("doc_bank").checked),
        "docs.work_attestation": yes($("doc_work").checked),
        "docs.cv": yes($("doc_cv").checked),
        "docs.recommendation": yes($("doc_reco").checked),
        "docs.diplomas": yes($("doc_diplomas").checked),

        "consent.contact": yes($("consent").checked)
      };
    }

    async function saveStep(i){
      const sid = await ensureSession();
      const payload = {};
      const c = collectCommon();

      if(i === 1){
        ["profile.first_name","profile.last_name","contact.email","age","origin_country","residence_country","marital.status","children.count"]
          .forEach(k => payload[k] = c[k]);
      } else if(i === 2){
        ["target_country","project.type","budget.usd","timeline.pref"]
          .forEach(k => payload[k] = c[k]);
      } else if(i === 3){
        ["education.level","education.field","education.year"]
          .forEach(k => payload[k] = c[k]);
      } else if(i === 4){
        ["job.title","experience.years","skills"]
          .forEach(k => payload[k] = c[k]);
      } else if(i === 5){
        ["language.ielts.overall","language.toefl.score","language.tef.global"]
          .forEach(k => payload[k] = c[k]);
      } else if(i === 6){
        ["docs.passport","docs.bank","docs.work_attestation","docs.cv","docs.recommendation","docs.diplomas","consent.contact"]
          .forEach(k => payload[k] = c[k]);
      }

      await post(`/api/eligibility/sessions/${sid}/answers/`, payload);
    }

    async function finish(){
      const sid = await ensureSession();
      await post(`/api/eligibility/sessions/${sid}/answers/`, collectCommon());

      const country = $("target_country").value || undefined;

      // ‚úÖ FIX FINAL: endpoint correct
      await post(`/api/eligibility/sessions/${sid}/compute_score/`, country ? { country } : {});

      window.location.href = `/wizard/result/${sid}/`;
    }

    function goNext(){
      const i = Number(localStorage.getItem("wiz_step") || "1");
      showStep(Math.min(STEPS, i+1));
    }
    function goPrev(){
      const i = Number(localStorage.getItem("wiz_step") || "1");
      showStep(Math.max(1, i-1));
    }

    function showTopError(msg){
      const box = $("topError");
      box.style.display = "block";
      box.textContent = "Erreur : " + (msg || "inconnue");
    }

    document.querySelectorAll("[data-next]").forEach(btn=>{
      btn.addEventListener("click", async (e)=>{
        e.preventDefault();
        const i = Number(localStorage.getItem("wiz_step") || "1");
        try{
          await saveStep(i);
          goNext();
        }catch(err){
          showTopError(err && err.message ? err.message : "sauvegarde impossible");
        }
      });
    });

    document.querySelectorAll("[data-prev]").forEach(btn=>{
      btn.addEventListener("click", (e)=>{ e.preventDefault(); goPrev(); });
    });

    $("finishBtn").addEventListener("click", async (e)=>{
      e.preventDefault();
      $("formError").style.display = "none";
      try{
        await saveStep(6);
        await finish();
      }catch(err){
        $("formError").style.display = "block";
        $("formError").textContent = "Erreur : " + (err && err.message ? err.message : "r√©seau/serveur");
      }
    });

    (async function init(){
      const s = Number(localStorage.getItem("wiz_step") || "1");
      showStep(s);

      // üí• Important: repartir propre
      // (tu peux commenter si tu veux garder une session)
      // localStorage.removeItem("wiz_session_id");

      try{
        await ensureSession();
      }catch(err){
        showTopError(err && err.message ? err.message : "impossible de cr√©er la session");
      }
    })();
  </script>
</body>
</html>
