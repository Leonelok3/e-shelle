{% extends 'base.html' %}
{% load static %}

{% block title %}Lettre #{{ letter.pk }} — Détails | Immigration97{% endblock %}

{% block meta_description %}
Consultez et téléchargez votre lettre de motivation générée par IA. Score ATS, export PDF et métadonnées complètes.
{% endblock %}

{% block body_class %}motivation-letter{% endblock %}
{% block app_scope %}motivation-letter detail-flow{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/MotivationLetterApp.css' %}">
{% endblock %}

{% block content %}

<!-- Hero Section -->
<div class="ml-detail-hero">
  <div class="ml-detail-hero__back">
    <a href="{% url 'motivation_letter:letter_list' %}" class="ml-detail-hero__back-link">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      <span>Retour à mes lettres</span>
    </a>
  </div>

  <h1 class="ml-detail-hero__title">
    Lettre de Motivation
  </h1>

  <p class="ml-detail-hero__subtitle">
    Consultez, téléchargez ou copiez le contenu de votre lettre professionnelle.
  </p>
</div>

<!-- Main Grid -->
<div class="ml-detail-grid">
  
  <!-- Letter Content -->
  <section class="ml-detail-content">
    <div class="ml-detail-card">
      
      <!-- Card Header -->
      <div class="ml-detail-card__header">
        <div class="ml-detail-card__icon">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
            <line x1="16" y1="13" x2="8" y2="13"/>
            <line x1="16" y1="17" x2="8" y2="17"/>
            <polyline points="10 9 9 9 8 9"/>
          </svg>
        </div>
        <h2 class="ml-detail-card__title">Contenu de la Lettre</h2>
      </div>

      <!-- Letter Preview -->
      <div class="ml-detail-preview">
        {{ letter.content|linebreaksbr }}
      </div>

      <!-- Actions -->
      <div class="ml-detail-actions">
        
        <!-- Download PDF Form -->
        <form method="post" action="{% url 'motivation_letter:download_pdf' %}" class="ml-detail-actions__form">
          {% csrf_token %}
          <input type="hidden" name="letter" value="{{ letter.content|escape }}">
          <input type="hidden" name="filename" value="Lettre_{{ letter.full_name|slugify }}_{{ letter.pk }}.pdf">
          <button type="submit" class="ml-detail-actions__btn ml-detail-actions__btn--primary">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
              <polyline points="7 10 12 15 17 10"/>
              <line x1="12" y1="15" x2="12" y2="3"/>
            </svg>
            <span>Télécharger PDF</span>
          </button>
        </form>

        <!-- Copy Button -->
        <button type="button" class="ml-detail-actions__btn ml-detail-actions__btn--secondary" onclick="copyToClipboard()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
          </svg>
          <span>Copier le texte</span>
        </button>

      </div>

    </div>
  </section>

  <!-- Sidebar Metadata -->
  <aside class="ml-detail-sidebar">
    
    <!-- Metadata Card -->
    <div class="ml-detail-card">
      <div class="ml-detail-card__header">
        <div class="ml-detail-card__icon ml-detail-card__icon--secondary">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 16v-4M12 8h.01"/>
          </svg>
        </div>
        <h2 class="ml-detail-card__title">Informations</h2>
      </div>

      <ul class="ml-detail-meta">
        <li class="ml-detail-meta__item">
          <span class="ml-detail-meta__label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
              <circle cx="12" cy="7" r="4"/>
            </svg>
            Nom complet
          </span>
          <span class="ml-detail-meta__value">{{ letter.full_name }}</span>
        </li>

        <li class="ml-detail-meta__item">
          <span class="ml-detail-meta__label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
            </svg>
            Poste visé
          </span>
          <span class="ml-detail-meta__value">{{ letter.target_role|default:"Non spécifié" }}</span>
        </li>

        <li class="ml-detail-meta__item">
          <span class="ml-detail-meta__label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
              <polyline points="9 22 9 12 15 12 15 22"/>
            </svg>
            Entreprise
          </span>
          <span class="ml-detail-meta__value">{{ letter.company|default:"Non spécifiée" }}</span>
        </li>

        <li class="ml-detail-meta__item">
          <span class="ml-detail-meta__label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <path d="M12 6v6l4 2"/>
            </svg>
            Langue
          </span>
          <span class="ml-detail-meta__value">{{ letter.get_language_display }}</span>
        </li>

        <li class="ml-detail-meta__item">
          <span class="ml-detail-meta__label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
            </svg>
            Ton utilisé
          </span>
          <span class="ml-detail-meta__value">{{ letter.get_tone_display }}</span>
        </li>

        <li class="ml-detail-meta__item">
          <span class="ml-detail-meta__label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
              <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            Score ATS
          </span>
          <span class="ml-detail-meta__value ml-detail-meta__value--score">{{ letter.ats_score }}%</span>
        </li>

        <li class="ml-detail-meta__item">
          <span class="ml-detail-meta__label">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            Date de création
          </span>
          <span class="ml-detail-meta__value">{{ letter.created_at|date:"d/m/Y à H:i" }}</span>
        </li>
      </ul>
    </div>

    <!-- New Letter CTA -->
    <div class="ml-detail-cta">
      <a href="{% url 'motivation_letter:generator' %}" class="ml-detail-cta__btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
          <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/>
        </svg>
        <span>Créer une nouvelle lettre</span>
      </a>
    </div>

  </aside>

</div>

<!-- Copy to Clipboard Script -->
<script>
function copyToClipboard() {
  const letterText = document.querySelector('.ml-detail-preview').innerText;
  
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(letterText).then(function() {
      alert('✅ Lettre copiée dans le presse-papiers !');
    }).catch(function(err) {
      console.error('Erreur lors de la copie:', err);
      fallbackCopy(letterText);
    });
  } else {
    fallbackCopy(letterText);
  }
}

function fallbackCopy(text) {
  const textarea = document.createElement('textarea');
  textarea.value = text;
  textarea.style.position = 'fixed';
  textarea.style.opacity = '0';
  document.body.appendChild(textarea);
  textarea.select();
  
  try {
    document.execCommand('copy');
    alert('✅ Lettre copiée dans le presse-papiers !');
  } catch (err) {
    alert('❌ Impossible de copier automatiquement. Veuillez copier manuellement.');
  }
  
  document.body.removeChild(textarea);
}
</script>

{% endblock %}